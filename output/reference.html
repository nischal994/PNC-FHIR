<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>Language Reference - FHIR Shorthand v3.0.0</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
  	<link href="assets/css/cqf.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
    <link href="assets/css/hl7.css" rel="stylesheet"/>
    <link href="assets/css/fhir-ig.css" rel="stylesheet"/>

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="fhir-logo" sizes="144x144" href="assets/ico/icon-fhir-144.png"/>
    <link rel="fhir-logo" sizes="114x114" href="assets/ico/icon-fhir-114.png"/>
    <link rel="fhir-logo" sizes="72x72" href="assets/ico/icon-fhir-72.png"/>
    <link rel="fhir-logo" href="assets/ico/icon-fhir-57.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>
    <script type="text/javascript" src="assets/js/mermaid.js"></script>
    <script type="text/javascript" src="assets/js/mermaid-init.js"></script>
    <style type="text/css">h2{--heading-prefix:"3"}
    h3,h4,h5,h6{--heading-prefix:"3"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->

        <!-- Placeholder for child template header declarations -->

        <div id="hl7-nav">
          <a id="hl7-logo" no-external="true" href="http://hl7.org">
            <img height="50" alt="Visit the HL7 website" src="assets/images/hl7-logo-header.png"/>
          </a>
        </div>
        <div id="family-nav">
          <a id="family-logo" no-external="true" href="http://hl7.org/fhir"><img height="50" alt="Visit the FHIR website" src="assets/images/fhir-logo-www.png"/> </a>
        </div>
        <div id="hl7-search">
          <a id="hl7-search-lnk" no-external="true" href="searchform.html"><img alt="Search FHIR" src="assets/images/search.png"/></a>
        </div>


        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">FHIR Shorthand</span>
            <br/>
            <span style="display:inline-block;">3.0.0 - 2nd Mixed Normative-Trial Use



  <img alt="International flag" src="assets/images/001.svg" height="16" title="International"/>


            </span>
          </p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li><a href="index.html">Home</a></li>
  <li><a href="overview.html">Overview</a></li>
  <li><a href="reference.html">Language Reference</a></li>
  <li><a href="FSHQuickReference.pdf">Quick Reference Card</a></li>
   <li><a href="change_log.html">Change Log</a></li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">More<b class="caret"> </b></a>
    <ul class="dropdown-menu">
      <li><a href="https://github.com/FHIR/sushi/tree/v3.8.0/antlr/src/main/antlr" target="_blank">FSH Grammar</a></li>
      <li><a href="full-ig.zip">Full Implementation Guide (zip file)</a></li>
    </ul>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><b>Language Reference</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">FHIR Shorthand - Local Development build (v3.0.0) built by the FHIR (HL7® FHIR® Standard) Build Tools. See the <a href="http://hl7.org/fhir/uv/shorthand/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->
  <h2>Language Reference</h2>
  












    <p><!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#notational-conventions" id="markdown-toc-notational-conventions">Notational Conventions</a></li>
  <li><a href="#fsh-projects" id="markdown-toc-fsh-projects">FSH Projects</a></li>
  <li><a href="#fsh-language-basics" id="markdown-toc-fsh-language-basics">FSH Language Basics</a></li>
  <li><a href="#fsh-paths" id="markdown-toc-fsh-paths">FSH Paths</a></li>
  <li><a href="#fsh-items" id="markdown-toc-fsh-items">FSH Items</a></li>
  <li><a href="#fsh-rules" id="markdown-toc-fsh-rules">FSH Rules</a></li>
  <li><a href="#appendix-abbreviations" id="markdown-toc-appendix-abbreviations">Appendix: Abbreviations</a></li>
  <li><a href="#appendix-fsh-grammar-informative" id="markdown-toc-appendix-fsh-grammar-informative">Appendix: FSH Grammar (informative)</a></li>
</ul>

</div>
<style>
    .shadeRow1 tr:nth-child(1) { background: #fff5e6; }
    .shadeRow6 tr:nth-child(6) { background: #fff5e6; }
    .shadeRow9 tr:nth-child(9) { background: #fff5e6; }
    .shadeRow10 tr:nth-child(10) { background: #fff5e6; }
    .shadeRow11 tr:nth-child(11) { background: #fff5e6; }
    .shadeRow12 tr:nth-child(12) { background: #fff5e6; }
    .shadeRow14 tr:nth-child(14) { background: #fff5e6; }
    .shadeRow15 tr:nth-child(15) { background: #fff5e6; }
    .shadeCol7 td:nth-child(7) { background: #fff5e6; }
    .shadeCol10 td:nth-child(10) { background: #fff5e6; }
    .shadeHead7 th:nth-child(7) { background: #fff5e6; }
    .shadeHead10 th:nth-child(10) { background: #fff5e6; }
    .unshadeHead th { background: white; }
    .optional { color: #CC3F00; }
    .caption { color: darkgreen; font-weight: bold; }
    .tuSpan { background-color: #fff5e6; }
    .tuBlock { padding-top: 5px; padding-left: 5px; padding-right: 10px; padding-bottom: 5px; background-color: #fff5e6; }
    .tuIcon { padding-left: 3px; padding-right: 3px; border: 1px grey solid; font-weight: bold; color: black; background-color: #fff5e6 }
    code {color: black; background: #F0F0F0;}
    h3 {margin-top: 24px;}
    h4 {margin-top: 18px;}
    h5 {margin-top: 12px;}
    p {line-height: 1.5}
</style>

<p><br />
<span style="background-color: LightYellow;">NOTE: Information on this page is normative content except where noted.</span>
<br /></p>

<p>This chapter contains the formal specification of the FHIR Shorthand (FSH) language. It is intended primarily as a reference, not a tutorial. For tutorials and additional documentation please consult the <a href="overview.html">Overview</a> or go to <a href="https://fshschool.org">fshschool.org</a>.</p>

<p>In this specification, the case-sensitive key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" are to be interpreted as described in <a href="https://tools.ietf.org/html/rfc2119">RFC2119</a>.</p>

<p>Portions of the specification designated as <a href="https://hl7.org/fhir/versions.html#std-process">Trial Use</a> are indicated by <span class="tuIcon" title="Standards Status = Trial Use">TU</span> and <span class="tuSpan">background shading</span>. All examples in the specification are informative content. Remaining unmarked sections contain normative content.</p>

<h3 id="notational-conventions">Notational Conventions</h3>

<p>The FSH specification uses syntax expressions to illustrate the FSH language. While FSH has a formal grammar (see <a href="#appendix-fsh-grammar-informative">Appendix: FSH Grammar</a>), most readers will find the syntax expressions more instructive.</p>

<p>Syntax expressions use the following conventions:</p>

<p><span class="caption" id="t1">Table 1. Syntax expressions</span></p>

<table class="grid">
  <thead>
    <tr>
      <th style="text-align: left">Style</th>
      <th style="text-align: left">Explanation</th>
      <th style="text-align: left">Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">this is FSH</code></td>
      <td style="text-align: left">Font used for FSH fragments, such as keywords, statements, and syntax expressions<sup>*</sup></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">* status = #open</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">{ }</code></td>
      <td style="text-align: left">Substitution: If a datatype, replace with a value; if an item, replace with a name, id, or URL</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">{decimal}</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">&lt; &gt;</code></td>
      <td style="text-align: left">Indicates an element or path to an element with the given datatype MUST be substituted</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">&lt;CodeableConcept&gt;</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><span class="optional">orange color</span></td>
      <td style="text-align: left">An OPTIONAL item in a syntax expression</td>
      <td style="text-align: left"><code><span class="optional">{flag}</span></code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">...</code></td>
      <td style="text-align: left">Indicates a pattern that MAY be repeated</td>
      <td style="text-align: left"><code>{flag1} {flag2} {flag3}&nbsp;...</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/</code></td>
      <td style="text-align: left">A choice of items</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Resource/Profile</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>bold</strong></td>
      <td style="text-align: left">A directory path or file name</td>
      <td style="text-align: left"><strong>example-1.fsh</strong></td>
    </tr>
  </tbody>
</table>

<p><sup>*</sup> NOTE: This specification also uses <code class="language-plaintext highlighter-rouge">code styling</code> for a selected set of non-FSH expressions, such as FHIR paths and element names (e.g., <code class="language-plaintext highlighter-rouge">Patient.name.given</code>, the Observation <code class="language-plaintext highlighter-rouge">value[x]</code> element).</p>

<p><strong>Syntax Expression Examples:</strong></p>

<ul>
  <li>
    <p>A FSH rule to assign the value of a Quantity:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;Quantity&gt; = {decimal or integer} '{UCUM unit}'
</code></pre></div>    </div>

    <p>A FSH statement following this pattern would be written as:</p>

    <ul>
      <li>An asterisk, followed by</li>
      <li>Any element of datatype Quantity or a path to an element with datatype Quantity, followed by</li>
      <li>An equals sign, followed by</li>
      <li>Any decimal or integer number, followed by</li>
      <li>Any Unified Code for Units of Measure (UCUM) unit, enclosed in single quotes.</li>
    </ul>
  </li>
  <li>
    <p>A rule to constrain an element to a certain datatype or types:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  * &lt;element&gt; only {datatype(s)}
</code></pre></div>    </div>

    <p>A FSH statement following this pattern would be written as:</p>

    <ul>
      <li>An asterisk, followed by</li>
      <li>Any element or a path to any element, followed by</li>
      <li>The word <code class="language-plaintext highlighter-rouge">only</code>, followed by</li>
      <li>A list including at least one valid datatype, with additional datatypes separated by the word <code class="language-plaintext highlighter-rouge">or</code> (see <a href="#t3">Table 3</a>).</li>
    </ul>
  </li>
</ul>

<p>The following tables contain additional examples of angle brackets and curly braces used in this IG:</p>

<p><span class="caption" id="t2">Table 2. Interpretation of paths in syntax expressions</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Syntax term</th>
      <th>Substitute…</th>
      <th>Example(s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;bindable&gt;</code></td>
      <td>An element or path to an element whose datatype allows it to be bound to a value set</td>
      <td><code class="language-plaintext highlighter-rouge">code</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;CodeableConcept&gt;</code></td>
      <td>An element or path to an element whose datatype is CodeableConcept</td>
      <td><code class="language-plaintext highlighter-rouge">category</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;element&gt;</code></td>
      <td>Any element or path to any element</td>
      <td><code class="language-plaintext highlighter-rouge">method.type</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;element(s)&gt;</code></td>
      <td>One or more elements or paths, separated by <code class="language-plaintext highlighter-rouge">and</code></td>
      <td><code class="language-plaintext highlighter-rouge">category and method and method.type</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">&lt;Extension&gt;</code></td>
      <td>An element or path to an element whose datatype is Extension</td>
      <td><code class="language-plaintext highlighter-rouge">extension</code> <br /> <code class="language-plaintext highlighter-rouge">modifierExtension</code> <br /> <code class="language-plaintext highlighter-rouge">bodySite.extension</code></td>
    </tr>
  </tbody>
</table>

<p><span class="caption" id="t3">Table 3. Interpretation of substitutions in syntax expressions</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Syntax term</th>
      <th>Substitute…</th>
      <th>Example(s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{card}</code></td>
      <td>A <a href="#cardinality-rules">cardinality expression</a></td>
      <td><code class="language-plaintext highlighter-rouge">0..1</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{code}</code></td>
      <td>A code</td>
      <td><code class="language-plaintext highlighter-rouge">#active</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{CodeSystem}</code></td>
      <td>The name, id, or URL of a code system</td>
      <td><code class="language-plaintext highlighter-rouge">http://terminology.hl7.org/CodeSystem/v2-0776</code> <br /> <code class="language-plaintext highlighter-rouge">v2-0776</code> // id <br /> <code class="language-plaintext highlighter-rouge">ItemStatus</code> // name</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{decimal}</code></td>
      <td>A decimal number, optionally including an exponent</td>
      <td><code class="language-plaintext highlighter-rouge">124.0</code> <br /> <code class="language-plaintext highlighter-rouge">58.3E-5</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{datatype}</code></td>
      <td>A <a href="https://hl7.org/fhir/R5/datatypes.html">FHIR datatype</a> or <a href="https://hl7.org/fhir/R5/resourcelist.html">FHIR resource type</a> defined in the project's FHIR version</td>
      <td><code class="language-plaintext highlighter-rouge">decimal</code> <br /> <code class="language-plaintext highlighter-rouge">ContactPoint</code><br /> <code class="language-plaintext highlighter-rouge">Reference(Patient)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{datatype(s)}</code></td>
      <td>One or more <a href="https://hl7.org/fhir/R5/datatypes.html">FHIR datatypes</a> or <a href="https://hl7.org/fhir/R5/resourcelist.html">FHIR resource types</a> defined in the project's FHIR version, separated by <code class="language-plaintext highlighter-rouge">or</code></td>
      <td><code class="language-plaintext highlighter-rouge">Quantity or CodeableConcept</code><br /><code class="language-plaintext highlighter-rouge">Reference(Patient or Practitioner)</code><br /><code class="language-plaintext highlighter-rouge">Canonical(ActivityDefinition)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{Extension}</code></td>
      <td>The name, id, or canonical URL (or alias) of an Extension</td>
      <td><code class="language-plaintext highlighter-rouge">duration</code> <br /> <code class="language-plaintext highlighter-rouge">allergyintolerance-duration</code> <br /> <code class="language-plaintext highlighter-rouge">http://hl7.org/fhir/StructureDefinition/allergyintolerance-duration</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{flag}</code></td>
      <td>One of the <a href="#flag-rules">FSH flags</a></td>
      <td><code class="language-plaintext highlighter-rouge">MS</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{flag(s)}</code></td>
      <td>One or more flags, separated by whitespace</td>
      <td><code class="language-plaintext highlighter-rouge">MS SU ?!</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{Invariant}</code></td>
      <td>The id of an Invariant</td>
      <td><code class="language-plaintext highlighter-rouge">us-core-6</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{Resource}</code></td>
      <td>The name, id, or canonical URL (or alias) of any Resource defined in the project's FHIR version</td>
      <td><code class="language-plaintext highlighter-rouge">Condition</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{Resource/Profile}</code></td>
      <td>The name, id, or canonical URL (or alias) of any Resource or Profile</td>
      <td><code class="language-plaintext highlighter-rouge">Condition</code> <br /> <code class="language-plaintext highlighter-rouge">http://hl7.org/fhir/us/core/StructureDefinition/us-core-location</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{RuleSet}</code></td>
      <td>The name of a RuleSet</td>
      <td><code class="language-plaintext highlighter-rouge">MyRuleSet</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{ValueSet}</code></td>
      <td>The name, id, or canonical URL (or alias) of a ValueSet</td>
      <td><code class="language-plaintext highlighter-rouge">http://hl7.org/fhir/ValueSet/address-type</code></td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>Note:</strong> When listing multiple items, consecutive elements and paths are always separated by <code class="language-plaintext highlighter-rouge">and</code>, consecutive flags are always separated by white spaces, and consecutive datatypes are always separated by <code class="language-plaintext highlighter-rouge">or</code>. When listing multiple References, the <code class="language-plaintext highlighter-rouge">or</code> is placed <em>inside</em> the Reference, e.g. <code class="language-plaintext highlighter-rouge">Reference(Patient or Practitioner)</code>, <strong>not</strong> <code class="language-plaintext highlighter-rouge">Reference(Patient) or Reference(Practitioner)</code></p>
</blockquote>

<h3 id="fsh-projects">FSH Projects</h3>

<p>A fundamental organizing construct is the FSH project, which defines the set of FSH items to be considered together. Typically, one FSH project equates to one FHIR Implementation Guide (IG). The parts of a FSH project are as follows:</p>

<h4 id="canonical-url">Canonical URL</h4>

<p>Each project MUST have an associated canonical URL, used for constructing canonical URLs for items created in the project. It is up to implementations to decide how this association is made.</p>

<h4 id="items">Items</h4>

<p>A FSH project SHALL contain one or more <a href="#fsh-items">FSH items</a> used to represent and create FHIR artifacts. FSH items can exist in various formats, for example, in text files, databases, or web forms. It is up to implementations to define the association between FSH items and FSH projects. The order of items, regardless of format, SHALL NOT affect the interpretation of those items.</p>

<p>Text files containing FSH items MUST use the <strong>.fsh</strong> extension. Items from all files in one project SHALL be considered globally pooled for the purposes of FSH. Changing the order of items within a <strong>.fsh</strong> file or moving FSH items between files SHALL NOT affect the interpretation of the content.</p>

<h4 id="fhir-version">FHIR Version</h4>

<p>Each FSH project MUST specify the version of FHIR it depends upon. It is up to implementations to decide how projects declare their FHIR version. Implementations MAY support only a specific version or versions of FHIR.</p>

<p>The FSH language specification has been designed around FHIR R4 and later. The core language constructs of FSH depend primarily on a small subset of normative definitions within the FHIR specification (e.g., StructureDefinition, ValueSet, CodeSystem, and datatypes). As a result, most differences in FHIR versions do not affect FSH features or syntax. FSH provides several points of flexibility, such as <a href="#fsh-paths">FSH paths</a>, to support authoring within the context of any FHIR version. Because the FSH specification refers to FHIR data types and definitional artifacts, however, there is no way to absolutely divorce FSH from specific FHIR versions.</p>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>FSH supports new FHIR R5 datatypes integer64 and CodeableReference on a trial use basis.</p>
</div>

<h4 id="external-igs">External IGs</h4>

<p>Dependencies between a FSH project and other IGs MUST be declared. The form of this declaration is outside the scope of the FSH language and SHOULD be managed by implementations. In this Guide, these are referred to as "external" IGs.</p>

<h4 id="other-project-contents">Other Project Contents</h4>

<p>Projects MAY contain other content involved in creating FHIR IGs, such as narrative text, pictures, and configuration information. This additional content is not defined in this specification, but MAY be specified by implementations.</p>

<h3 id="fsh-language-basics">FSH Language Basics</h3>

<h4 id="grammar">Grammar</h4>

<p>The grammar of FSH has been described using <a href="https://www.antlr.org/">ANTLR</a> (see <a href="#appendix-fsh-grammar-informative">Appendix: FSH Grammar</a>). The ANTLR grammar captures the syntax of FSH, but is not a complete specification of the language, since FSH defines the additional validation criteria for rules and items, and the behavior of rules in terms of FHIR artifacts.</p>

<p>If there is discrepancy between the grammar and the FSH language description, the language description takes precedence.</p>

<h4 id="reserved-words">Reserved Words</h4>

<p>FSH has a number of reserved words, symbols, and patterns. Reserved words and symbols with special meaning in FSH are: <code class="language-plaintext highlighter-rouge">contains</code>, <code class="language-plaintext highlighter-rouge">named</code>, <code class="language-plaintext highlighter-rouge">and</code>, <code class="language-plaintext highlighter-rouge">only</code>, <code class="language-plaintext highlighter-rouge">or</code>, <code class="language-plaintext highlighter-rouge">obeys</code>, <code class="language-plaintext highlighter-rouge">true</code>, <code class="language-plaintext highlighter-rouge">false</code>, <code class="language-plaintext highlighter-rouge">include</code>, <code class="language-plaintext highlighter-rouge">exclude</code>, <code class="language-plaintext highlighter-rouge">codes</code>, <code class="language-plaintext highlighter-rouge">where</code>, <code class="language-plaintext highlighter-rouge">valueset</code>, <code class="language-plaintext highlighter-rouge">system</code>, <code class="language-plaintext highlighter-rouge">from</code>, <code class="language-plaintext highlighter-rouge">insert</code>, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span><code class="language-plaintext highlighter-rouge">contentReference</code></span>, <code class="language-plaintext highlighter-rouge">!?</code>, <code class="language-plaintext highlighter-rouge">MS</code>, <code class="language-plaintext highlighter-rouge">SU</code>, <code class="language-plaintext highlighter-rouge">N</code>, <code class="language-plaintext highlighter-rouge">TU</code>, <code class="language-plaintext highlighter-rouge">D</code>, <code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">:</code>, <code class="language-plaintext highlighter-rouge">-&gt;</code>, <code class="language-plaintext highlighter-rouge">.</code>,<code class="language-plaintext highlighter-rouge">[</code>, <code class="language-plaintext highlighter-rouge">]</code>.</p>

<p>The following words are reserved, with or without white spaces prior to the colon: <code class="language-plaintext highlighter-rouge">Alias:</code>, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span><code class="language-plaintext highlighter-rouge">Characteristics:</code></span>, <code class="language-plaintext highlighter-rouge">CodeSystem:</code>, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span><code class="language-plaintext highlighter-rouge">Context:</code></span>, <code class="language-plaintext highlighter-rouge">Extension:</code>, <code class="language-plaintext highlighter-rouge">Instance:</code>, <code class="language-plaintext highlighter-rouge">Invariant:</code>, <code class="language-plaintext highlighter-rouge">Logical:</code>, <code class="language-plaintext highlighter-rouge">Mapping:</code>, <code class="language-plaintext highlighter-rouge">Profile:</code>, <code class="language-plaintext highlighter-rouge">Resource:</code>, <code class="language-plaintext highlighter-rouge">RuleSet:</code>, <code class="language-plaintext highlighter-rouge">ValueSet:</code>, <code class="language-plaintext highlighter-rouge">Description:</code>, <code class="language-plaintext highlighter-rouge">Expression:</code>, <code class="language-plaintext highlighter-rouge">Id:</code>, <code class="language-plaintext highlighter-rouge">InstanceOf:</code>, <code class="language-plaintext highlighter-rouge">Parent:</code>, <code class="language-plaintext highlighter-rouge">Severity:</code>, <code class="language-plaintext highlighter-rouge">Source:</code>, <code class="language-plaintext highlighter-rouge">Target:</code>, <code class="language-plaintext highlighter-rouge">Title:</code>, <code class="language-plaintext highlighter-rouge">Usage:</code>, <code class="language-plaintext highlighter-rouge">XPath:</code>.</p>

<p>The following words are reserved, with or without white spaces inside the parentheses: <code class="language-plaintext highlighter-rouge">(example)</code>, <code class="language-plaintext highlighter-rouge">(preferred)</code>, <code class="language-plaintext highlighter-rouge">(extensible)</code>, <code class="language-plaintext highlighter-rouge">(required)</code>, <code class="language-plaintext highlighter-rouge">(exactly)</code>.</p>

<p>The following words are reserved when followed by an opening parenthesis <code class="language-plaintext highlighter-rouge">(</code> with or without whitespace preceding it, a sequence of text, and then a closing parenthesis <code class="language-plaintext highlighter-rouge">)</code>: <code class="language-plaintext highlighter-rouge">Canonical</code>, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span><code class="language-plaintext highlighter-rouge">CodeableReference</code></span>, <code class="language-plaintext highlighter-rouge">Reference</code>.</p>

<p>Reserved words SHOULD NOT be used as item names or slice names in FSH projects. Implementations MAY choose to support reserved word item or slice names, but they are not required to do so.</p>

<h4 id="whitespace">Whitespace</h4>

<p>Repeated whitespace SHALL NOT have meaning in FSH except within string literals and when used for <a href="reference.html#indented-rules">indenting rules</a>. Whitespace insensitivity MAY be used to improve readability. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component contains appearanceScore 0..3 and pulseScore 0..3 and grimaceScore 0..3 and activityScore 0..3 and respirationScore 0..3
</code></pre></div></div>

<p>MAY be reformatted as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component contains
    appearanceScore 0..3 and
    pulseScore 0..3 and
    grimaceScore 0..3 and
    activityScore 0..3 and
    respirationScore 0..3
</code></pre></div></div>

<p>FSH syntax is agnostic regarding the type of whitespace used (e.g., spaces, tabs, non-breaking spaces, etc.), with the following exceptions:</p>

<ul>
  <li>FSH rules MUST be separated using a standard newline and/or carriage return</li>
  <li>indented rules MUST be indented using standard space characters</li>
  <li>whitespace within strings MUST be preserved as-is, except as noted for triple-quoted strings</li>
</ul>

<h4 id="comments">Comments</h4>

<p>FSH follows <a href="https://www.w3schools.com/js/js_comments.asp">JavaScript syntax</a> for code comments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Use a double-slash for comments on a single line

/*
Use slash-asterisk and asterisk-slash for larger block comments.
These comments MAY take up multiple lines.
*/
</code></pre></div></div>

<p>The ANTLR implementation referenced in <a href="#appendix-fsh-grammar-informative">the Appendix</a> discards comments, however, implementations MAY use approaches that process comments.</p>

<h4 id="primitives">Primitives</h4>

<p>The primitive datatypes and value formats in FSH are those defined in the version of FHIR associated with the FSH project. References in this document to code, id, oid, etc. refer to <a href="https://hl7.org/fhir/R5/datatypes.html#primitive">the primitive datatypes</a> in the referred FHIR version.</p>

<p>FSH strings follow the same rules and support the same content as the <a href="https://hl7.org/fhir/R5/datatypes.html#string">FHIR string datatype</a>, including the following special escape sequences: \r (unicode U+000D), \n (U+000A), and \t (U+0009). Strings MUST be delimited by non-directional (neutral) quotes (U+0022). Left and right directional quotes (U+201C and U+201D) sometimes automatically inserted by "smart" text editors SHALL NOT be accepted. Left and right directional single quotes (U+2018 and U+2019) SHALL NOT be accepted in contexts requiring a single quotation mark; the non-directional apostrophe (U+0027) MUST be used instead.</p>

<h4 id="references">References</h4>

<p>FHIR elements can contain <a href="https://hl7.org/fhir/R5/references.html#2.1.3.0">references to other Resources</a>. FSH represents references using the syntax <code class="language-plaintext highlighter-rouge">Reference({Resource/Profile})</code>. A resource or profile SHALL be identifiable by name, id, or URL. For example, <code class="language-plaintext highlighter-rouge">Reference(USCorePatientProfile)</code>, <code class="language-plaintext highlighter-rouge">Reference(us-core-patient)</code>, and <code class="language-plaintext highlighter-rouge">Reference(http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient)</code> all are valid references to the <a href="https://hl7.org/fhir/us/core/structuredefinition-us-core-patient.html">US Core Patient profile</a>. When referring to a Reference element, the <code class="language-plaintext highlighter-rouge">Reference()</code> MUST be included, except in the case of a <a href="#reference-paths">reference choice path</a>. When syntax allows for a FSH Reference with multiple targets, the items MUST be separated by <code class="language-plaintext highlighter-rouge">or</code> placed <em>inside</em> the parentheses, e.g. <code class="language-plaintext highlighter-rouge">Reference(Patient or Practitioner)</code>, <strong>not</strong> <code class="language-plaintext highlighter-rouge">Reference(Patient) or Reference(Practitioner)</code>.</p>

<p>In constructing profiles, references typically refer to resource or profile <em>types</em>, for example, the subject of an Observation could be constrained to <code class="language-plaintext highlighter-rouge">Reference(Patient or Group)</code>. Inside instances, references typically refer to other instances, for example, a subject of an Observation could be <code class="language-plaintext highlighter-rouge">Reference(JaneDoe)</code>, assuming JaneDoe is the id of a Patient instance. In this case, since <code class="language-plaintext highlighter-rouge">JaneDoe</code> is a Patient instance, <code class="language-plaintext highlighter-rouge">Reference(JaneDoe)</code> is resolved to <code class="language-plaintext highlighter-rouge">Patient/JaneDoe</code>. If a reference value in an instance does not reference a known instance, implementations MUST use the value directly. For example, if the subject of an Observation is <code class="language-plaintext highlighter-rouge">Reference(Alice)</code>, and Alice is not the name, id, or URL of a known Patient instance, the reference resolves to <code class="language-plaintext highlighter-rouge">Alice</code>.</p>

<h4 id="canonicals">Canonicals</h4>

<p>FHIR elements can reference other resources by their <a href="https://hl7.org/fhir/R5/references.html#canonical">canonical URL</a>. A canonical reference refers to the standard URL associated with a FHIR item. For elements that require a canonical datatype, FSH accepts a URL or an expression in the form <code class="language-plaintext highlighter-rouge">Canonical({name or id or url})</code>. <code class="language-plaintext highlighter-rouge">Canonical({name or id or url})</code> resolves to the canonical URL of the referenced item.</p>

<p>For items defined in the same FSH project, implementations MUST construct the canonical URL using the FSH project's canonical URL. <code class="language-plaintext highlighter-rouge">Canonical()</code> therefore enables a user to change the FSH project’s canonical URL in a single place with no changes to FSH definitions.</p>

<p>When syntax allows for a FSH Canonical with multiple targets, the items MUST be separated by <code class="language-plaintext highlighter-rouge">or</code> placed <em>inside</em> the parentheses, e.g. <code class="language-plaintext highlighter-rouge">Canonical(ActivityDefinition or PlanDefinition)</code>, <strong>not</strong> <code class="language-plaintext highlighter-rouge">Canonical(ActivityDefinition) or Canonical(PlanDefinition)</code>.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>The canonical URL for the FHIR <a href="https://hl7.org/fhir/R5/valueset-example-yesnodontknow.html">Yes/No/Don't Know value set</a>, which evaluates to "http://hl7.org/fhir/ValueSet/yesnodontknow":</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canonical(yesnodontknow)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assuming the current FSH project has a canonical URL of "http://example.org", and <code class="language-plaintext highlighter-rouge">ExampleValueSet</code> is a defined value set within the FSH project with an id of <code class="language-plaintext highlighter-rouge">example-value-set</code>, the following expression evaluates to "http://example.org/ValueSet/example-value-set":</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canonical(ExampleValueSet)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Adding a specific version to the argument of a Canonical expression results in the stated version appended to the canonical URL. So this:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Canonical(us-core-allergyintolerance|3.1.1)
</code></pre></div>    </div>

    <p>evaluates to this: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-allergyintolerance|3.1.1"</p>
  </li>
</ul>

<h4 id="codes-and-codings">Codes and Codings</h4>

<p>FSH provides special syntax for expressing codes and Codings. Codes MUST be denoted with the <code class="language-plaintext highlighter-rouge">#</code> sign. The FSH syntax is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#{code}
</code></pre></div></div>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#"{code}"
</code></pre></div></div>

<p>In general, the first syntax is sufficient. Quotes MUST be used when a code contains white space, but MAY be used in other circumstances as well.</p>

<p>FSH represents Codings as follows:</p>

<pre><code><span class="optional">{CodeSystem}|{version string}</span>#{code} <span class="optional">"{display string}"</span></code></pre>

<p>As <a href="#notational-conventions">indicated by orange-colored text</a>, the version and display strings are OPTIONAL. <code class="language-plaintext highlighter-rouge">CodeSystem</code> is RECOMMENDED and represents the controlled terminology the code is taken from, either by name, by id, or canonical URL. The vertical bar syntax for the version of the code system is the same approach used in the canonical datatype in FHIR. <a href="#assignments-with-the-coding-data-type">Assignment rules</a> MAY be used to set the less-common properties of a Coding or to set properties individually.</p>

<p>This syntax is also used with CodeableConcepts (see <a href="#assignments-with-the-codeableconcept-data-type">Assignments with the CodeableConcept Data Type</a>) and <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> CodeableReferences (see <a href="#assignments-with-the-codeablereference-data-type">Assignments with the CodeableReference Data Type</a>)</span>.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>The code postal used in <code class="language-plaintext highlighter-rouge">Address.type</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#postal
</code></pre></div>    </div>
  </li>
  <li>
    <p>The code &lt;= from the <a href="https://hl7.org/fhir/R5/valueset-quantity-comparator.html">Quantity Comparator value set</a>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#&lt;=
</code></pre></div>    </div>
  </li>
  <li>
    <p>A code containing white space:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#"VL 1-1, 18-65_1.2.2"
</code></pre></div>    </div>
  </li>
  <li>
    <p>A Coding from SNOMED-CT:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://snomed.info/sct#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>The same Coding, assuming <code class="language-plaintext highlighter-rouge">$SCT</code> has been defined as an alias for http://snomed.info/sct:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>A Coding from ICD10-CM, assuming the alias <code class="language-plaintext highlighter-rouge">$ICD</code> for that code system:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ICD#C004 "Malignant neoplasm of lower lip, inner aspect"
</code></pre></div>    </div>
  </li>
  <li>
    <p>A Coding with an explicit version specified with bar syntax:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://hl7.org/fhir/CodeSystem/example-supplement|201801103#chol-mmol
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="quantities">Quantities</h4>

<p>FSH provides a shorthand that allows three aspects of a Quantity to be set simultaneously:</p>

<ul>
  <li>The numerical quantity (<code class="language-plaintext highlighter-rouge">Quantity.value</code>)</li>
  <li>The units of measure (<code class="language-plaintext highlighter-rouge">Quantity.system</code> and <code class="language-plaintext highlighter-rouge">Quantity.code</code>)</li>
  <li>Optionally, the human-readable displayed units (<code class="language-plaintext highlighter-rouge">Quantity.unit</code>)</li>
</ul>

<p>The syntax is either:</p>

<pre><code>{decimal} '{UCUM code}' <span class="optional">"{display}"</span></code></pre>

<p>or</p>

<pre><code>{decimal} {CodeSystem}<span class="optional">|{version string}</span>#{code} <span class="optional">"{display}"</span></code></pre>

<p>The first shorthand syntax only applies if the units are expressed in <a href="http://unitsofmeasure.org/">Unified Code for Units of Measure</a> (UCUM). When this syntax is used, implementations MUST set the code system (<code class="language-plaintext highlighter-rouge">Quantity.system</code>) to the UCUM code system (http://unitsofmeasure.org). The second shorthand MAY be used when the units are not UCUM. Alternatively, the value and units MAY be assigned independently (see <a href="#assignments-with-the-quantity-data-type">Assignments with the Quantity Data Type</a>).</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Express a weight in pounds, using UCUM units, displaying "lb":</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>155.0 '[lb_av]' "lb"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Express the same weight in pounds, using NCI Thesaurus code for the units:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>155.0 http://ncithesaurus-stage.nci.nih.gov#C48531 "Pound"
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="triple-quoted-strings">Triple-Quoted Strings</h4>

<p>While line breaks are supported using normal strings, FSH also supports different processing for strings demarcated with three double quotation marks <code class="language-plaintext highlighter-rouge">"""</code>. This feature can help authors to maintain consistent indentation in FSH items. As an example, an author might use a triple-quoted string to write markdown so that the markdown is neatly indented:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^purpose = """
    * This profile is intended to support workflows where:
      * this happens; or
      * that happens
    * This profile is not intended to support workflows where:
      * nothing happens
  """
</code></pre></div></div>

<p>Using a single-quoted string requires the following spacing to accomplish the same markdown formatting:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^purpose = "* This profile is intended to support workflows where:
  * this happens; or
  * that happens
* This profile is not intended to support workflows where:
  * nothing happens"
</code></pre></div></div>

<p>The difference between these two approaches is that the latter obscures the fact that the first and fourth line are at the same indentation level, and makes it appear there are two rules because of the asterisk in the first column. The former approach allows the first line to be empty so the string is defined as a block, and allows the entire block to be indented, so visually, it does not appear a second rule is involved (because of the asterisk in the first column). Using triple-quoted strings is entirely a matter of preference.</p>

<p>When processing triple-quoted strings, implementations MUST follow the approach described below:</p>

<ul>
  <li>If the first line or last line contains only whitespace (including newline), discard it.</li>
  <li>If any other line contains only whitespace, truncate it to zero characters.</li>
  <li>For all other non-whitespace lines, detect the line with the least number of leading spaces, and trim that number of spaces from the beginning of every line.</li>
</ul>

<blockquote>
  <p><strong>Note:</strong> To ensure consistent implementation, authors SHOULD use standard spaces or tabs as leading spaces in triple-quoted strings.</p>
</blockquote>

<h4 id="item-names">Item Names</h4>

<p>Item names SHOULD follow <a href="https://hl7.org/fhir/R5/structuredefinition-definitions.html#StructureDefinition.name">FHIR naming guidance</a>. All item names MUST be between 1 and 255 characters. Item names MUST begin with an uppercase ASCII letter and contain only ASCII letters, numbers, and underscores (<code class="language-plaintext highlighter-rouge">_</code>). By convention, item names SHOULD use <a href="https://wiki.c2.com/?UpperCamelCase">PascalCase (also known as UpperCamelCase)</a>.</p>

<p><a href="#contains-rules-for-slicing">Slice names</a> and <a href="#contains-rules-for-extensions">local slice names for extensions</a> SHOULD use <a href="https://wiki.c2.com/?CamelCase">lower camelCase</a>. Slice names MUST contain only ASCII letters, numbers, underscores (<code class="language-plaintext highlighter-rouge">_</code>), hyphens (<code class="language-plaintext highlighter-rouge">-</code>), at signs (<code class="language-plaintext highlighter-rouge">@</code>), and forward slashes (<code class="language-plaintext highlighter-rouge">/</code>, used only for re-slicing). These conventions are consistent with FHIR slice naming conventions specified in <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#def">eld-16</a>, aside from disallowing square brackets (<code class="language-plaintext highlighter-rouge">[</code> and <code class="language-plaintext highlighter-rouge">]</code>) since they are used by <a href="#sliced-array-paths">sliced array path</a> syntax.</p>

<p>Alias names SHOULD begin with a dollar sign (<code class="language-plaintext highlighter-rouge">$</code>) and MUST otherwise contain only ASCII letters, numbers, underscores (<code class="language-plaintext highlighter-rouge">_</code>), hyphens (<code class="language-plaintext highlighter-rouge">-</code>), and dots (<code class="language-plaintext highlighter-rouge">.</code>). Beginning alias names with <code class="language-plaintext highlighter-rouge">$</code> is a good practice, since this convention allows for additional error checking (<a href="#defining-aliases">see Defining Aliases</a> for details).</p>

<blockquote>
  <p><strong>Note:</strong> Instances have identifiers rather than names, so instance declarations SHALL follow the recommendations for <a href="#item-identifiers">Item Identifiers</a>.</p>
</blockquote>

<h4 id="item-identifiers">Item Identifiers</h4>

<p>Item identifiers (ids) MUST be unique within the scope of its item type in the FSH project. For example, two Profiles with the same id cannot coexist, but it is possible to have a Profile and a ValueSet with the same id in the same FSH Project. However, to minimize potential confusion, it is best to use a unique id for every item in a FSH project. If no id is provided by a FSH author, implementations MAY create an id.</p>

<p>Ids MUST contain only ASCII letters, numerals, hyphens (<code class="language-plaintext highlighter-rouge">-</code>), and dots (<code class="language-plaintext highlighter-rouge">.</code>), with a length limit of 64 characters (per the requirements of the <a href="https://hl7.org/fhir/R5/datatypes.html#primitive">FHIR id datatype</a>). By convention, ids SHOULD be lowercase with words separated by hyphens. If the item has a name, the id SHOULD be based on the item's name, with <code class="language-plaintext highlighter-rouge">_</code> replaced by <code class="language-plaintext highlighter-rouge">-</code>, changed to lowercase, and truncated if necessary.</p>

<h4 id="referring-to-items">Referring to Items</h4>

<p>FSH allows internal and external items to be referred to by name, id, or canonical URL.</p>

<p>A FSH item within the same project SHOULD be referred to by the name or id given in the item's <a href="#declaration-statements">declaration statement</a>. Core FHIR resources SHOULD be referred to by name, e.g., <code class="language-plaintext highlighter-rouge">Patient</code> or <code class="language-plaintext highlighter-rouge">Observation</code>. Items from external IGs and extensions, profiles, code systems, and value sets in core FHIR SHOULD be referred to by their canonical URLs, since this approach minimizes the chance of name collisions. In cases where an external name or id clashes with an internal name or id, then the internal item SHALL take precedence, and the external item MUST be referred to by its canonical URL.</p>

<h3 id="fsh-paths">FSH Paths</h3>

<p>FSH path grammar allows you to refer to any element of a profile, extension, or instance, regardless of nesting. Here are examples of things paths can refer to:</p>

<ul>
  <li>Top-level elements such as the <code class="language-plaintext highlighter-rouge">code</code> element of an Observation</li>
  <li>Nested elements, such as the <code class="language-plaintext highlighter-rouge">text</code> element of the <code class="language-plaintext highlighter-rouge">method</code> element of an Observation</li>
  <li>Elements in a list or array, such as the second element in the <code class="language-plaintext highlighter-rouge">name</code> array of a Patient resource</li>
  <li>Individual datatypes of choice elements, such as <code class="language-plaintext highlighter-rouge">onsetAge</code> in <code class="language-plaintext highlighter-rouge">onset[x]</code></li>
  <li>Individual slices within a sliced array, such as the <code class="language-plaintext highlighter-rouge">systolicBP</code> component slice in a blood pressure Observation</li>
  <li>Metadata elements of definitional resources, such as the <code class="language-plaintext highlighter-rouge">experimental</code> and <code class="language-plaintext highlighter-rouge">active</code> elements of a StructureDefinition.</li>
  <li>Properties of ElementDefinitions nested within a StructureDefinition, such as the <code class="language-plaintext highlighter-rouge">maxLength</code> property of string elements</li>
</ul>

<blockquote>
  <p><strong>Note:</strong> While FSH paths often resemble other path syntaxes used in FHIR (e.g., FHIRPath, <code class="language-plaintext highlighter-rouge">ElementDefinition.id</code>, <code class="language-plaintext highlighter-rouge">ElementDefinition.path</code>), they cannot be used in place of these. Attempts to use FSH paths within FHIRPath strings or as Element ids will lead to invalid FHIR output.</p>
</blockquote>

<p>In the following, the various types of path references are discussed. Some examples are presented using simple rules. For rule syntax and meaning, see <a href="#fsh-rules">FSH Rules</a>.</p>

<h4 id="top-level-paths">Top-Level Paths</h4>

<p>The path to a top-level element SHALL be denoted by the element's name. Because paths are used within the context of a FSH definition or instance, the path MUST NOT include the resource name. For example, when defining a profile of Observation, the path to <code class="language-plaintext highlighter-rouge">Observation.code</code> is just <code class="language-plaintext highlighter-rouge">code</code>.</p>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>The path to the status of a MedicationRequest:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>status
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="nested-element-paths">Nested Element Paths</h4>

<p>To refer to nested elements, the path SHALL list the properties in order, separated by a dot (<code class="language-plaintext highlighter-rouge">.</code>). Since the resource can be inferred from the context, the resource name MUST NOT be included in the path.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>The path to the lot number of a Medication:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batch.lotNumber
</code></pre></div>    </div>
  </li>
  <li>
    <p>The path to the plain text representation of the site of a MedicationAdministration:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dosage.site.text
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="reference-paths">Reference Paths</h4>

<p>Elements can offer a choice of reference types. In the FHIR specification, these choices are presented in the style Reference(Procedure | Observation). To address a specific resource or profile among the choices, the target Resource or Profile (represented by a name, id, or url) SHALL be enclosed in square brackets and appended to the end of the path after the reference element (and slice name, if applicable).</p>

<blockquote>
  <p><strong>Note:</strong> It is not permissible to cross reference boundaries in paths. This means that when a path gets to a Reference, that path cannot be extended further. For example, if Procedure has a <code class="language-plaintext highlighter-rouge">subject</code> element that has datatype Reference(Patient), and Patient has a <code class="language-plaintext highlighter-rouge">gender</code>, then <code class="language-plaintext highlighter-rouge">subject</code> is a valid path, but <code class="language-plaintext highlighter-rouge">subject.gender</code> is not, because it crosses into the Patient resource.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Path to the Reference(Practitioner) option of <a href="https://hl7.org/fhir/R5/diagnosticreport.html">DiagnosticReport.performer</a>, whose acceptable datatypes are Reference(Practitioner), Reference(PractitionerRole), Reference(Organization) or Reference(CareTeam):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>performer[Practitioner]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Path to the Reference(US Core Organization) option of the <code class="language-plaintext highlighter-rouge">performer</code> element in <a href="https://hl7.org/fhir/us/core/StructureDefinition-us-core-diagnosticreport-lab.html">US Core DiagnosticReport Lab</a>, using the canonical URL:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>performer[http://hl7.org/fhir/us/core/StructureDefinition/us-core-organization]
</code></pre></div>    </div>
  </li>
  <li>
    <p>The same path, using the id of the US Core Organization profile instead of its canonical URL:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>performer[us-core-organization]
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="data-type-choice-x-paths">Data Type Choice [x] Paths</h4>

<p>FHIR represents an element with a choice of datatypes using the style <code class="language-plaintext highlighter-rouge">foo[x]</code>. For example, <code class="language-plaintext highlighter-rouge">Condition.onset[x]</code> can be a dateTime, Age, Period, Range or string. In FSH, <a href="https://hl7.org/fhir/R5/formats.html#choice">as in FHIR</a>, to refer to one of these datatypes, the <code class="language-plaintext highlighter-rouge">[x]</code> SHALL be replaced by the datatype name, capitalizing the first letter. For <code class="language-plaintext highlighter-rouge">Condition.onset[x]</code>, the individual choices are <code class="language-plaintext highlighter-rouge">onsetDateTime</code>, <code class="language-plaintext highlighter-rouge">onsetAge</code>, <code class="language-plaintext highlighter-rouge">onsetPeriod</code>, <code class="language-plaintext highlighter-rouge">onsetRange</code>, and <code class="language-plaintext highlighter-rouge">onsetString</code>.</p>

<blockquote>
  <p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">foo[x]</code> choices are NOT represented as <code class="language-plaintext highlighter-rouge">foo[dateTime]</code>, <code class="language-plaintext highlighter-rouge">foo[Period]</code>, etc.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>The path to the string datatype of <code class="language-plaintext highlighter-rouge">Observation.value[x]</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>valueString
</code></pre></div>    </div>
  </li>
  <li>
    <p>The path to the Reference datatype choice of <code class="language-plaintext highlighter-rouge">Medication.ingredient.item[x]</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ingredient.itemReference
</code></pre></div>    </div>
  </li>
  <li>
    <p>Given that the itemReference has further choices Reference(Substance) or Reference(Medication), the path to the Reference(Substance) choice:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ingredient.itemReference[Substance]
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="array-paths-using-numerical-indices">Array Paths using Numerical Indices</h4>

<p>FSH paths SHALL use square-bracketed integers to address elements in arrays. Arrays SHALL be referenced using 0-based indices, meaning that the first array element is referenced by <code class="language-plaintext highlighter-rouge">[0]</code>, the second element is referenced by <code class="language-plaintext highlighter-rouge">[1]</code>, etc. Arrays with missing elements (gaps in the sequence of indices) SHALL NOT be allowed. If the index is omitted, the first element of the array (<code class="language-plaintext highlighter-rouge">[0]</code>) SHALL be assumed.</p>

<p>Numerical indices apply only to arrays that can be populated with concrete values, e.g., in instances or in metadata elements of StructureDefinitions. For this reason, numerical indices MUST NOT be used in Profiles except when using <a href="#caret-paths">caret paths</a> to set metadata properties of StructureDefinitions . Authors SHOULD use <a href="#contains-rules-for-slicing">slicing</a> and <a href="#sliced-array-paths">sliced array paths</a> to constrain specific array elements in Profiles.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Path to first element in <code class="language-plaintext highlighter-rouge">Patient.name</code> field within an instance of Patient:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name[0]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Path to a patient's second <code class="language-plaintext highlighter-rouge">given</code> name in the first <code class="language-plaintext highlighter-rouge">name</code> field within an instance of Patient:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name[0].given[1]
</code></pre></div>    </div>
  </li>
  <li>
    <p>An equivalent path expression, since the zero index is assumed when omitted:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name.given[1]
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="array-paths-using-soft-indexing">Array Paths using Soft Indexing</h4>

<p>Numerical array references MAY be replaced with "soft indexing." In soft indexing, <code class="language-plaintext highlighter-rouge">[+]</code> SHALL be used to increment the last referenced index by 1, and <code class="language-plaintext highlighter-rouge">[=]</code> SHALL be used to reference the same index that was last referenced. When an array is empty, <code class="language-plaintext highlighter-rouge">[+]</code> SHALL refer to the first element (<code class="language-plaintext highlighter-rouge">[0]</code>). Authors MAY mix the use of soft and numerical indices.</p>

<p>Similar to numerical indices, soft indices SHALL only be used when populating or referencing arrays in instances and invariants, or when using <a href="#caret-paths">caret paths</a>.</p>

<p>Soft indexing is useful when populating long arrays, allowing elements to be inserted, deleted, or moved without updating numerical indices. Complex resources such as Bundle and CapabilityStatement have arrays that may contain scores of items. Managing indices can become tedious and error prone when adding or removing items in the middle of a long list.</p>

<p>Another use case for soft indexing involves <a href="#defining-rule-sets">rule sets</a>. Rule sets provide a way to avoid repeating the same pattern of rules when populating an array (<a href="#parameterized-rule-sets">see example</a>).</p>

<p>For nested arrays, several sequences of soft indices MAY run simultaneously. The sequence of indices at different levels of nesting SHALL be independent and SHALL NOT interact with one another. However, when arrays are nested, incrementing the index of the parent (outer) array advances to the next child (inner) array, so the next child element referred to by <code class="language-plaintext highlighter-rouge">[+]</code> SHALL be at index 0. (An analogy is using a keyboard's Enter key to advance to a new line that initially has no characters.)</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Assign multiple names in an instance of a Patient using soft indices:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name[+].given = "Robert"
* name[=].family = "Smith"
* name[+].given = "Rob"
* name[=].family = "Smith"
* name[+].given = "Bob"
* name[=].family = "Smith"
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name[0].given = "Robert"
* name[0].family = "Smith"
* name[1].given = "Rob"
* name[1].family = "Smith"
* name[2].given = "Bob"
* name[2].family = "Smith"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add second given name to the example above, using soft indexing:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name[+].given[+] = "Robert"
* name[=].given[+] = "David"
* name[=].family = "Smith"
* name[+].given[+] = "Rob"
* name[=].given[+] = "Dave"
* name[=].family = "Smith"
* name[+].given[+] = "Bob"
* name[=].given[+] = "Davey"
* name[=].family = "Smith"
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name[0].given[0] = "Robert"
* name[0].given[1] = "David"
* name[0].family = "Smith"
* name[1].given[0] = "Rob"
* name[1].given[1] = "Dave"
* name[1].family = "Smith"
* name[2].given[0] = "Bob"
* name[2].given[1] = "Davey"
* name[2].family = "Smith"
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="sliced-array-paths">Sliced Array Paths</h4>

<p>FHIR allows lists in profiles and extensions to be compartmentalized into sublists called "slices". To address a specific slice, the slice name SHALL be enclosed in square brackets and appended after the sliced element in the path. Since slices are most often unordered, slice names rather than array indices SHOULD be used in instances. Note that slice names (like other <a href="#item-names">FSH item names</a>) SHALL NOT be purely numerical, so slice names cannot be confused with indices.</p>

<p>To access a slice of a slice (a resliced array), the first pair of brackets containing the base slice name SHALL be followed by a second pair of brackets containing the resliced slice name.</p>

<p>When a list of references is sliced, and a given slice refers to multiple targets, sliced array paths MAY be combined with <a href="#reference-paths">reference paths</a> by specifying the slice name in brackets first, followed by the target reference type in brackets.</p>

<p>Since slices are sublists, a sliced array path technically points to the <em>first</em> item in the sublist (e.g., index 0 of the slice's sublist). Other items in the sublist MAY be accessed by appending square-bracketed integer indices (e.g., <code class="language-plaintext highlighter-rouge">[1]</code>) or soft indices (e.g., <code class="language-plaintext highlighter-rouge">[+]</code>) to the end of the sliced array path. In this case, indices are relative to the first item in the slice.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Path to the coded value of the <code class="language-plaintext highlighter-rouge">respirationScore</code> component slice within an Observation profile representing an Apgar test:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>component[respirationScore].code
</code></pre></div>    </div>
  </li>
  <li>
    <p>Paths to the codes representing the one minute and five minute respiration scores, assuming the Apgar <code class="language-plaintext highlighter-rouge">respirationScore</code> component slice has been resliced:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>component[respirationScore][oneMinuteScore].code

component[respirationScore][fiveMinuteScore].code
</code></pre></div>    </div>
  </li>
  <li>
    <p>Paths to the MedicationRequest and NutritionOrder reference options in an <code class="language-plaintext highlighter-rouge">orders</code> slice that allows both types:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>basedOn[orders][MedicationRequest]
  
basedOn[orders][NutritionOrder]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Paths to the resources of the second and third entries in the <code class="language-plaintext highlighter-rouge">medications</code> slice of a profiled Bundle:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>entry[medications][1].resource

entry[medications][+].resource
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="extension-paths">Extension Paths</h4>

<p>Extension arrays are found at the root level of every resource, nested inside every element, and recursively inside each extension. Extensions are elements in these arrays. When an extension is specified in an extension array within a profile or extension definition, a name (technically, a slice name) is assigned. Extensions MAY be identified by slice name or the extension's URL.</p>

<p>The path to an extension SHALL consist of a path to an extension array followed by a pair of square brackets enclosing the extension's slice name or canonical URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Extension&gt;[{name or id or URL}]
</code></pre></div></div>

<p>Since an extension array in an instance can contain multiple extensions of the same type, additional instances of the extension MAY be accessed using a square-bracketed index:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Extension&gt;[{name or id or URL}][{index}]
</code></pre></div></div>

<p>For locally-defined extensions, using the slice name is the simplest choice. For externally-defined extensions, the canonical URL can be easier to find than the slice name.</p>

<blockquote>
  <p><strong>Note:</strong> The same path construction SHALL apply to modifierExtension arrays; simply replace <code class="language-plaintext highlighter-rouge">extension</code> with <code class="language-plaintext highlighter-rouge">modifierExtension</code>.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Path to the value of the birth sex extension in US Core Patient, whose local slice name is <code class="language-plaintext highlighter-rouge">birthsex</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension[birthsex].valueCode
</code></pre></div>    </div>
  </li>
  <li>
    <p>Path to an extension on the <code class="language-plaintext highlighter-rouge">telecom</code> element of Patient, assuming the extension has been given the local slice name <code class="language-plaintext highlighter-rouge">directMailAddress</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>telecom.extension[directMailAddress]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Same as the previous example, but using the canonical URL for the direct mail extension defined in US Core:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>telecom.extension[http://hl7.org/fhir/us/core/StructureDefinition/us-core-direct]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Path to the Coding datatype of the <code class="language-plaintext highlighter-rouge">value[x]</code> in the nested extension <code class="language-plaintext highlighter-rouge">ombCategory</code> under the <code class="language-plaintext highlighter-rouge">ethnicity</code> extension in US Core, using the slice names of the extensions:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension[ethnicity].extension[ombCategory].valueCoding
</code></pre></div>    </div>
  </li>
  <li>
    <p>Path to the Coding value in second element in the nested extension array named detailed, under the US Core Ethnicity extension:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension[ethnicity].extension[detailed][1].valueCoding
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="caret-paths">Caret Paths</h4>

<p>The FSH syntax provides a level of abstraction over FHIR resources. When authors define a Profile, Extension, Logical, or Resource using FSH, they are creating and modifying an instance of an underlying FHIR StructureDefinition. Similarly, when authors define a CodeSystem or ValueSet, they are creating and modifying an instance of a FHIR CodeSystem or FHIR ValueSet. While the basic FSH syntax maps to the core aspects of each of these FHIR definitional resources, it does not provide a complete mapping to every possible element within them.</p>

<p>In order to address this gap, FSH authors MAY use the caret (<code class="language-plaintext highlighter-rouge">^</code>) symbol to access elements of definitional resources corresponding to the current item in context. Caret paths SHALL be accepted in FSH Profiles, Extensions, Logicals, and Resources to address elements in the underlying FHIR StructureDefinition resource; in FSH Invariants to address elements in the underlying <code class="language-plaintext highlighter-rouge">ElementDefinition.constraint</code>; in FSH ValueSets to address elements in the underlying FHIR ValueSet resource; in FSH CodeSystems to address elements in the underlying FHIR CodeSystem resource; and in FSH RuleSets, as long as the RuleSet is inserted in an item that allows caret paths. Caret paths SHALL NOT be used with any other FSH item definition, including Instances, since Instances already directly manipulate FHIR resources. In addition, caret syntax SHALL NOT be used with the following paths, because the order of elements in these paths MAY vary between implementations:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">snapshot.element</code> and <code class="language-plaintext highlighter-rouge">differential.element</code> in Profile, Extension, Logical, and Resource items</li>
  <li><code class="language-plaintext highlighter-rouge">compose.include</code> and <code class="language-plaintext highlighter-rouge">compose.exclude</code> in ValueSet items</li>
</ul>

<p>Examples of elements that require the caret syntax include <code class="language-plaintext highlighter-rouge">StructureDefinition.experimental</code>, <code class="language-plaintext highlighter-rouge">StructureDefinition.abstract</code> and <code class="language-plaintext highlighter-rouge">ValueSet.purpose</code>. The caret syntax also provides a simple way to set metadata attributes in the ElementDefinitions that comprise the snapshot and differential tables (e.g., <code class="language-plaintext highlighter-rouge">short</code>, <code class="language-plaintext highlighter-rouge">meaningWhenMissing</code>, and various <a href="#step-1-specify-the-slicing-logic">slicing discriminator properties</a>).</p>

<p>For a path to an element of a StructureDefinition, excluding the differential and snapshot, use the following syntax inside a Profile, Extension, Logical, or Resource:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>^&lt;element of StructureDefinition&gt;
</code></pre></div></div>

<p>For a path to an element of an ElementDefinition within a StructureDefinition, use this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;element in Profile&gt; ^&lt;element of corresponding ElementDefinition&gt;
</code></pre></div></div>

<p><strong>Note:</strong> When using caret paths to access metadata of element definitions, there is a REQUIRED space before the <code class="language-plaintext highlighter-rouge">^</code> character.</p>

<p>A special case of the ElementDefinition path is setting properties of the first element of the differential (i.e., <code class="language-plaintext highlighter-rouge">StructureDefinition.differential.element[0]</code>). This element always refers to the profile or standalone extension itself. Since this element does not correspond to a named element appearing in an instance, the dot or full stop (<code class="language-plaintext highlighter-rouge">.</code>) SHALL be used to represent it. (The dot symbol is often used to represent "current context" in other languages.) It is important to note that the "self" elements are not the elements of a StructureDefinition directly, but elements of the first ElementDefinition contained in the StructureDefinition. The syntax is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. ^&lt;element of StructureDefinition.differential[0]&gt;
</code></pre></div></div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>In a profile definition, path to the corresponding <code class="language-plaintext highlighter-rouge">StructureDefinition.experimental</code> attribute:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>^experimental
</code></pre></div>    </div>
  </li>
  <li>
    <p>In a profile of Patient, the path to <code class="language-plaintext highlighter-rouge">binding.description</code> in the ElementDefinition corresponding to <code class="language-plaintext highlighter-rouge">communication.language</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>communication.language ^binding.description
</code></pre></div>    </div>
  </li>
  <li>
    <p>The path to the short description of an extension (defined in the first ElementDefinition):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. ^short
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="fsh-items">FSH Items</h3>

<h4 id="structure-of-fsh-items">Structure of FSH Items</h4>

<p>A central purpose of FSH is to create and define items that represent and can be translated into FHIR artifacts. The general pattern used to define an item in FSH is:</p>

<ul>
  <li>Declaration statement</li>
  <li>Keyword statements</li>
  <li>Rule statements</li>
</ul>

<p>While every FSH item requires a declaration, depending on the item type, keyword statements and rules may not be required, or even permitted.</p>

<h5 id="declaration-statements">Declaration Statements</h5>

<p>Declaration statements follow the syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{declaration}: {value}
</code></pre></div></div>

<p>A declaration is always the first statement in an item definition. The value represents the item's name or identifier (id), depending on the item's type, as shown in the table below:</p>

<p><span class="caption" id="t4">Table 4. Declarations defined by FSH</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Declaration</th>
      <th>Creates…</th>
      <th>Data Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#defining-aliases">Alias</a></td>
      <td>An alias for a URL or OID</td>
      <td>expression</td>
    </tr>
    <tr>
      <td><a href="#defining-code-systems">CodeSystem</a></td>
      <td>A code system</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-extensions">Extension</a></td>
      <td>An extension</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-instances">Instance</a></td>
      <td>An instance</td>
      <td>id</td>
    </tr>
    <tr>
      <td><a href="#defining-invariants">Invariant</a></td>
      <td>An invariant</td>
      <td>id</td>
    </tr>
    <tr>
      <td><a href="#defining-logical-models">Logical</a></td>
      <td>A logical model</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-mappings">Mapping</a></td>
      <td>A mapping</td>
      <td>id</td>
    </tr>
    <tr>
      <td><a href="#defining-profiles">Profile</a></td>
      <td>A profile</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-resources">Resource</a></td>
      <td>A custom resource</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-rule-sets">RuleSet</a></td>
      <td>A set of rules that can be reused</td>
      <td>name</td>
    </tr>
    <tr>
      <td><a href="#defining-value-sets">ValueSet</a></td>
      <td>A value set</td>
      <td>name</td>
    </tr>
  </tbody>
</table>

<h5 id="keyword-statements">Keyword Statements</h5>

<p>Keyword statements directly follow the declaration and precede any rules. Keyword statements follow the syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{keyword}: {value}
</code></pre></div></div>

<p>The following keywords (case-sensitive) are defined:</p>

<p><span class="caption" id="t5">Table 5. Keywords defined by FSH</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Keyword</th>
      <th>Purpose</th>
      <th>Data Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Characteristics <span class="tuIcon" title="Standards Status = Trial Use">TU</span></td>
      <td>Specifies characteristics for logical models</td>
      <td>codes</td>
    </tr>
    <tr>
      <td>Context <span class="tuIcon" title="Standards Status = Trial Use">TU</span></td>
      <td>Specifies context for extensions</td>
      <td>FHIRPath strings and element paths</td>
    </tr>
    <tr>
      <td>Description</td>
      <td>Provides a human-readable description</td>
      <td>string or markdown</td>
    </tr>
    <tr>
      <td>Expression</td>
      <td>Provides a FHIR path expression in an invariant</td>
      <td>FHIRPath string</td>
    </tr>
    <tr>
      <td>Id</td>
      <td>Provides an identifier for an item</td>
      <td>id</td>
    </tr>
    <tr>
      <td>InstanceOf</td>
      <td>Names the profile, resource, or logical model<sup>*</sup> an instance instantiates</td>
      <td>name or id or url</td>
    </tr>
    <tr>
      <td>Parent</td>
      <td>Names the base definition for a profile or extension</td>
      <td>name or id or url</td>
    </tr>
    <tr>
      <td>Severity</td>
      <td>Specifies whether violation of an invariant represents an error or a warning</td>
      <td>code</td>
    </tr>
    <tr>
      <td>Source</td>
      <td>Provides the profile the mapping applies to</td>
      <td>name</td>
    </tr>
    <tr>
      <td>Target</td>
      <td>Provides the standard being mapped to</td>
      <td>uri</td>
    </tr>
    <tr>
      <td>Title</td>
      <td>Provides a short human-readable name</td>
      <td>string</td>
    </tr>
    <tr>
      <td>Usage</td>
      <td>Specifies how an instance is intended to be used in the IG</td>
      <td>code</td>
    </tr>
    <tr>
      <td>XPath</td>
      <td>Provides the XPath in an invariant</td>
      <td>XPath string</td>
    </tr>
  </tbody>
</table>

<p><span class="tuSpan"><sup>*</sup> Defining instances of logical models in FSH is <span class="tuIcon" title="Standards Status = Trial Use">TU</span>.</span></p>

<p>In the above, "name" refers to a valid <a href="#item-names">item name</a> and "id" to an <a href="#item-identifiers">item identifier</a>.</p>

<p>Depending on the type of item being defined, keywords may be REQUIRED, suggested (SHOULD be used), OPTIONAL, or prohibited (MUST NOT be used). The following table shows the relationship between declarations and keywords:</p>

<p><span class="caption" id="t6">Table 6. Relationships between declarations and keywords in FSH</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>           Keyword →<br />Declaration ↓</th>
      <th>Id</th>
      <th>Description</th>
      <th>Title</th>
      <th>Parent</th>
      <th>InstanceOf</th>
      <th>Usage</th>
      <th>Source</th>
      <th>Target</th>
      <th>Severity</th>
      <th>Expression</th>
      <th>XPath</th>
      <th>Context <span class="tuIcon" title="Standards Status = Trial Use">TU</span></th>
      <th>Characteristics <span class="tuIcon" title="Standards Status = Trial Use">TU</span></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#defining-aliases">Alias</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-code-systems">Code System</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-extensions">Extension</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td>O</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>S</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-instances">Instance</a></td>
      <td> </td>
      <td>S</td>
      <td>S</td>
      <td> </td>
      <td>R</td>
      <td>O</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-invariants">Invariant</a></td>
      <td> </td>
      <td>S<sup>1</sup></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>O<sup>2</sup></td>
      <td>O</td>
      <td>O</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-logical-models">Logical</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td>O</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>O</td>
    </tr>
    <tr>
      <td><a href="#defining-mappings">Mapping</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>R</td>
      <td>R</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-profiles">Profile</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td>R</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-resources">Resource</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td>O</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-rule-sets">Rule Set</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#defining-value-sets">Value Set</a></td>
      <td>S</td>
      <td>S</td>
      <td>S</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><strong>KEY:</strong>  R = REQUIRED, S = suggested (SHOULD be used), O = OPTIONAL, blank = prohibited (MUST NOT be used)</p>

<p><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> <sup>1</sup> If the <code class="language-plaintext highlighter-rouge">Description</code> keyword is not specified in an <code class="language-plaintext highlighter-rouge">Invariant</code> definition, then an assignment rule for the <code class="language-plaintext highlighter-rouge">human</code> element MUST be specified instead.</span>
<br />
<span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> <sup>2</sup> If the <code class="language-plaintext highlighter-rouge">Severity</code> keyword is not specified in an <code class="language-plaintext highlighter-rouge">Invariant</code> definition, then an assignment rule for the <code class="language-plaintext highlighter-rouge">severity</code> element MUST be specified instead.</span></p>

<p>For additional information about the use of these keywords, consult the documentation pertaining to the specific item(s) to which they apply.</p>

<h5 id="rule-statements">Rule Statements</h5>

<p>A number of rules usually follow the keyword statements. The grammar and meaning of different rule types are discussed in the <a href="#fsh-rules">FSH Rules</a> section. Without defining the rule types here, the following table shows the applicability of rule types to item types:</p>

<p><span class="caption" id="t7">Table 7. Relationships between FSH items and FSH rules</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>            Item →<br />Rule Type ↓</th>
      <th><a href="#defining-aliases">Alias</a></th>
      <th><a href="#defining-code-systems">Code System</a></th>
      <th><a href="#defining-extensions">Extension</a></th>
      <th><a href="#defining-instances">Instance</a></th>
      <th><a href="#defining-invariants">Invariant</a></th>
      <th><a href="#defining-logical-models">Logical</a></th>
      <th><a href="#defining-mappings">Mapping</a></th>
      <th><a href="#defining-profiles">Profile</a></th>
      <th><a href="#defining-resources">Resource</a></th>
      <th><a href="#defining-rule-sets">Rule Set</a></th>
      <th><a href="#defining-value-sets">Value Set</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#add-element-rules">Add Element</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#assignment-rules">Assignment</a></td>
      <td> </td>
      <td>C</td>
      <td>Y</td>
      <td>Y</td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td> </td>
      <td>Y</td>
      <td>C</td>
      <td>Y</td>
      <td>C</td>
    </tr>
    <tr>
      <td><a href="#binding-rules">Binding</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td> </td>
      <td>Y</td>
      <td>A</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#cardinality-rules">Cardinality</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td> </td>
      <td>Y</td>
      <td>A</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-extensions">Contains (inline extensions)</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-extensions">Contains (standalone extensions)</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-slicing">Contains (slicing)</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#exclude-rules">Exclude</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td><a href="#flag-rules">Flag</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td>L</td>
      <td> </td>
      <td>Y</td>
      <td>L</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#include-rules">Include</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td><a href="#insert-rules">Insert</a></td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td><a href="#local-code-rules">Local Code</a></td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#mapping-rules">Mapping</a></td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#obeys-rules">Obeys</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#path-rules">Path</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td>Y</td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#type-rules">Type</a></td>
      <td> </td>
      <td> </td>
      <td>Y</td>
      <td> </td>
      <td> </td>
      <td><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Y </span></td>
      <td> </td>
      <td>Y</td>
      <td>A</td>
      <td>Y</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><strong>KEY:</strong> Y = Rule type MAY be used, L = All flags except must support (<code class="language-plaintext highlighter-rouge">MS</code>) are supported, C = Assignments apply only to <a href="#caret-paths">caret paths</a>, A = Rules can only be applied to elements defined by the item (not inherited elements), blank = prohibited.</p>

<h4 id="defining-aliases">Defining Aliases</h4>

<p>Aliases MAY be used to replace a lengthy url, oid, or uuid with a short string. Aliases are for readability only, and SHALL NOT change the meaning of rules. Typical uses of aliases are to represent code systems and canonical URLs.</p>

<p>Alias definitions follow this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias: {Alias name} = {url or urn:oid or urn:uuid}
</code></pre></div></div>

<p>Several things to note about aliases:</p>

<ul>
  <li>Aliases SHALL NOT include additional keywords or rules.</li>
  <li>Aliases SHALL NOT be used as variables for arbitrary strings or names.</li>
  <li>OIDs and UUIDs SHALL be specified using the <code class="language-plaintext highlighter-rouge">urn:oid</code> or <code class="language-plaintext highlighter-rouge">urn:uuid</code> schemes.</li>
  <li>Alias statements stand alone, and SHALL NOT be mixed into rule sets of other items.</li>
  <li>Aliases SHALL only be substituted where a full uri value is expected (e.g., they cannot be placed in the middle of a string or used to construct a larger url).</li>
  <li>Aliases SHALL be global within a FSH project.</li>
</ul>

<p>In contrast with other names in FSH (for profiles, extensions, etc.), alias names MAY optionally begin with a dollar sign (<code class="language-plaintext highlighter-rouge">$</code>). If you define an alias with a leading <code class="language-plaintext highlighter-rouge">$</code>, implementations can more easily check for misspellings. For example, if you choose the alias name <code class="language-plaintext highlighter-rouge">$RaceAndEthnicity</code> and accidentally type <code class="language-plaintext highlighter-rouge">$RaceEthnicity</code>, implementations can easily detect there is no alias by that name. Without the <code class="language-plaintext highlighter-rouge">$</code> sign, implementations are forced to look through FHIR Core and all external implementation guides for anything with that name or id, or in some contexts, assume it is a new item, with unpredictable results.</p>

<p><strong>Examples:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Alias: $SCT = http://snomed.info/sct
 
  Alias: $RaceAndEthnicityCDC = urn:oid:2.16.840.1.113883.6.238
 
  Alias: obs-cat = http://terminology.hl7.org/CodeSystem/observation-category
</code></pre></div></div>

<h4 id="defining-code-systems">Defining Code Systems</h4>

<p>It is sometimes necessary to define new codes inside an IG that are not drawn from an external code system (aka <em>local codes</em>). Local codes MUST be defined in the context of a code system.</p>

<blockquote>
  <p><strong>Note:</strong> Defining local codes is not best practice, since those codes will not be part of recognized terminology systems. However, when existing vocabularies do not contain necessary codes, it might be necessary to define them – at least temporarily – as local codes.</p>
</blockquote>

<p>Creating a code system uses the REQUIRED declaration <code class="language-plaintext highlighter-rouge">CodeSystem</code> and RECOMMENDED keywords <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code> and <code class="language-plaintext highlighter-rouge">Description</code>. Code system metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>). Codes SHOULD then be added, one per rule, using the following syntax:</p>

<pre><code>* #{code} "{display string}" <span class="optional">"{definition string}"</span></code></pre>

<p>Rule types that apply to CodeSystems are: <a href="#assignment-rules">Assignment</a>, <a href="#insert-rules">Insert</a>, and <a href="#local-code-rules">Local Code</a>. Assignment rules SHALL be applicable to code systems only in the context of caret paths.</p>

<p><strong>Notes:</strong></p>

<ul>
  <li>There MUST NOT be a code system before the hash sign <code class="language-plaintext highlighter-rouge">#</code>. The code system name is given by the <code class="language-plaintext highlighter-rouge">CodeSystem</code> declaration.</li>
  <li>The definition of the term, provided as the second string following the code, is RECOMMENDED but not REQUIRED.</li>
  <li>Do not use the word <code class="language-plaintext highlighter-rouge">include</code> in a code system rule. The rule is creating a brand new code, not including an existing code defined elsewhere.</li>
  <li>Metadata attributes for individual concepts, such as <code class="language-plaintext highlighter-rouge">designation</code>, MAY be defined using <a href="#caret-paths">caret paths</a>.</li>
  <li><a href="#assignment-rules">Assignment rules</a> SHALL apply only to caret paths in CodeSystems.</li>
</ul>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a code system for yoga poses:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CodeSystem:  YogaCS
Id: yoga-code-system
Title: "Yoga Code System"
Description:  "A brief vocabulary of yoga-related terms."
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* #Sirsasana "Headstand"
    "An pose that involves standing on one's head."
* #Halasana "Plough Pose"
    "A pose from supine position, bringing legs up and over until the toes touch the ground behind the head."
* #Matsyasana "Fish Pose"
    "A pose from supine position, arching the back and pressing the chest upwards."
* #Bhujangasana "Cobra Pose"
    "A pose starting from prone position with hands pushing the shoulders upward, with legs and hips remaining on the ground."
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="defining-code-systems-with-hierarchical-codes">Defining Code Systems with Hierarchical Codes</h5>

<p>Child codes MAY also be defined, resulting in a hierarchical structure of codes within a code system. To define such codes, authors MUST list all of the preceding codes in the hierarchy before the new code or use indented child codes. To list the preceding codes in the hierarchy, use the following syntax:</p>

<pre><code>* #{parent code} "{display string}" <span class="optional">"{definition string}"</span>
* #{parent code} #{child code} "{display string}" <span class="optional">"{definition string}"</span>
</code></pre>

<p>To specify hierarchy using indentation, indent (by two spaces per level) child code definitions after their parent's code definition:</p>

<pre><code>* #{parent code} "{display string}" <span class="optional">"{definition string}"</span>
  * #{child code} "{display string}" <span class="optional">"{definition string}"</span>
</code></pre>

<p>Additional levels to any depth SHALL be added in the same manner.</p>

<blockquote>
  <p><strong>Note:</strong> When defining hierarchical codes, parent codes MUST be defined before their children.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>Define a code system for anteater taxonomy with hierarchical codes:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  CodeSystem: AnteaterCS
  Id: anteater-code-system
  Title: "Anteater Code System"
  Description: "A code system for anteater taxonomy with hierarchical codes"
  * #Anteater "Anteater" "Members of suborder Vermilingua, distinguished by its propensity to eat ants"
  * #Anteater #Tamandua "Members of genus Tamandua" "The Tamandua genus of anteaters, mainly found in forests and grasslands"
  * #Anteater #Tamandua #NorthernTamandua "Northern Tamandua" "The northern species of Tamandua anteaters"
  * #Anteater #Tamandua #SouthernTamandua "Southern Tamandua" "The southern species of Tamandua anteaters"
  * #Anteater #GiantAnteater "Giant Anteater" "The Giant Anteater, typically 6 - 7 feet in length"
</code></pre></div></div>

<ul>
  <li>Define the same code system using indentation instead of explicit parents:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  CodeSystem: AnteaterCS
  Id: anteater-code-system
  Title: "Anteater Code System"
  Description: "A code system for anteater taxonomy with hierarchical codes"
  * #Anteater "Anteater" "Members of suborder Vermilingua, distinguished by its propensity to eat ants"
    * #Tamandua "Members of genus Tamandua" "The Tamandua genus of anteaters, mainly found in forests and grasslands"
      * #NorthernTamandua "Northern Tamandua" "The northern species of Tamandua anteaters"
      * #SouthernTamandua "Southern Tamandua" "The southern species of Tamandua anteaters"
    * #GiantAnteater "Giant Anteater" "The Giant Anteater, typically 6 - 7 feet in length"
</code></pre></div></div>

<h5 id="code-metadata">Code Metadata</h5>

<p>Within a CodeSystem definition, the caret syntax MAY be used to set metadata attributes for individual concepts (e.g., elements of <code class="language-plaintext highlighter-rouge">CodeSystem.concept.designation</code> and <code class="language-plaintext highlighter-rouge">CodeSystem.concept.property</code>).</p>

<p>For a path to a code within a code system, use this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#{code} ^&lt;element of corresponding concept&gt;
</code></pre></div></div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>To set the <code class="language-plaintext highlighter-rouge">designation.use</code> of the code <code class="language-plaintext highlighter-rouge">#active</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* #active ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
</code></pre></div>    </div>
  </li>
  <li>
    <p>The path to the property code of <code class="language-plaintext highlighter-rouge">#recurrence</code> code, a child of the <code class="language-plaintext highlighter-rouge">#active</code> code:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#active #recurrence ^property[0].code
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="defining-extensions">Defining Extensions</h4>

<p>To define an extension, the declaration <code class="language-plaintext highlighter-rouge">Extension</code> is REQUIRED, the keywords <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code>, and <code class="language-plaintext highlighter-rouge">Description</code> are RECOMMENDED, and <code class="language-plaintext highlighter-rouge">Parent</code> is OPTIONAL. Extensions MAY also inherit from other extensions, but if the <code class="language-plaintext highlighter-rouge">Parent</code> keyword is omitted, the parent SHALL be assumed to be FHIR's <a href="https://hl7.org/fhir/R5/extensibility.html#extension">Extension element</a>. Extension metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>).</p>

<p>An extension MAY have either a value (i.e. a <code class="language-plaintext highlighter-rouge">value[x]</code> element) or sub-extensions, but MUST NOT have both. To create a simple extension, the <code class="language-plaintext highlighter-rouge">value[x]</code> element SHOULD be constrained. To create a complex extension, the <code class="language-plaintext highlighter-rouge">extension</code> array of the extension MUST be sliced (see <a href="#contains-rules-for-extensions">Contains Rules for Extensions</a>).</p>

<p>Since simple and complex extensions are mutually-exclusive, FSH implementations SHOULD set the <code class="language-plaintext highlighter-rouge">value[x]</code> cardinality to 0..0 if sub-extensions are specified, set <code class="language-plaintext highlighter-rouge">extension</code> cardinality to 0..0 if constraints are applied to <code class="language-plaintext highlighter-rouge">value[x]</code>, and signal an error if <code class="language-plaintext highlighter-rouge">value[x]</code> and sub-extensions are simultaneously specified.</p>

<p>To indicate that an extension is a <a href="https://hl7.org/fhir/R5/extensibility.html#modifierExtension">modifier extension</a>, authors MUST set the <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#ElementDefinition.isModifier">isModifier</a> flag to <code class="language-plaintext highlighter-rouge">true</code> on the extension's root element. In addition, the root element's <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#ElementDefinition.isModifierReason">isModifierReason</a> MUST also be provided. This is in accordance with FHIR's <a href="https://hl7.org/fhir/R5/extensibility.html#modifierExtension">modifier extension requirements</a> and <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#ElementDefinition.isModifier">eld-18</a> invariant. FSH authors can achieve this via rules like the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* . ?!     // alternate syntax: . ^isModifier = true
* . ^isModifierReason = "Reason for flagging as a modifier"
</code></pre></div></div>

<p>Rules types that apply to Extensions are: <a href="#assignment-rules">Assignment</a>, <a href="#binding-rules">Binding</a>, <a href="#cardinality-rules">Cardinality</a>, <a href="#contains-rules-for-extensions">Contains (standalone extensions)</a>, <a href="#contains-rules-for-extensions">Contains (inline extensions)</a>, <a href="#contains-rules-for-slicing">Contains (slicing)</a>, <a href="#flag-rules">Flag</a>, <a href="#insert-rules">Insert</a>, <a href="#obeys-rules">Obeys</a>, <a href="#path-rules">Path</a>, and <a href="#type-rules">Type</a>.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>How the <a href="https://hl7.org/fhir/us/core/StructureDefinition-us-core-birthsex.html">US Core BirthSex extension</a> (a simple extension) would be defined in FSH:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: USCoreBirthSexExtension
Id:   us-core-birthsex
Title:  "US Core Birth Sex Extension"
Description: "A code classifying the person's sex assigned at birth as specified by the [Office of the National Coordinator for Health IT (ONC)](https://www.healthit.gov/newsroom/about-onc). This extension aligns with the C-CDA Birth Sex Observation (LOINC 76689-9)."
Context: Patient
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* value[x] only code
* value[x] from http://hl7.org/fhir/us/core/ValueSet/birthsex (required)
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> The use of the <code class="language-plaintext highlighter-rouge">Context</code> keyword in the example above is <span class="tuIcon" title="Standards Status = Trial Use">TU</span>.</p>
</blockquote>

<ul>
  <li>
    <p>How the FHIR <a href="https://hl7.org/fhir/extensions/StructureDefinition-request-doNotPerform.html">Do Not Perform modifier extension</a> would be defined in FSH:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: DoNotPerform
Id: request-doNotPerform
Title: "Do not perform"
Description: "If true indicates that the request is asking for the specified action to not occur."
Context: NutritionOrder
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* . 0..1 ?!
* . ^isModifierReason = "If true this element negates the specified action. For Example, instead of a request for a procedure, it is a request for the procedure to not occur."
* value[x] 1..
* value[x] only boolean
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> The use of the <code class="language-plaintext highlighter-rouge">Context</code> keyword in the example above is <span class="tuIcon" title="Standards Status = Trial Use">TU</span>.</p>
</blockquote>

<ul>
  <li>
    <p>How <a href="https://hl7.org/fhir/us/core/StructureDefinition-us-core-ethnicity.html">US Core Ethnicity extension</a> (a complex extension with inline sub-extensions) would be defined in FSH:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension:      USCoreEthnicityExtension
Id:             us-core-ethnicity
Title:          "US Core Ethnicity Extension"
Description:    "Concepts classifying the person into a named category of humans sharing common history, traits, geographical origin or nationality. The ethnicity codes used to represent these concepts are based upon the [CDC ethnicity and Ethnicity Code Set Version 1.0](http://www.cdc.gov/phin/resources/vocabulary/index.html) which includes over 900 concepts for representing race and ethnicity of which 43 reference ethnicity.  The ethnicity concepts are grouped by and pre-mapped to the 2 OMB ethnicity categories: - Hispanic or Latino - Not Hispanic or Latino."
Context: Patient, RelatedPerson, Person, Practitioner, FamilyMemberHistory
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* extension contains
    ombCategory 0..1 MS and
    detailed 0..* and
    text 1..1 MS
* extension[ombCategory] ^short = "Hispanic or Latino|Not Hispanic or Latino"
* extension[ombCategory].value[x] only Coding
* extension[ombCategory].value[x] from OmbEthnicityCategories (required) // OmbEthnicityCategories is a value set defined by US Core
* extension[detailed] ^short = "Extended ethnicity codes"
* extension[detailed].value[x] only Coding
* extension[detailed].value[x] from DetailedEthnicity (required) // DetailedEthnicity is defined in US Core
* extension[text] ^short = "Ethnicity text"
* extension[text].value[x] only string
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> The use of the <code class="language-plaintext highlighter-rouge">Context</code> keyword in the example above is <span class="tuIcon" title="Standards Status = Trial Use">TU</span>.</p>
</blockquote>

<ul>
  <li>
    <p>Define an extension with an explicit parent, constraining the US Core Birth Sex extension for US states that do not recognize non-binary birth sex:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension:      BinaryBirthSexExtension
Parent:         USCoreBirthSexExtension
Id:             binary-birthsex
Title:          "Binary Birth Sex Extension"
Description:    "As of 2019, certain US states only allow M or F on birth certificates."
* value[x] from BinaryBirthSexValueSet (required)
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>The keyword <code class="language-plaintext highlighter-rouge">Context</code> SHOULD be used to specify the <a href="https://hl7.org/fhir/R5/defining-extensions.html#context">context</a> of an Extension. When specifying a <code class="language-plaintext highlighter-rouge">fhirpath</code> context, the value MUST be a quoted string. When specifying an <code class="language-plaintext highlighter-rouge">element</code> or <code class="language-plaintext highlighter-rouge">extension</code> context, the value MUST start with the name, id, or URL of the context item. A name or id MAY be followed by a dot (<code class="language-plaintext highlighter-rouge">.</code>) and a valid <a href="#fsh-paths">FSH path</a>. A URL MAY be followed by a hash sign (<code class="language-plaintext highlighter-rouge">#</code>) and a valid <a href="#fsh-paths">FSH path</a>.</p>

  <p>Multiple contexts MAY be specified by using a comma-separated list. Using the <code class="language-plaintext highlighter-rouge">Context</code> keyword instead of using caret rules to assign directly to the <code class="language-plaintext highlighter-rouge">context</code> list on the Extension is RECOMMENDED. The following is a list of allowed formats for contexts:</p>

  <p>Specifying a <code class="language-plaintext highlighter-rouge">fhirpath</code> context:</p>
  <pre><code>Context: "{fhirpath expression}"</code></pre>

  <p>Specifying an <code class="language-plaintext highlighter-rouge">element</code> or <code class="language-plaintext highlighter-rouge">extension</code> context using a StructureDefinition's name or id:</p>
  <pre><code>Context: {StructureDefinition name or id}<span class="optional">.{FSH path}</span></code></pre>

  <p>Specifying an <code class="language-plaintext highlighter-rouge">element</code> or <code class="language-plaintext highlighter-rouge">extension</code> context for using a StructureDefinition's URL:</p>
  <pre><code>Context: {StructureDefinition url}<span class="optional">#{FSH path}</span></code></pre>
  <p>An alias MAY be used in place of the URL.</p>

  <p>Specifying multiple contexts as a comma-separated list:</p>
  <pre><code>Context: {context 1}<span class="optional">, {context 2}, {context 3}...</span></code></pre>

  <p><strong>Examples:</strong></p>

  <ul>
    <li>
      <p>Defining an extension with a <code class="language-plaintext highlighter-rouge">fhirpath</code> context</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: "(Condition | Observation).code"
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">element</code> context on a core FHIR resource</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: Patient
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">element</code> context on a specific element in a core FHIR resource</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: Patient.contact.telecom
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">element</code> context on a specific element in a Profile defined in FSH</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: MyPatient
Parent: Patient
// rules on the Profile omitted

Extension: MyExtension
Context: MyPatient.contact.telecom
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">element</code> context that references an element whose path includes a slice. Note that the path uses square brackets to refer to a slice.</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: USCoreCarePlanProfile.category[AssessPlan].coding
// You can also use the id or the URL
// Context: us-core-careplan.category[AssessPlan].coding
// Context: http://hl7.org/fhir/us/core/StructureDefinition/us-core-careplan#category[AssessPlan].coding
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">extension</code> context</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: http://hl7.org/fhir/StructureDefinition/capabilitystatement-search-parameter-combination
// The extension could also be referenced by name or id:
// Context: CSSearchParameterCombination
// Context: capabilitystatement-search-parameter-combination
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">extension</code> context that is part of a complex extension, referencing the extension by name or id</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: CSSearchParameterCombination.extension[required]
// Using the id also works:
// Context: capabilitystatement-search-parameter-combination.extension[required]
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">extension</code> context that is part of a complex extension, referencing the extension by url</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Extension: MyExtension
Context: http://hl7.org/fhir/StructureDefinition/capabilitystatement-search-parameter-combination#extension[required]
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining an extension with an <code class="language-plaintext highlighter-rouge">extension</code> context by using an alias:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias: $COMBINATION = http://hl7.org/fhir/StructureDefinition/capabilitystatement-search-parameter-combination
  
Extension: MyExtension
Context: $COMBINATION#extension[required]
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining multiple contexts and using an alias:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias: $COMBINATION = http://hl7.org/fhir/StructureDefinition/capabilitystatement-search-parameter-combination
  
Extension: MyExtension
Context: $COMBINATION#extension[required], $COMBINATION#extension[optional], "(Condition | Observation).code"
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<h4 id="defining-instances">Defining Instances</h4>

<p>Instances are defined using the REQUIRED declaration <code class="language-plaintext highlighter-rouge">Instance</code>, with the REQUIRED keyword <code class="language-plaintext highlighter-rouge">InstanceOf</code>, RECOMMENDED keywords <code class="language-plaintext highlighter-rouge">Title</code> and <code class="language-plaintext highlighter-rouge">Description</code>, and OPTIONAL keyword <code class="language-plaintext highlighter-rouge">Usage</code>. <code class="language-plaintext highlighter-rouge">InstanceOf</code> plays a role analogous to the <code class="language-plaintext highlighter-rouge">Parent</code> of a profile. The value of <code class="language-plaintext highlighter-rouge">InstanceOf</code> MUST be the name, id, or url for any profile, resource, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> logical model</span>, or complex datatype defined internally or externally.</p>

<p>The <code class="language-plaintext highlighter-rouge">Usage</code> keyword specifies how the instance should be presented in the IG:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Usage: #example</code> (default) means the instance is intended as an illustration of a profile or <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> logical model</span>, and SHOULD be presented as an example for the corresponding entity.</li>
  <li><code class="language-plaintext highlighter-rouge">Usage: #definition</code> means the instance is a formal item (i.e., not an example) in the IG, such as an instance of a search parameter, operation definition, or questionnaire. These items SHOULD be presented on their own IG page.</li>
  <li><code class="language-plaintext highlighter-rouge">Usage: #inline</code> means the instance MUST NOT be instantiated as an independent resource, but MAY appear as part of another instance (for example, in any <a href="https://hl7.org/fhir/R5/domainresource.html">DomainResource</a> in the <code class="language-plaintext highlighter-rouge">contained</code> array, or in a <a href="https://hl7.org/fhir/R5/bundle.html">Bundle</a> in the <code class="language-plaintext highlighter-rouge">entry.resource</code> array).</li>
</ul>

<p>Instances inherit assigned values from their StructureDefinition (i.e. assigned codes, assigned booleans) if those values are required. Assignment rules are used to set additional values.</p>

<p>Rule types that apply to Instances are: <a href="#assignment-rules">Assignment</a>, <a href="#insert-rules">Insert</a>, and <a href="#path-rules">Path</a>. No other rule types are allowed.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Define an example instance of US Core Patient, with name, date of birth, race, and ethnicity:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance:  EveAnyperson
InstanceOf: http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient
Title:   "Eve Anyperson"
Usage:  #example
* name.given = "Eve"
* name.family = "Anyperson"
* birthDate = 1960-04-25
* extension[us-core-race].extension[ombCategory].valueCoding = RaceAndEthnicityCDC#2106-3 "White"
* extension[us-core-ethnicity].extension[ombCategory].valueCoding = RaceAndEthnicityCDC#2186-5 "Non Hispanic or Latino"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Define an instance of US Core Practitioner, with name and NPI, meant to be inlined in a composition:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance:   DrDavidAnydoc
InstanceOf: http://hl7.org/fhir/us/core/StructureDefinition/us-core-practitioner
Usage:  #inline
* name.family = "Anydoc"
* name.given = "David"
* name.suffix = "MD"
* identifier[NPI].value = "8274017284"
</code></pre></div>    </div>

    <p>This instance would be incorporated into a DomainResource with a statement such as:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*  contained[0] = DrDavidAnydoc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Define an <code class="language-plaintext highlighter-rouge">#inline</code> Patient instance, and then use that instance in a Condition resource, inlining it as a contained resource:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: EveAnyperson
InstanceOf: Patient
Usage: #inline // #inline means this instance MUST NOT be exported as a separate example
* name.given[0] = "Eve"
* name.family = "Anyperson"

Instance: EvesCondition
InstanceOf: Condition
Usage: #example
Description: "An example that uses contained"
* contained[0] = EveAnyperson // this inlines EveAnyperson definition here
* code = http://foo.org#bar
* subject = Reference(EveAnyperson) // this automatically creates the relative reference correctly
</code></pre></div>    </div>
    <p>This results in:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Condition"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EvesCondition"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"contained"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Patient"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EveAnyperson"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"given"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"Eve"</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"family"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Anyperson"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"coding"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://foo.org"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"subject"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"reference"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#EveAnyperson"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Define an instance of PrimaryCancerCondition, using many available features:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: mCODEPrimaryCancerConditionExample01
InstanceOf: PrimaryCancerCondition
Description: "mCODE Example for Primary Cancer Condition"
Usage: #example
* id = "mCODEPrimaryCancerConditionExample01"
* clinicalStatus = $ClinStatus#active "Active"
* verificationStatus = $VerStatus#confirmed "Confirmed"
* code = $SCT#254637007 "Non-small cell lung cancer (disorder)"
* extension[HistologyMorphologyBehavior].valueCodeableConcept = $SCT#35917007 "Adenocarcinoma"
* bodySite = $SCT#39607008 "Lung structure (body structure)"
* bodySite.extension[Laterality].valueCodeableConcept = $SCT#7771000 "Left (qualifier value)"
* subject = Reference(mCODEPatientExample01)
* onsetDateTime = "2019-04-01"
* asserter = Reference(mCODEPractitionerExample01)
* stage.summary = $AJCC#3C "IIIC"
* stage.assessment = Reference(mCODETNMClinicalStageGroupExample01)
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="defining-instances-of-other-conformance-resources">Defining Instances of Other Conformance Resources</h5>

<p>The FSH language is designed to support creation of StructureDefinitions for Profiles, Extensions, Resources, and Logicals; ValueSets; and CodeSystems. FSH implementations MAY additionally create an IG's <a href="https://hl7.org/fhir/R5/implementationguide.html">ImplementationGuide</a> resource based on project-specific configuration data and other information. There are other <a href="https://hl7.org/fhir/R5/conformance-module.html">conformance resources</a> involved with IG creation, however, that are not explicitly supported by specific FSH item types. These include <a href="https://hl7.org/fhir/R5/capabilitystatement.html">CapabilityStatement</a>, <a href="https://hl7.org/fhir/R5/operationdefinition.html">OperationDefinition</a>, <a href="https://hl7.org/fhir/R5/searchparameter.html">SearchParameter</a>, and <a href="https://hl7.org/fhir/R5/compartmentdefinition.html">CompartmentDefinition</a>.</p>

<p>These conformance resources MAY be created using FSH instance grammar. For example, to create a CapabilityStatement, use <code class="language-plaintext highlighter-rouge">InstanceOf: CapabilityStatement</code> with <code class="language-plaintext highlighter-rouge">Usage: #definition</code>. The CapabilityStatement is populated using assignment statements. Authors may choose to use <a href="#parameterized-rule-sets">parameterized rule sets</a> to reduce repetition of common patterns in conformance resources.</p>

<h4 id="defining-invariants">Defining Invariants</h4>

<p>Invariants are defined using the REQUIRED declaration <code class="language-plaintext highlighter-rouge">Invariant</code>, RECOMMENDED keyword <code class="language-plaintext highlighter-rouge">Description</code><sup>1</sup>, and OPTIONAL keywords <code class="language-plaintext highlighter-rouge">Severity</code><sup>2</sup>, <code class="language-plaintext highlighter-rouge">XPath</code> (FHIR R4 only) and  <code class="language-plaintext highlighter-rouge">Expression</code>. The keywords correspond directly to elements in <code class="language-plaintext highlighter-rouge">ElementDefinition.constraint</code>, as shown in the table below. Invariants are incorporated into profiles, extensions, logical models, or resources via <a href="#obeys-rules">obeys rules</a>.</p>

<p><span class="caption" id="t8">Table 8. Keywords used to define Invariants</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Keyword</th>
      <th>Usage</th>
      <th>Corresponding element in <br /> ElementDefinition.constraint</th>
      <th>Data Type</th>
      <th>Required</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Invariant</td>
      <td>Identifier for the invariant</td>
      <td>key</td>
      <td>id</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Description</td>
      <td>Human description of constraint</td>
      <td>human</td>
      <td>string</td>
      <td>no<sup>1</sup></td>
    </tr>
    <tr>
      <td>Expression</td>
      <td>FHIRPath expression of constraint</td>
      <td>expression</td>
      <td>FHIRPath string</td>
      <td>no</td>
    </tr>
    <tr>
      <td>Severity</td>
      <td>Either #error or #warning, as defined in <a href="https://hl7.org/fhir/R5/valueset-constraint-severity.html">ConstraintSeverity</a></td>
      <td>severity</td>
      <td>code</td>
      <td>no<sup>2</sup></td>
    </tr>
    <tr>
      <td>XPath</td>
      <td>XPath expression of constraint <em>(Note: FHIR R5 no longer supports XPath)</em></td>
      <td>xpath</td>
      <td>XPath string</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>Rule types that apply to defining Invariants are: <a href="#assignment-rules">Assignment</a>, <a href="#path-rules">Path</a>, and <a href="#insert-rules">Insert</a>. Paths in Invariant assignment rules refer to elements within <code class="language-plaintext highlighter-rouge">ElementDefinition.constraint</code> (e.g., <code class="language-plaintext highlighter-rouge">severity</code> refers to <code class="language-plaintext highlighter-rouge">ElementDefinition.constraint.severity</code>). Assignment rules are particularly useful for specifying constraint extensions such as the <a href="https://hl7.org/fhir/extensions/StructureDefinition-elementdefinition-bestpractice.html">Best Practice</a> extension.</p>

  <p><sup>1</sup> If the <code class="language-plaintext highlighter-rouge">Description</code> keyword is not specified, then the definition MUST contain an assignment rule for the <code class="language-plaintext highlighter-rouge">human</code> element.
<br />
<sup>2</sup> If the <code class="language-plaintext highlighter-rouge">Severity</code> keyword is not specified, then the definition MUST contain an assignment rule for the <code class="language-plaintext highlighter-rouge">severity</code> element.</p>
</div>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a simplified version of an invariant found in US Core (for FHIR R4) using FSH Invariant keywords only:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invariant:   us-core-6
Description: "Patient.name.given or Patient.name.family or both SHALL be present"
Severity:    #error
Expression:  "family.exists() or given.exists()"
XPath:       "f:given or f:family"
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Define a simplified version of an invariant found in US Core (for FHIR R4) using FSH Invariant keywords and rules:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invariant:   us-core-6
Description: "Patient.name.given or Patient.name.family or both SHALL be present"
* severity = #error
* expression = "family.exists() or given.exists()"
* xpath = "f:given or f:family"
</code></pre></div>      </div>
    </li>
  </ul>
</div>

<h4 id="defining-logical-models">Defining Logical Models</h4>

<p>Logical models allow authors to define new structures representing arbitrary content. While profiles can only add new properties as formal extensions, logical models add properties as standard elements with standard paths. Logical models have many uses, <a href="https://hl7.org/fhir/R5/structuredefinition.html#logical">as described in the FHIR specification</a>, but are often used to convey domain-specific concepts in a user-friendly manner. Authors often use logical models as a basis for defining formal profiles in FHIR.</p>

<p>Logical models are defined using the REQUIRED declaration <code class="language-plaintext highlighter-rouge">Logical</code>, with RECOMMENDED keywords <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code>, and <code class="language-plaintext highlighter-rouge">Description</code>, and OPTIONAL keyword <code class="language-plaintext highlighter-rouge">Parent</code>. If no <code class="language-plaintext highlighter-rouge">Parent</code> is specified, the empty <a href="https://hl7.org/fhir/R5/types.html#Base">Base</a> type SHALL be assumed as the default parent. Note that the Base type does not exist in FHIR R4, but both SUSHI and the FHIR IG Publisher have implemented special case logic to support Base in FHIR R4. Authors who wish to have top-level <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">extension</code> elements MAY use <a href="https://hl7.org/fhir/R5/types.html#Element">Element</a> as the logical model's parent instead (when appropriate, based on the definition of Element). Alternately, authors MAY specify another logical model, a resource, or a complex datatype as a logical model's parent. Logical model metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>).</p>

<p>Rules defining the logical model follow immediately after the keyword section. Rule types that apply to Logicals are: <a href="#add-element-rules">Add Element</a>, <a href="#assignment-rules">Assignment</a>, <a href="#binding-rules">Binding</a>, <a href="#cardinality-rules">Cardinality</a>, <a href="#flag-rules">Flag</a>, <a href="#insert-rules">Insert</a>, <a href="#obeys-rules">Obeys</a>, <a href="#path-rules">Path</a>, and <a href="#type-rules">Type</a>. Flag rules SHALL NOT include <code class="language-plaintext highlighter-rouge">MS</code> flags.</p>

<p>In addition, authors SHOULD consult FHIR's <a href="https://hl7.org/fhir/R5/elementdefinition.html#interpretation">interpretation of ElementDefinition for type definitions</a>. Assignments MUST NOT set elements listed as prohibited in that table. For example, the table indicates that assigning <code class="language-plaintext highlighter-rouge">maxLength</code> and <code class="language-plaintext highlighter-rouge">mustSupport</code> is prohibited.</p>

<blockquote>
  <p><strong>Note:</strong> Prior versions of FHIR Shorthand forbid logical model definitions from constraining inherited elements or using assignment rules to fix element values. These capabilities MAY now be used as <span class="tuIcon" title="Standards Status = Trial Use">TU</span> features of FSH.</p>
</blockquote>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a logical model for a human and their family members:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Logical:         Human
Id:              human-being-logical-model
Title:           "Human Being"
Description:     "A member of the Homo sapiens species."
Characteristics: #can-be-target
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* name 0..* SU HumanName "Name(s) of the human" "The names by which the human is or has been known"
* birthDate 0..1 SU dateTime "The date of birth, if known"
    "The date on which the person was born. Approximations may be used if exact date is unknown."
* deceased[x] 0..1 SU boolean or dateTime or Age "Indication if the human is deceased"
    "An indication if the human has died. Boolean should not be used if date or age at death are known."
* family 0..1 BackboneElement "Family" "Members of the human's immediate family."
  * mother 0..2 FamilyMember "Mother" "Biological mother, current adoptive mother, or both."
  * father 0..2 FamilyMember "Father" "Biological father, current adoptive father, or both."
  * sibling 0..* FamilyMember "Sibling" "Other children of the human's mother and/or father."

Logical:        FamilyMember
Id:             family-member
Title:          "Family Member"
Description:    "A reference to a family member (not necessarily biologically related)."
* human 1..1 SU Reference(Human) "Family member" "A reference to the human family member"
* biological 0..1 boolean "Biologically related?"
    "A family member may not be biologically related due to adoption, blended families, etc."
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> The use of the <code class="language-plaintext highlighter-rouge">Characteristics</code> keyword in the example above is <span class="tuIcon" title="Standards Status = Trial Use">TU</span>.</p>
</blockquote>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>The keyword <code class="language-plaintext highlighter-rouge">Characteristics</code> MAY be used to specify the type characteristics of the logical model being defined. FSH implementations SHOULD represent these characteristics on the logical model using the <a href="https://hl7.org/fhir/extensions/StructureDefinition-structuredefinition-type-characteristics.html">Structure Type Characteristics extension</a> with a code value from the <a href="https://hl7.org/fhir/extensions/ValueSet-type-characteristics-code.html">TypeCharacteristicCodes value set</a>. Authors SHOULD use the <code class="language-plaintext highlighter-rouge">Characteristics</code> keyword instead of directly assigning this extension using assignment rules.</p>

  <p>When specifying characteristics using the <code class="language-plaintext highlighter-rouge">Characteristics</code> keyword, authors MUST NOT include the code system, as it is implied. Multiple characteristics SHALL be specified by using a comma-separated list of codes. The following is an allowed list of formats for characteristics:</p>

  <p>Specifying a single characteristic:</p>
  <pre><code>Characteristics: {code}</code></pre>

  <p>Specifying multiple characteristics as a comma-separated list:</p>
  <pre><code>Characteristics: {code 1}<span class="optional">, {code 2}, {code 3}...</span></code></pre>

  <p><strong>Examples:</strong></p>

  <ul>
    <li>
      <p>Defining a logical model with a single type characteristic</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Logical: MyLogical
Characteristics: #can-bind
</code></pre></div>      </div>
    </li>
    <li>
      <p>Defining a logical model with multiple type characteristics</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Logical: MyLogical
Characteristics: #has-range, #has-units, #is-continuous
</code></pre></div>      </div>
    </li>
  </ul>
</div>

<h4 id="defining-mappings">Defining Mappings</h4>

<p><a href="https://hl7.org/fhir/R5/mappings.html">Mappings</a> are an OPTIONAL part of a StructureDefinition, intended to help implementers understand the StructureDefinition in relation to other standards. While it is possible to define mappings using escape (caret) syntax, FSH provides a more concise approach. These mappings are informative and are not to be confused with the computable mappings provided by <a href="https://hl7.org/fhir/R5/mapping-language.html">FHIR Mapping Language</a> and the <a href="https://hl7.org/fhir/R5/structuremap.html">StructureMap resource</a>.</p>

<p>To create a mapping, the declaration <code class="language-plaintext highlighter-rouge">Mapping</code> and the keywords <code class="language-plaintext highlighter-rouge">Source</code> and <code class="language-plaintext highlighter-rouge">Target</code> are REQUIRED, and <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code> and <code class="language-plaintext highlighter-rouge">Description</code> are RECOMMENDED.</p>

<p><span class="caption" id="t9">Table 9. Keywords used to define Mappings</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Keyword</th>
      <th>Usage</th>
      <th>StructureDefinition element</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mapping</td>
      <td>Appears first and provides a unique name for the mapping</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>Source</td>
      <td>The name or id of the profile the mapping applies to</td>
      <td>n/a</td>
    </tr>
    <tr>
      <td>Target</td>
      <td>The URL, URI, or OID for the specification being mapped to</td>
      <td>mapping.uri</td>
    </tr>
    <tr>
      <td>Id</td>
      <td>An internal identifier for the target specification</td>
      <td>mapping.identity</td>
    </tr>
    <tr>
      <td>Title</td>
      <td>A human-readable name for the target specification</td>
      <td>mapping.name</td>
    </tr>
    <tr>
      <td>Description</td>
      <td>Additional information such as version notes, issues, or scope limitations.</td>
      <td>mapping.comment</td>
    </tr>
  </tbody>
</table>

<p>The mappings themselves are declared in rules with the following syntaxes:</p>

<pre><code>* -&gt; "{map string}" <span class="optional">"{comment string}" #{mime-type code}</span>

* &lt;element&gt; -&gt; "{map string}" <span class="optional">"{comment string}" #{mime-type code}</span>
</code></pre>

<p>A rule starting with the characters <code class="language-plaintext highlighter-rouge">-&gt;</code> SHALL map the profile as a whole to a target. A rule starting with an element followed by the characters <code class="language-plaintext highlighter-rouge">-&gt;</code> SHALL map a specific element within the source to a target. The <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">comment</code>, and <code class="language-plaintext highlighter-rouge">mime-type</code> are as defined in FHIR and correspond to elements in <a href="https://hl7.org/fhir/structuredefinition.html">StructureDefinition.mapping</a> and <a href="https://hl7.org/fhir/R5/elementdefinition.html">ElementDefinition.mapping</a> (<code class="language-plaintext highlighter-rouge">map</code> corresponds to <code class="language-plaintext highlighter-rouge">mapping.map</code>, <code class="language-plaintext highlighter-rouge">mime-type</code> to <code class="language-plaintext highlighter-rouge">mapping.language</code>, and <code class="language-plaintext highlighter-rouge">comment</code> to <code class="language-plaintext highlighter-rouge">mapping.comment</code>). The mime type code MUST come from FHIR's <a href="https://hl7.org/fhir/R5/valueset-mimetypes.html">MimeType value set</a>. For further information, refer to the FHIR definitions of these elements.</p>

<blockquote>
  <p><strong>Note:</strong> Unlike setting the <code class="language-plaintext highlighter-rouge">mapping.map</code> directly in the StructureDefinition, mapping rules within a Mapping item MUST NOT include the name of the resource in the path on the left hand side.</p>
</blockquote>

<p>Rule types that apply to Mappings are: <a href="#insert-rules">Insert</a>, <a href="#mapping-rules">Mapping</a>, and <a href="#path-rules">Path</a>.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Map the entire profile to a Patient item in another specification:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* -&gt; "Patient" "This profile maps to Patient in Argonaut"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Map the <code class="language-plaintext highlighter-rouge">identifier.value</code> element from one IG to another:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* identifier.value -&gt; "Patient.identifier.value"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Define a map between USCorePatient and Argonaut:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mapping:  USCorePatientToArgonaut
Source:   USCorePatient
Target:   "http://unknown.org/Argonaut-DQ-DSTU2"
Id:       argonaut-dq-dstu2
Title:    "Argonaut DSTU2"
* -&gt; "Patient"
* extension[USCoreRaceExtension] -&gt; "Patient.extension[http://fhir.org/guides/argonaut/StructureDefinition/argo-race]"
* extension[USCoreEthnicityExtension] -&gt; "Patient.extension[http://fhir.org/guides/argonaut/StructureDefinition/argo-ethnicity]"
* extension[USCoreBirthSexExtension] -&gt; "Patient.extension[http://fhir.org/guides/argonaut/StructureDefinition/argo-birthsex]"
* identifier -&gt; "Patient.identifier"
* identifier.system -&gt; "Patient.identifier.system"
* identifier.value -&gt; "Patient.identifier.value"
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="defining-profiles">Defining Profiles</h4>

<p>To define a profile, the declaration <code class="language-plaintext highlighter-rouge">Profile</code> and keyword <code class="language-plaintext highlighter-rouge">Parent</code> are REQUIRED, and <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code>, and <code class="language-plaintext highlighter-rouge">Description</code> are RECOMMENDED. Profile metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>). Rules defining the profile follow immediately after the keyword section.</p>

<p>Rules types that apply to Profiles are: <a href="#assignment-rules">Assignment</a>, <a href="#binding-rules">Binding</a>, <a href="#cardinality-rules">Cardinality</a>, <a href="#contains-rules-for-extensions">Contains (standalone extensions)</a>, <a href="#contains-rules-for-slicing">Contains (slicing)</a>, <a href="#flag-rules">Flag</a>, <a href="#insert-rules">Insert</a>, <a href="#obeys-rules">Obeys</a>, <a href="#path-rules">Path</a>, and <a href="#type-rules">Type</a>. Note that <a href="#contains-rules-for-extensions">inline extensions</a> are not permitted in profiles.</p>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a profile for exposure to a pathogen:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile:        KnownExposureSetting
Parent:         Observation
Id:             known-exposure-setting
Title:          "Known Exposure Setting Profile"
Description:    "The setting where an individual was exposed to a contagion."
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* code = $LNC#81267-7 // Setting of exposure to illness
* value[x] only CodeableConcept
* value[x] from https://loinc.org/vs/LL3991-8 (extensible)
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="defining-resources">Defining Resources</h4>

<p>Custom resources allow authors to define new structures representing arbitrary content. Resources are defined similar to <a href="#defining-logical-models">logical models</a>, but are intended to support data exchange using FHIR's RESTful API mechanisms. The capability to define resources may be used by HL7 to define core FHIR resources or by other organizations to define proprietary resources for their own internal use. Potentially, they also can be used to represent and maintain existing core FHIR resources.</p>

<p>Custom (non-HL7) resources SHOULD NOT be used for formal exchange between organizations; only standard FHIR resources and profiles SHOULD be used for inter-organizational exchange of health data. As such, the the FHIR IG publisher does not support including custom resources in implementation guides.</p>

<p>Resources are defined using the REQUIRED declaration <code class="language-plaintext highlighter-rouge">Resource</code>. The keywords <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code>, and <code class="language-plaintext highlighter-rouge">Description</code> are RECOMMENDED. The use of <code class="language-plaintext highlighter-rouge">Parent</code> is OPTIONAL. If no <code class="language-plaintext highlighter-rouge">Parent</code> is specified, DomainResource SHALL be assumed as the default parent. Only <a href="https://hl7.org/fhir/R5/domainresource.html">DomainResource</a> and <a href="https://hl7.org/fhir/R5/resource.html">Resource</a> SHALL be allowed as parents of a resource. Resource metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>).</p>

<p>Rules defining the resource follow immediately after the keyword section. Rules types that apply to resources are: <a href="#add-element-rules">Add Element</a>, <a href="#assignment-rules">Assignment</a>, <a href="#binding-rules">Binding</a>, <a href="#cardinality-rules">Cardinality</a>, <a href="#flag-rules">Flag</a>, <a href="#insert-rules">Insert</a>, <a href="#obeys-rules">Obeys</a>, <a href="#path-rules">Path</a>, and <a href="#type-rules">Type</a>. The following limitations apply:</p>

<ul>
  <li>Binding, cardinality, and type rules SHALL be applied only to elements defined by the item (not inherited elements).</li>
  <li>Flag rules SHALL NOT include <code class="language-plaintext highlighter-rouge">MS</code> flags.</li>
  <li>Assignment rules SHALL be used only with caret paths.</li>
</ul>

<p>The latter restrictions stem from FHIR's <a href="https://hl7.org/fhir/R5/elementdefinition.html#interpretation">interpretation of ElementDefinition for type definitions</a>. Assignments MUST NOT set elements that are prohibited in that table. For example, the table indicates that setting <code class="language-plaintext highlighter-rouge">maxLength</code> or <code class="language-plaintext highlighter-rouge">mustSupport</code> is prohibited.</p>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a resource representing an emergency vehicle, using line spacing to make the definition easier to read:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Resource:       EmergencyVehicle
Id:             emergency-vehicle
Title:          "Emergency Vehicle"
Description:    "An emergency vehicle, such as an ambulance or fire truck."
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* identifier 0..* SU Identifier
    "Identifier(s) of the vehicle"
    "Vehicle identifiers may include VINs and serial numbers."
* make 0..1 SU Coding
    "The vehicle make"
    "The vehicle make, e.g., Chevrolet."
* make from EmergencyVehicleMake (extensible)
* model 0..1 SU Coding
    "The vehicle model"
    "The vehicle model, e.g., G4500."
* model from EmergencyVehicleModel (extensible)
* year 0..1 SU positiveInt
    "Year of manufacture"
    "The year the vehicle was manufactured"
* servicePeriod 0..1 Period
    "When the vehicle was in service"
    "Start date and end date (if applicable) when the vehicle operated."
* operator 0..* Reference(Organization or Practitioner or PractitionerRole)
    "The operator"
    "The organization or persons responsible for operating the vehicle"
* device 0..* Reference(Device)
    "Devices on board"
    "Devices on board the vehicle."
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="defining-rule-sets">Defining Rule Sets</h4>

<p>Rule sets provide the ability to define a group of rules as an independent entity. Through <a href="#insert-rules">insert rules</a>, they can be incorporated into a compatible target. FSH behaves as if the rules in a rule set are copied into the target. As such, the inserted rules MUST make sense where they are inserted. Once defined, a single rule set MAY be used in multiple places. The first rule in a rule set MUST NOT be indented. Rules after the first rule MAY be <a href="#indented-rules">indented</a> but do not affect any rules outside of the rule set (i.e., inserting a rule set SHALL NOT affect the rule paths after the <code class="language-plaintext highlighter-rouge">insert</code> rule).</p>

<p>All types of rules SHALL be usable in rule sets, including <a href="#insert-rules">insert rules</a>, enabling the nesting of rule sets in other rule sets. However, circular dependencies SHALL NOT be allowed.</p>

<h5 id="simple-rule-sets">Simple Rule Sets</h5>

<p>Simple rule sets are defined by using the declaration <code class="language-plaintext highlighter-rouge">RuleSet</code> followed by a user-selected name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: {name}
{rule1}
{rule2}
// More rules
</code></pre></div></div>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Define a rule set for metadata to be used in multiple profiles:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: RuleSet1
* ^status = #draft
* ^experimental = true
* ^publisher = "Elbonian Medical Society"
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="parameterized-rule-sets">Parameterized Rule Sets</h5>

<p>Rule sets MAY also specify one or more parameters as part of their definition. Parameterized rule sets are defined by using the declaration <code class="language-plaintext highlighter-rouge">RuleSet</code> followed by a user-selected name and then a comma-separated list of parameters enclosed in parentheses:</p>

<pre><code>RuleSet: {name}(parameter1<span class="optional">, parameter2, parameter3...</span>)
{rule1}
{rule2}
// More rules
</code></pre>

<p>Each parameter represents a value that SHALL be substituted into the rules when the rule set is inserted. See the <a href="#insert-rules">insert rules</a> section for details on how to pass parameter values when inserting a rule set. In the rules, the places where substitutions should occur SHALL be indicated by enclosing a parameter name in curly braces <code class="language-plaintext highlighter-rouge">{}</code>. Spaces MAY be used after the opening brace and before the closing brace: <code class="language-plaintext highlighter-rouge">{parameter1}</code> and <code class="language-plaintext highlighter-rouge">{ parameter1 }</code> are both valid substitution sequences for a parameter named <code class="language-plaintext highlighter-rouge">parameter1</code>. A parameter MAY occur more than once in the rule set definition.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Define a rule set that contains the syntax for setting the context of an extension. This example also demonstrates the use of <a href="#array-paths-using-soft-indexing">soft indexing</a>. Note that the curly brackets in this example are literal, not syntax expressions:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: SetContext(path)
* ^context[+].type = #element
* ^context[=].expression = "{path}"
</code></pre></div>    </div>

    <p>This rule set can be applied to indicate an extension can only be applied to certain resources, for example:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* insert SetContext(Procedure)
* insert SetContext(MedicationRequest)
* insert SetContext(MedicationAdministration)
</code></pre></div>    </div>

    <p>When the rule set is expanded, it translates to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^context[+].type = #element
* ^context[=].expression = "Procedure"
* ^context[+].type = #element
* ^context[=].expression = "MedicationRequest"
* ^context[+].type = #element
* ^context[=].expression = "MedicationAdministration"
</code></pre></div>    </div>

    <p>Interpreting the soft indices, this is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^context[0].type = #element
* ^context[0].expression = "Procedure"
* ^context[1].type = #element
* ^context[1].expression = "MedicationRequest"
* ^context[2].type = #element
* ^context[2].expression = "MedicationAdministration"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Define a parameterized rule set to define items in a Questionnaire:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: Question(linkId, text, type, repeats)
* item[+].linkId = "{linkId}"
* item[=].text = "{text}"
* item[=].type = #{type}
* item[=].repeats = {repeats}
</code></pre></div>    </div>

    <p>Apply the rule set to populate a Questionnaire:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: TravelRecord
InstanceOf: Questionnaire
// skip some
* insert Question(tr1, When did you leave?, date, false)
* insert Question(tr2, When did you return?, date, false)
* insert Question(tr3, What countries did you visit?, code, true)
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="defining-value-sets">Defining Value Sets</h4>

<p>A value set is a group of coded values representing acceptable values for a FHIR element whose datatype is code, Coding, CodeableConcept, Quantity, string, or url.</p>

<p>Value sets are defined using the REQUIRED declaration <code class="language-plaintext highlighter-rouge">ValueSet</code>, with RECOMMENDED keywords <code class="language-plaintext highlighter-rouge">Id</code>, <code class="language-plaintext highlighter-rouge">Title</code> and <code class="language-plaintext highlighter-rouge">Description</code>. Value set metadata that does not have a dedicated keyword MAY be specified using assignment rules with <a href="#caret-paths">caret paths</a> (e.g., <code class="language-plaintext highlighter-rouge">^url</code>, <code class="language-plaintext highlighter-rouge">^status</code>, <code class="language-plaintext highlighter-rouge">^purpose</code>).</p>

<p>Codes MUST be taken from one or more terminology systems (also called code systems or vocabularies). Codes cannot be defined inside a value set. If necessary, <a href="#defining-code-systems">you MAY define your own code system</a>.</p>

<p>The contents of a value set SHALL be defined by "include" rules, which have the following syntax:</p>

<blockquote>
  <p><strong>Note:</strong> In value set rules, the word <code class="language-plaintext highlighter-rouge">include</code> is OPTIONAL.</p>
</blockquote>

<p><span class="caption" id="t10">Table 10. Summary of value set include rules</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>To include…</th>
      <th>Syntax</th>
      <th>Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A single code</td>
      <td><code>* <span class="optional">include</span> {Coding}</code></td>
      <td><code class="language-plaintext highlighter-rouge">* include http://snomed.info/sct#22298006 "Myocardial infarction (disorder)"</code><br /><br /><code class="language-plaintext highlighter-rouge">* $SCT#22298006 "Myocardial infarction (disorder)"</code><br /><br /><code style="white-space: normal">* http://snomed.info/sct|http://snomed.info/sct/731000124108#22298006 "Myocardial infarction (disorder)"</code></td>
    </tr>
    <tr>
      <td>All codes from another value set</td>
      <td><code>* <span class="optional">include</span> codes from valueset {ValueSet}<span class="optional">|{version string}</span></code></td>
      <td><code class="language-plaintext highlighter-rouge">* include codes from valueset http://hl7.org/fhir/ValueSet/data-absent-reason</code><br /><br /><code class="language-plaintext highlighter-rouge">* include codes from valueset http://hl7.org/fhir/ValueSet/data-absent-reason|5.0.0</code></td>
    </tr>
    <tr>
      <td>All codes from a code system</td>
      <td><code>* <span class="optional">include</span> codes from system {CodeSystem}<span class="optional">|{version string}</span></code></td>
      <td><code class="language-plaintext highlighter-rouge">* include codes from system http://snomed.info/sct</code><br /><br /><code class="language-plaintext highlighter-rouge">* include codes from system http://snomed.info/sct|http://snomed.info/sct/731000124108</code></td>
    </tr>
    <tr>
      <td>Codes that lie in the <em>intersection</em> of value set(s) and (optionally) a code system</td>
      <td><code style="white-space: normal">* <span class="optional">include</span> codes from <span class="optional">system {CodeSystem}|{version string} and</span> valueset {ValueSet1}<span class="optional">|{version1 string}</span><span class="optional"> and {ValueSet2}|{version2 string}...</span></code></td>
      <td><code style="white-space: normal">* include codes from valueset http://hl7.org/fhir/ValueSet/units-of-time and http://hl7.org/fhir/ValueSet/age-units</code><br /><br /><code style="white-space: normal">* include codes from valueset http://hl7.org/fhir/ValueSet/units-of-time|5.0.0 and http://hl7.org/fhir/ValueSet/age-units|5.0.0</code></td>
    </tr>
    <tr>
      <td>Filtered codes from a code system</td>
      <td><code style="white-space: normal">* <span class="optional">include</span> codes from system {CodeSystem}<span class="optional">|{version string}</span> where {filter1} <span class="optional">and {filter2}...</span></code></td>
      <td><code class="language-plaintext highlighter-rouge">* include codes from system $SCT where concept descendant-of #254837009</code><br /><br /><code class="language-plaintext highlighter-rouge">* include codes from system http://snomed.info/sct where concept is-a #254837009</code><br /><br /><code style="white-space: normal">* include codes from system http://snomed.info/sct|http://snomed.info/sct/731000124108 where concept is-a #254837009</code></td>
    </tr>
  </tbody>
</table>

<p><strong>Notes:</strong></p>

<ul>
  <li>When a single include rule includes more than one item (code system or value set), the applicable codes SHALL be those present in <em>all</em> listed items  (i.e., the intersection).</li>
  <li>To add codes from multiple code systems or value sets (i.e., the union not the intersection), authors MUST specify them in separate <code class="language-plaintext highlighter-rouge">include</code> rules.</li>
  <li>When an <code class="language-plaintext highlighter-rouge">include</code> rule has both a system and more than one value set, the code system MUST be first or last.</li>
  <li>An <code class="language-plaintext highlighter-rouge">include</code> rule MUST not have more than one code system (the intersection of two code systems is the empty set).</li>
  <li>Filters are code system dependent. See <a href="#filters">below</a> for further discussion.</li>
  <li><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> Metadata attributes for individual concepts, such as designation, MAY be defined using <a href="#caret-paths">caret paths</a>.</span></li>
</ul>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Include codes in the intersection of time and age units:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* include codes from valueset http://hl7.org/fhir/ValueSet/units-of-time
  and http://hl7.org/fhir/ValueSet/age-units
</code></pre></div>    </div>
  </li>
  <li>
    <p>Include only the v2 codes in the name-assembly-order value set:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* include codes from system http://terminology.hl7.org/CodeSystem/v2-0444 and valueset http://hl7.org/fhir/ValueSet/name-assembly-order
</code></pre></div>    </div>
  </li>
</ul>

<p>Analogous rules MAY be used to leave out certain codes, with the word <code class="language-plaintext highlighter-rouge">exclude</code> replacing the word <code class="language-plaintext highlighter-rouge">include</code>:</p>

<p><span class="caption" id="t11">Table 11. Summary of value set exclude rules</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>To exclude…</th>
      <th>Syntax</th>
      <th>Examples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A single code</td>
      <td><code class="language-plaintext highlighter-rouge">* exclude {Coding}</code></td>
      <td><code class="language-plaintext highlighter-rouge">* exclude $SCT#22298006 "Myocardial infarction (disorder)"</code><br /><br /><code class="language-plaintext highlighter-rouge">* exclude http://snomed.info/sct#22298006 "Myocardial infarction (disorder)"</code><br /><br /><code style="white-space: normal">* exclude http://snomed.info/sct|http://snomed.info/sct/731000124108#22298006 "Myocardial infarction (disorder)"</code></td>
    </tr>
    <tr>
      <td>All codes from another value set</td>
      <td><code>* exclude codes from valueset {ValueSet}<span class="optional">|{version string}</span></code></td>
      <td><code class="language-plaintext highlighter-rouge">* exclude codes from valueset http://hl7.org/fhir/ValueSet/data-absent-reason</code><br /><br /><code class="language-plaintext highlighter-rouge">* exclude codes from valueset http://hl7.org/fhir/ValueSet/data-absent-reason|5.0.0</code></td>
    </tr>
    <tr>
      <td>All codes from a code system</td>
      <td><code>* exclude codes from system {CodeSystem}<span class="optional">|{version string}</span></code></td>
      <td><code class="language-plaintext highlighter-rouge">* exclude codes from system http://snomed.info/sct</code><br /><br /><code class="language-plaintext highlighter-rouge">* exclude codes from system http://snomed.info/sct|http://snomed.info/sct/731000124108</code></td>
    </tr>
    <tr>
      <td>Codes that lie in the <em>intersection</em> of value set(s) and (optionally) a code system</td>
      <td><code style="white-space: normal">* exclude codes from <span class="optional">system {CodeSystem}|{version string} and</span> valueset {ValueSet1}<span class="optional">|{version1 string}</span><span class="optional"> and {ValueSet2}|{version2 string}...</span></code></td>
      <td><code style="white-space: normal">* exclude codes from valueset http://hl7.org/fhir/ValueSet/units-of-time and http://hl7.org/fhir/ValueSet/age-units</code><br /><br /><code style="white-space: normal">* exclude codes from valueset http://hl7.org/fhir/ValueSet/units-of-time|5.0.0 and http://hl7.org/fhir/ValueSet/age-units|5.0.0</code></td>
    </tr>
    <tr>
      <td>Filtered codes from a code system</td>
      <td><code style="white-space: normal">* exclude codes from system {CodeSystem}<span class="optional">|{version string}</span> where {filter}</code></td>
      <td><code class="language-plaintext highlighter-rouge">* exclude codes from system $SCT where concept is-a #254837009</code><br /><br /><code class="language-plaintext highlighter-rouge">* exclude codes from system http://snomed.info/sct where concept is-a #254837009</code><br /><br /><code style="white-space: normal">* exclude codes from system http://snomed.info/sct|http://snomed.info/sct/731000124108 where concept is-a #254837009</code></td>
    </tr>
  </tbody>
</table>

<p>Rule types that apply to ValueSets are: <a href="#assignment-rules">Assignment</a>, <a href="#exclude-rules">Exclude</a>, <a href="#include-rules">Include</a>, and <a href="#insert-rules">Insert</a>. Assignment rules SHALL be applicable to value sets only in the context of caret paths.</p>

<p>For additional details about ValueSet composition, see the <a href="https://hl7.org/fhir/R5/valueset.html#compositions">FHIR documentation on ValueSet composition rules</a>.</p>

<h5 id="filters">Filters</h5>

<p>A filter is a logical statement in the form <code class="language-plaintext highlighter-rouge">{property} {operator} {value}</code>, where operator MUST be chosen from the <a href="https://hl7.org/fhir/R5/ValueSet/filter-operator">FilterOperator value set</a>. Not all operators in that value set are valid for all code systems. The <code class="language-plaintext highlighter-rouge">property</code> and <code class="language-plaintext highlighter-rouge">value</code> are dependent on the code system. Depending on the filter, the <code class="language-plaintext highlighter-rouge">value</code> MAY be a code (e.g., <code class="language-plaintext highlighter-rouge">#123-A</code>), boolean (e.g., <code class="language-plaintext highlighter-rouge">true</code>), string (e.g., <code class="language-plaintext highlighter-rouge">"inherited"</code>), or regular expression (e.g., <code class="language-plaintext highlighter-rouge">/A\.[0-9]+/</code>). For choices for the most common code systems, see the <a href="https://hl7.org/fhir/R5/valueset.html#csnote">FHIR documentation on filters</a>.</p>

<p><strong>Examples</strong></p>

<ul>
  <li>
    <p>Define a value set using <a href="https://hl7.org/fhir/R5/valueset.html#int-ext">extensional</a> rules. This example demonstrates the optionality of the word <code class="language-plaintext highlighter-rouge">include</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ValueSet: BinetStageValueVS
Id: mcode-binet-stage-value-vs
Title: "Binet Stage Value Set"
Description: "Codes in the Binet staging system representing Chronic Lymphocytic Leukemia (CLL) stage."
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* $NCIT#C80134 "Binet Stage A"
* $NCIT#C80135 "Binet Stage B"
* $NCIT#C80136 "Binet Stage C"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Define a value set using <a href="https://blog.healthlanguage.com/the-difference-between-intensional-and-extensional-value-sets">intensional</a> rules:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ValueSet: HistologyMorphologyBehaviorVS
Id: mcode-histology-morphology-behavior-vs
Title: "Histology Morphology Behavior Value Set"
Description: "Codes representing the structure, arrangement, and behavioral characteristics of malignant neoplasms, and cancer cells."
// url, status, purpose, and other metadata could be defined here using caret syntax (omitted)
* include codes from system $SCT where concept is-a #367651003 "Malignant neoplasm of primary, secondary, or uncertain origin (morphologic abnormality)"
* include codes from system $SCT where concept is-a #399919001 "Carcinoma in situ - category (morphologic abnormality)"
* include codes from system $SCT where concept is-a #399983006 "In situ adenomatous neoplasm - category (morphologic abnormality)"
* exclude codes from system $SCT where concept is-a #450893003 "Papillary neoplasm, pancreatobiliary-type, with high grade intraepithelial neoplasia (morphologic abnormality)"
* exclude codes from system $SCT where concept is-a #128640002 "Glandular intraepithelial neoplasia, grade III (morphologic abnormality)"
* exclude codes from system $SCT where concept is-a #450890000 "Glandular intraepithelial neoplasia, low grade (morphologic abnormality)"
* exclude codes from system $SCT where concept is-a #703548001 "Endometrioid intraepithelial neoplasia (morphologic abnormality)"
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> Intensional and extensional forms MAY be used together in a single value set definition.</p>
</blockquote>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <h5 id="concept-metadata">Concept Metadata</h5>

  <p>Within a ValueSet definition, the caret syntax MAY be used to set metadata attributes for individual concepts (e.g., elements of <code class="language-plaintext highlighter-rouge">ValueSet.compose.include.concept.designation</code>).</p>

  <p>To assign metadata values for concepts that are included in the value set, authors SHOULD specify one or more indented caret path assignment rules below the rule that includes the concept:</p>
  <pre><code>* <span class="optional">include</span> {Coding}
  * ^&lt;element1 of corresponding concept&gt; = {value1}
  <span class="optional">* ^&lt;element2 of corresponding concept&gt; = {value2}</span>
</code></pre>

  <p>To assign metadata values for concepts that are excluded in the value set, authors SHOULD specify one or more indented caret path assignment rules below the rule that excludes the concept:</p>
  <pre><code>* exclude {Coding}
  * ^&lt;element1 of corresponding concept&gt; = {value1}
  <span class="optional">* ^&lt;element2 of corresponding concept&gt; = {value2}</span>
</code></pre>

  <p>Indented caret path assignment rules are RECOMMENDED for clarity, but authors MAY choose to repeat the code and follow it with a caret path assignment instead:</p>
  <pre><code>* {Coding} ^&lt;element1 of corresponding concept&gt; = {value1}
<span class="optional">* {Coding} ^&lt;element2 of corresponding concept&gt; = {value2}</span>
</code></pre>

  <blockquote>
    <p><strong>Note:</strong> A concept MUST be included or excluded <em>before</em> caret rule assignments can be used to set its metadata. When a single rule contains a concept followed by a caret path assignment, the assignment pertains to the concept wherever it is found in the composition (whether included or excluded).</p>
  </blockquote>

  <p><strong>Examples:</strong></p>

  <ul>
    <li>
      <p>To specify a <code class="language-plaintext highlighter-rouge">designation</code> for the fully specified name of the included concept <code class="language-plaintext highlighter-rouge">$SCT#84162001</code>:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* $SCT#84162001  "Cold"
  * ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
  * ^designation[0].value = "Cold sensation quality (qualifier value)"
</code></pre></div>      </div>
    </li>
    <li>
      <p>To specify a <code class="language-plaintext highlighter-rouge">designation</code> for the fully specified name of the included concept <code class="language-plaintext highlighter-rouge">$LNC#55423-8</code> using the <code class="language-plaintext highlighter-rouge">include</code> keyword:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* include $LNC#55423-8 "Number of steps"
  * ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
  * ^designation[0].value = "Number of steps in Unspecified Time, Pedometer"
</code></pre></div>      </div>
    </li>
    <li>
      <p>To specify a <code class="language-plaintext highlighter-rouge">designation</code> for a synonym of the included concept <code class="language-plaintext highlighter-rouge">$SCT#32849002</code> by repeating the code:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* $SCT#32849002  "Esophageal structure"
* $SCT#32849002  ^designation[0].use = $SCT#900000000000013009 "Synonym (core metadata concept)"
* $SCT#32849002  ^designation[0].language = urn:ietf:bcp:47#en-GB
* $SCT#32849002  ^designation[0].value = "Oesophageal structure"
</code></pre></div>      </div>
    </li>
    <li>
      <p>To specify a <code class="language-plaintext highlighter-rouge">designation</code> for a synonym of the excluded concept <code class="language-plaintext highlighter-rouge">$SCT#22298006</code>:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* exclude $SCT#22298006 "Myocardial infarction (disorder)"
  * ^designation[0].use = $SCT#900000000000013009 "Synonym (core metadata concept)"
  * ^designation[0].language = urn:ietf:bcp:47#en-US
  * ^designation[0].value = "Heart attack"
</code></pre></div>      </div>
    </li>
    <li>
      <p>To specify a <code class="language-plaintext highlighter-rouge">designation</code> for the fully specified name of the excluded concept <code class="language-plaintext highlighter-rouge">$SCT#54987000</code> by repeating the code:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* exclude $SCT#54987000 "Choledochoplasty"
* $SCT#54987000 ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
* $SCT#54987000 ^designation[0].value = "Repair of common bile duct (procedure)"
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<h3 id="fsh-rules">FSH Rules</h3>

<p>Rules are the mechanism in FSH for populating and constraining items by setting cardinality, applying flags, binding value sets, defining extensions, and more. Rules in FSH are distinguished by a leading asterisk (<code class="language-plaintext highlighter-rouge">*</code>) symbol:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* {rule statement}
</code></pre></div></div>

<p>The following restrictions apply to rules:</p>

<ul>
  <li>All rules MUST begin on a new line.</li>
  <li>The asterisk symbol MUST be followed by at least one space.</li>
  <li>The asterisk MUST NOT be preceded by non-whitespace characters on a line.</li>
  <li>The asterisk MUST NOT be preceded by whitespace characters, unless using <a href="#indented-rules">indented rule syntax</a>.</li>
</ul>

<p>The following table is a summary of the rule syntax.</p>

<p><span class="caption" id="t12">Table 12. Summary of FSH rule types</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>Rule Type</th>
      <th>Syntax</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#add-element-rules">Add Element</a></td>
      <td><code>* &lt;element&gt; {card} <span class="optional">{flag(s)}</span> {datatype(s)} "{short}" <span class="optional">"{definition}"</span></code><br /><code>* &lt;element&gt; {card} <span class="optional">{flag(s)}</span> contentReference {contentUrl} "{short}" <span class="optional">"{definition}"</span></code></td>
    </tr>
    <tr>
      <td><a href="#assignment-rules">Assignment</a></td>
      <td><code>* &lt;element&gt; = {value} <span class="optional">(exactly)</span></code></td>
    </tr>
    <tr>
      <td><a href="#binding-rules">Binding</a></td>
      <td><code>* &lt;bindable&gt; from {ValueSet} <span class="optional">({strength})</span></code></td>
    </tr>
    <tr>
      <td><a href="#cardinality-rules">Cardinality</a></td>
      <td><code>* &lt;element&gt; <span class="optional">{min}</span>..<span class="optional">{max}</span> // min, max, or both MUST be present </code></td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-extensions">Contains (standalone extensions)</a></td>
      <td><code>* &lt;extension&gt; contains {Extension1} named {name1} {card} <span class="optional">{flag(s)} <br />   and {Extension2} named {name2} {card} {flag(s)}  <br />   and {Extension3} named {name3} {card} {flag(s)}...</span></code></td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-extensions">Contains (inline extensions)</a></td>
      <td><code>* &lt;extension&gt; contains {name1} {card} <span class="optional">{flag(s)} <br />   and {name2} {card} {flag(s)}  <br />   and {name3} {card} {flag(s)}...</span></code></td>
    </tr>
    <tr>
      <td><a href="#contains-rules-for-slicing">Contains (slicing)</a></td>
      <td><code>* &lt;array&gt; contains {name} {card} <span class="optional">{flag(s)} <br />   and {name2} {card} {flag2} <br />   and {name3} {card} {flag(s)}...</span></code></td>
    </tr>
    <tr>
      <td><a href="#exclude-rules">Exclude</a></td>
      <td><code>* exclude {Coding}</code><br /><code>* exclude codes from valueset {ValueSet}<span class="optional">|{version}</span></code><br /><code>* exclude codes from system {CodeSystem}<span class="optional">|{version}</span></code><br /><code>* exclude codes from system {CodeSystem}<span class="optional">|{version}</span> where {filter1} <span class="optional">and {filter2}...</span></code><br /><code>* exclude codes from system {CodeSystem}<span class="optional">|{version}</span> <br />   and valueset {ValueSet1}<span class="optional">|{version1}</span> <br />   <span class="optional">and valueset {ValueSet2}|{version2}</span></code></td>
    </tr>
    <tr>
      <td><a href="#flag-rules">Flag</a></td>
      <td><code>* &lt;element(s)&gt; {flag(s)}</code></td>
    </tr>
    <tr>
      <td><a href="#include-rules">Include</a></td>
      <td><code>* <span class="optional">include</span> {Coding}</code><br /><code>* <span class="optional">include</span> codes from valueset {ValueSet}<span class="optional">|{version}</span></code><br /><code>* <span class="optional">include</span> codes from system {CodeSystem}<span class="optional">|{version}</span></code><br /><code>* <span class="optional">include</span> codes from system {CodeSystem}<span class="optional">|{version}</span> where {filter1} <span class="optional">and {filter2}...</span></code><br /><code>* <span class="optional">include</span> codes from system {CodeSystem}<span class="optional">|{version}</span> <br />   and valueset {ValueSet1}<span class="optional">|{version1}</span> <br />   <span class="optional">and valueset {ValueSet2}|{version2}</span></code></td>
    </tr>
    <tr>
      <td><a href="#insert-rules">Insert</a></td>
      <td><code>* insert {RuleSet}</code><br /><code>* insert {RuleSet}({parameter1}<span class="optional">, {parameter2}, ...</span>)</code><br /><code>* &lt;element&gt; insert {RuleSet}<span class="optional">({parameter1}, {parameter2}, ...)</span></code></td>
    </tr>
    <tr>
      <td><a href="#local-code-rules">Local Code</a></td>
      <td><code>* #{code} "{display string}" <span class="optional">"{definition string}"</span></code><br /><code>* #{parentCode} #{childCode} "{display string}" <span class="optional">"{definition string}"</span></code></td>
    </tr>
    <tr>
      <td><a href="#mapping-rules">Mapping</a></td>
      <td><code>* <span class="optional">&lt;element&gt;</span> -&gt; "{map string}" <span class="optional">"{comment string}" #{mime-type code}</span></code></td>
    </tr>
    <tr>
      <td><a href="#obeys-rules">Obeys</a></td>
      <td><code>* <span class="optional">&lt;element&gt;</span> obeys {Invariant} <span class="optional">and {Invariant2} and {Invariant3}...</span></code></td>
    </tr>
    <tr>
      <td><a href="#path-rules">Path</a></td>
      <td><code>* &lt;element&gt; </code></td>
    </tr>
    <tr>
      <td><a href="#type-rules">Type</a></td>
      <td><code>* &lt;element&gt; only {datatype(s)}</code></td>
    </tr>
  </tbody>
</table>

<h4 id="rule-order">Rule Order</h4>

<p>Rules SHALL be interpreted logically in a top-down manner. In many cases, the order of rules is flexible. However, there are some situations where FSH requires rules to appear in a certain order. For example, <a href="#contains-rules-for-slicing">slicing rules</a> require that a slice MUST first be defined by a <code class="language-plaintext highlighter-rouge">contains</code> rule before the slice is referenced. Implementations MUST enforce rule-order requirements where they are specified in FSH.</p>

<p>Logical order dependencies can also arise. For example, in setting properties of a choice element (an element involving FHIR's <code class="language-plaintext highlighter-rouge">[x]</code> syntax), this order is problematic:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* value[x].unit 0..0
* value[x] only Quantity
</code></pre></div></div>

<p>but this order is acceptable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* value[x] only Quantity
* value[x].unit 0..0
</code></pre></div></div>

<p>In the first approach, <code class="language-plaintext highlighter-rouge">value[x]</code> is not yet known to be restricted to a Quantity, so <code class="language-plaintext highlighter-rouge">value[x].unit</code> is ambiguous. In the second approach, <code class="language-plaintext highlighter-rouge">value[x]</code> is known to be a Quantity, so <code class="language-plaintext highlighter-rouge">value[x].unit</code> is unambiguous.</p>

<p>In cases with no explicit or logical restrictions on rule ordering, users MAY list rules in any order, bearing in mind that <a href="#insert-rules">insert rules</a> expand into other rules that could have order constraints or logical ordering requirements.</p>

<p>It is possible for a user to specify contradictory rules, for example, two rules constraining the cardinality of an element to different values, or constraining an element to different datatypes. Implementations SHOULD detect such contradictions and issue appropriate warning or error messages.</p>

<h4 id="indented-rules">Indented Rules</h4>

<p>Indentation before a rule MAY be used to set a context for the <a href="#fsh-paths">path</a> on that rule. When one rule is indented below another, the full path of the indented rule or rules SHALL be obtained by prepending the path from the previous less-indented rule or rules. The level of indentation MAY be reduced to indicate that a rule should not use the context of the preceding rule. The full path of all rules SHALL be resolved from the context specified by indentation before any rules are applied.</p>

<p>Two spaces SHALL represent one level of indentation. Rules SHALL only be indented in increments of two spaces and un-indented by any multiple of two spaces.</p>

<p><a href="#path-rules">Path rules</a> are rules containing only a path. They are primarily used to set a path as context for subsequent rules, without any other effect. <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> In FSH Instances, path rules sometimes have other effects as well. See <a href="#path-rules">path rules</a> for more information.</span></p>

<p>Some types of rules, for example <a href="#flag-rules">flag rules</a>, MAY involve multiple paths. If multiple paths are specified in a rule that sets context for subsequent rules (such as a flag rule with multiple targets), the last path SHALL be used as context. When multiple paths are specified in an indented rule, context SHALL be applied to all paths. See examples below for details.</p>

<p>There are some limitations on where indented rules can be used. Indented rules MUST NOT appear below rules that do not specify a path. Rules that may omit an element path include top-level <a href="#obeys-rules">obeys rules</a>, top-level <a href="#caret-paths">caret paths</a>, <a href="#defining-mappings">mapping rules</a>, and <a href="#insert-rules">insert rules</a>.</p>

<p>When indented rules are combined with <a href="#array-paths-using-soft-indexing">soft indexing</a> and a rule containing the increment operator <code class="language-plaintext highlighter-rouge">[+]</code> sets the path context for multiple subsequent rules, the index SHALL be incremented only once. On subsequent rules, the <code class="language-plaintext highlighter-rouge">[+]</code> is effectively replaced with <code class="language-plaintext highlighter-rouge">[=]</code>. See examples below for details.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Use indented rules to set cardinalities on <code class="language-plaintext highlighter-rouge">name.family</code> and <code class="language-plaintext highlighter-rouge">name.given</code> in a Patient resource:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name 1..1
  * family 1..1
  * given 1..1
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name 1..1
* name.family 1..1
* name.given 1..1
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use a <a href="#path-rules">path rule</a> to set context for subsequent rules:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name
  * family 1..1
  * given 1..1
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name.family 1..1
* name.given 1..1
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of multi-level indented rules:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name MS
  * family MS
    * id MS
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name MS
* name.family MS
* name.family.id MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of multiple paths in an indented rule, with the context applied to all paths:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name
  * family and given MS
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name.family and name.given MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of multiple paths in a rule that sets context for subsequent rules, where the last path sets the context:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* birthDate and name MS
  * family 1..1
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* birthDate and name MS
* name.family 1..1
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of reducing the level of indentation to remove the context of a preceding rule:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* item[0]
  * linkId = "title"
  * type = #display
  * item[0]
    * linkId = "uniquearv_number"
    * type = #string
  * item[1]
    * linkId = "personal_info"
    * type = #group
* status = #active
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* item[0].linkId = "title"
* item[0].type = #display
* item[0].item[0].linkId = "uniquearv_number"
* item[0].item[0].type = #string
* item[0].item[1].linkId = "personal_info"
* item[0].item[1].type = #group
* status = #active
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of combining soft indexing with <a href="#indented-rules">indented rules</a>, where a rule with the increment operator <code class="language-plaintext highlighter-rouge">[+]</code> is used to set the context:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* item[+]
  * linkId = "title"
  * type = #display
</code></pre></div>    </div>

    <p>is <strong>not</strong> equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* item[+].linkId = "title"
* item[+].type = #display
</code></pre></div>    </div>

    <p>but is instead equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* item[+].linkId = "title"
* item[=].type = #display
</code></pre></div>    </div>
  </li>
  <li>
    <p>Another example of soft indexing combined with indented paths, illustrating that when a rule containing <code class="language-plaintext highlighter-rouge">[+]</code> is used to set the context of multiple subsequent rules, the index is incremented only once:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* rest.resource[+]
  * type = #Organization
  * interaction[+].code = #create
  * interaction[+].code = #update
  * interaction[+].code = #delete
* rest.resource[+]
  * type = #Condition
  * interaction[+].code = #create
  * interaction[+].code = #update
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* rest.resource[+].type = #Organization
* rest.resource[=].interaction[+].code = #create
* rest.resource[=].interaction[+].code = #update
* rest.resource[=].interaction[+].code = #delete
* rest.resource[+].type = #Condition
* rest.resource[=].interaction[+].code = #create
* rest.resource[=].interaction[+].code = #update
</code></pre></div>    </div>

    <p>is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* rest.resource[0].type = #Organization
* rest.resource[0].interaction[0].code = #create
* rest.resource[0].interaction[1].code = #update
* rest.resource[0].interaction[2].code = #delete
* rest.resource[1].type = #Condition
* rest.resource[1].interaction[0].code = #create
* rest.resource[1].interaction[1].code = #update
</code></pre></div>    </div>
  </li>
  <li>
    <p>An error, attempting to use a rule without a path as context for an indented rule, since <code class="language-plaintext highlighter-rouge">obeys</code> does not imply a path:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* obeys inv-1
  * family 1..1
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="add-element-rules">Add Element Rules</h4>

<p>Authors define logical models and resources by adding new elements to their definitions. The add element rule is only applicable for logical models and resources. It SHALL NOT be used when defining profiles or extensions.</p>

<p>The syntax of the rules to add a new element is as follows:</p>

<pre><code>* &lt;element&gt; {min}..{max} <span class="optional">{flag(s)}</span> {datatype(s)} "{short}" <span class="optional">"{definition}"</span></code></pre>

<p>where <code class="language-plaintext highlighter-rouge">{datatype(s)}</code> MAY be one of the following:</p>

<ul>
  <li>A primitive or complex datatype name, or multiple datatypes separated with <code class="language-plaintext highlighter-rouge">or</code>,</li>
  <li>References to one or more resources or profiles, <code>Reference({Resource/Profile1} <span class="optional">or {Resource/Profile2} or {Resource/Profile3}...</span>)</code></li>
  <li>Canonicals for one or more resources or profiles, <code>Canonical({Resource/Profile1} <span class="optional">or {Resource/Profile2} or {Resource/Profile3}...</span>)</code></li>
  <li><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> CodeableReferences to one or more resources or profiles, <code>CodeableReference({Resource/Profile1} <span class="optional">or {Resource/Profile2} or {Resource/Profile3}...</span>)</code></span></li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>To add an element that uses a <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#ElementDefinition.contentReference">contentReference</a> to refer to another element, use the following syntax:</p>

  <pre><code>* &lt;element&gt; {min}..{max} <span class="optional">{flag(s)}</span> contentReference {contentUrl} "{short}" <span class="optional">"{definition}"</span></code></pre>

  <p>where <code class="language-plaintext highlighter-rouge">{contentUrl}</code> is a URI referencing the element whose properties will be used to define this element. This type of element definition is typically used with recursively nested elements, such as <a href="https://hl7.org/fhir/R5/questionnaire-definitions.html#Questionnaire.item.item">Questionnaire.item.item</a>, which is defined by reference to <code class="language-plaintext highlighter-rouge">#Questionnaire.item</code>. Another example is <a href="https://hl7.org/fhir/R5/observation-definitions.html#Observation.component.referenceRange">Observation.component.referenceRange</a>, which is defined by reference to <code class="language-plaintext highlighter-rouge">#Observation.referenceRange</code>. Refer to the <a href="https://hl7.org/fhir/R5/elementdefinition-definitions.html#ElementDefinition.contentReference">ElementDefinition documentation</a> for more information.</p>

</div>

<p>Note the following:</p>

<ul>
  <li>An add element rule <strong>at minimum</strong> MUST specify:
    <ul>
      <li>an element path, cardinality, type, and short description, OR</li>
      <li><span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> an element path, cardinality, the <code class="language-plaintext highlighter-rouge">contentReference</code> keyword, a content reference URI, and short description.</span></li>
    </ul>
  </li>
  <li>Flags and longer definition are OPTIONAL.</li>
  <li>The longer definition MAY also be a multi-line (triple quoted) string.</li>
  <li>If a longer definition is not specified, FSH implementers SHALL set the element's definition to the same text as the specified short description.</li>
  <li>When multiple types are specified, the element path MUST end with <code class="language-plaintext highlighter-rouge">[x]</code> unless all types are References, all types are Canonicals, or <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> all types are CodeableReferences</span>.</li>
</ul>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Add a string-typed element:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* email 0..* string "The person's email addresses"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a string-typed element with a summary flag and longer definition:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* email 0..* SU string "The person's email addresses" "Email addresses by which the person may be contacted."
</code></pre></div>    </div>
  </li>
</ul>
<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Add an element defined by a <code class="language-plaintext highlighter-rouge">contentReference</code>, which receives the content rules of the referenced element:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* email 0..* contentReference http://example.org/StructureDefinition/AnotherResource#AnotherResource.email "The person's email addresses"
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<ul>
  <li>
    <p>Add a reference-typed element with a longer definition:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* primaryClinicians 0..* Reference(Organization or Practitioner or PractitionerRole) "Primary clinicians"
    "The person's primary clinical organizations and practitioners"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a choice element with a multi-line description using markdown syntax:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* preferredName[x] 0..1 string or HumanName "The person's preferred name" """
    Sometimes patients prefer to be called by a name other than their _formal_ name. This may be:
    * their nickname
    * their middle name
    * their maiden name
    * etc.
    """
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a BackboneElement element to provide a structured set of elements in a logical model:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* serviceAnimal 0..* BackboneElement "Service animals" "Animals trained to assist the person by performing certain tasks."
* serviceAnimal.name 0..1 string "Name of service animal" "The name by which the service animal responds."
* serviceAnimal.breed 1..* CodeableConcept "Breed of service animal" "The dominant breed or breeds of the service animal."
* serviceAnimal.startDate 0..1 date "Date the service animal began work" "The date on which the service animal began working for the person."
</code></pre></div>    </div>
    <p>or the same set of rules using indentation to maintain the path context:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* serviceAnimal 0..* BackboneElement "Service animals" "Animals trained to assist the person by performing certain tasks."
  * name 0..1 string "Name of service animal" "The name by which the service animal responds."
  * breed 1..* CodeableConcept "Breed of service animal" "The dominant breed or breeds of the service animal."
  * startDate 0..1 date "Date the service animal began work" "The date on which the service animal began working for the person."
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="assignment-rules">Assignment Rules</h4>

<p>Assignment rules follow this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; = {value}
</code></pre></div></div>

<p>The left side of this expression SHALL follow the <a href="#fsh-paths">FSH path grammar</a> and MAY optionally include a <a href="#caret-paths">caret path</a> in definitions for profiles, extensions, logicals, resources, code systems, and value sets. The datatype on the right side MUST align with the datatype of the final element in the path. Except in specific cases noted below, an assignment replaces any existing value assigned to the element.</p>

<h5 id="assigning-values-versus-specifying-constraints">Assigning Values versus Specifying Constraints</h5>

<p>Assignment rules have two very different interpretations, depending on context:</p>

<ul>
  <li>In instances <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> and invariants</span>, assignment rules set the <strong>value</strong> of the target element. Note that whenever an element is accessed via a <a href="#caret-paths">caret path</a>, it is actually accessing the definitional instance (for example, the StructureDefinition of the profile). Therefore, assignments involving caret paths also set the <strong>value</strong> of the target element.</li>
  <li>Assignment rules in profiles and extensions establish <strong>constraints</strong> on instances conforming to the profile or extension. The requirement is expressed as a pattern of values that MUST be present in the instance. In this context, an assignment rule does not set the value of the element, but instead, establishes a <strong>constraint</strong> on that value.</li>
</ul>

<p>This is best illustrated by example. Consider the following assignment (assuming <code class="language-plaintext highlighter-rouge">code</code> is a CodeableConcept):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* code = https://loinc.org#69548-6
</code></pre></div></div>

<p>If this statement appears in an instance of an Observation, then the values of <code class="language-plaintext highlighter-rouge">code.coding[0].system</code> and <code class="language-plaintext highlighter-rouge">code.coding[0].code</code> will be set to https://loinc.org and 69548-6, respectively, in that Observation.</p>

<p>If the identical statement appears in a profile on Observation, it signals that the StructureDefinition is configured such that the <code class="language-plaintext highlighter-rouge">code</code> element of a conformant instance MUST have a Coding with the system http://loinc.org and the code 69548-6. (In fact, the StructureDefinition does not even <em>have</em> its own <code class="language-plaintext highlighter-rouge">code</code> element to populate.)</p>

<blockquote>
  <p><strong>Note</strong>: In the profiling context, typically only the system and code are important conformance criteria for a Coding or CodeableConcept property. If a display text is included, it will be part of the conformance criteria.</p>
</blockquote>

<p>In the latter case of establishing a constraint in a profile, the constraint pattern is considered "open" by default, in the sense that the element in question might have content in addition to the prescribed value, such as alternative codes in a CodeableConcept. If conformance to a profile requires a precise match to the pattern (which is rare), then the following syntax can be used:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; = {value} (exactly)
</code></pre></div></div>

<p>Adding <code class="language-plaintext highlighter-rouge">(exactly)</code> indicates that an <em>exact</em> match is REQUIRED. When the right-hand side of an assignment is a primitive value (e.g., a string), <code class="language-plaintext highlighter-rouge">(exactly)</code> indicates that the exact value is REQUIRED and MUST NOT have an id or extensions. When the right-hand side of an assignment is a complex value (e.g., a Quantity), <code class="language-plaintext highlighter-rouge">(exactly)</code> indicates that all specified components of the complex value are REQUIRED and additional sub-elements SHALL NOT be allowed. In general, using <code class="language-plaintext highlighter-rouge">(exactly)</code> is not the best option for interoperability because it creates conformance criteria that could be too tight, risking the rejection of valid, useful data. FSH offers this option primarily because exact value matching is used in some current IGs and profiles. For example, in a profile,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* code = $LNC#69548-6 (exactly)
</code></pre></div></div>

<p>means that a conforming instance MUST have the system http://loinc.org, the code 69548-6, and <em>MUST NOT have</em> a display text, additional codes, or extensions on the code element.</p>

<blockquote>
  <p><strong>Note</strong>: Assigning values in a profile populates the underlying ElementDefinition's <code class="language-plaintext highlighter-rouge">pattern[x]</code> or <code class="language-plaintext highlighter-rouge">fixed[x]</code> property (<code class="language-plaintext highlighter-rouge">pattern[x]</code> in the default case; <code class="language-plaintext highlighter-rouge">fixed[x]</code> when <code class="language-plaintext highlighter-rouge">(exactly)</code> is used). As such, assigned values SHALL be restricted to the types allowed for <a href="https://hl7.org/fhir/R5/datatypes.html#open">open type elements</a>.</p>
</blockquote>

<p>When assigning values to an instance, the <code class="language-plaintext highlighter-rouge">(exactly)</code> modifier has no meaning and SHOULD NOT be used. Implementations MAY ignore the modifier or signal an error.</p>

<h5 id="assignments-with-primitive-data-types">Assignments with Primitive Data Types</h5>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Assignment of a code datatype:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* status = #arrived
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assignment of a boolean:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* active = true
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assignment of a date:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* onsetDateTime = "2019-04-02"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assignment of a dateTime:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* recordedDate = "2013-06-08T09:57:34.2112Z"
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Assignment of an integer64 (note: this datatype was introduced in FHIR R5):</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* extension[my-extension].valueInteger64 = 1234567890
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<h5 id="assignments-with-the-coding-data-type">Assignments with the Coding Data Type</h5>

<p>A FHIR Coding has five attributes (<code class="language-plaintext highlighter-rouge">system</code>, <code class="language-plaintext highlighter-rouge">version</code>, <code class="language-plaintext highlighter-rouge">code</code>, <code class="language-plaintext highlighter-rouge">display</code>, and <code class="language-plaintext highlighter-rouge">userSelected</code>). The first four of these MAY be set with a single assignment statement. The syntax is:</p>

<pre><code>&lt;Coding&gt; = <span class="optional">{CodeSystem}|{version string}</span>#{code} <span class="optional">"{display string}"</span></code></pre>

<p>The only REQUIRED part of this statement is the code (including the <code class="language-plaintext highlighter-rouge">#</code> sign), although every Coding SHOULD have a code system. The version string MUST NOT appear without a code system.</p>

<p>Whenever this type of rule is applied, whatever is on the right side SHALL <strong>entirely replace</strong> the previous value of the Coding on the left side. For example, if a Coding has a value that includes a display string, and a subsequent assignment replaces the system and code but has no display string, the result is a Coding without a display string.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Assign a Coding that includes only a code:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myCoding = #chol-mmol
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign a Coding that includes an explicit code system version:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myCoding = http://hl7.org/fhir/CodeSystem/example-supplement|201801103#chol-mmol
</code></pre></div>    </div>
  </li>
  <li>
    <p>As an alternative to the bar syntax for version, set the code system version only:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCoding.version = "201801103"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the <code class="language-plaintext highlighter-rouge">userSelected</code> property of a Coding (one of the lesser-used attributes of Codings):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCoding.userSelected = true
</code></pre></div>    </div>
  </li>
  <li>
    <p>In an instance of a Signature, set <code class="language-plaintext highlighter-rouge">Signature.type</code> (a Coding datatype):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* type = urn:iso-astm:E1762-95:2013#1.2.840.10065.1.12.1.2 "Coauthor's Signature"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of what happens when a second assignment replaces an existing value:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCoding = $SCT#363346000 "Malignant neoplastic disease (disorder)"
* myCoding = $ICD#C80.1
</code></pre></div>    </div>
    <p>Because the second assignment clears the previous value of <code class="language-plaintext highlighter-rouge">myCoding</code>, the result is:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">myCoding.system</code> is http://hl7.org/fhir/sid/icd-10-cm (assuming the <code class="language-plaintext highlighter-rouge">$ICD</code> alias maps to this URL)</li>
      <li><code class="language-plaintext highlighter-rouge">myCoding.code</code> is "C80.1"</li>
      <li><code class="language-plaintext highlighter-rouge">myCoding.display</code> <strong>has no value</strong></li>
      <li><code class="language-plaintext highlighter-rouge">myCoding.version</code> <strong>has no value</strong></li>
    </ul>
  </li>
  <li>
    <p>Example of how <strong>incorrectly</strong> ordered rules can lead to loss of a previously-assigned value, because <code class="language-plaintext highlighter-rouge">myCoding</code> is cleared as part of the second assignment:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCoding.userSelected = true
* myCoding = $SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
    <p>The result is:</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">system</code> is http://snomed.info/sct</li>
      <li><code class="language-plaintext highlighter-rouge">code</code> is "363346000"</li>
      <li><code class="language-plaintext highlighter-rouge">display</code> is "Malignant neoplastic disease (disorder)"</li>
      <li><code class="language-plaintext highlighter-rouge">userSelected</code> <strong>has no value</strong></li>
    </ul>
  </li>
  <li>
    <p>The correct way to approach the previous example is to reverse the order of the assignments:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCoding = $SCT#363346000 "Malignant neoplastic disease (disorder)"
* myCoding.userSelected = true
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="assignments-with-the-codeableconcept-data-type">Assignments with the CodeableConcept Data Type</h5>

<p>A CodeableConcept consists of an array of Codings and a text. To populate the array in an instance, array indices, denoted by brackets, are used. The shorthand is:</p>

<pre><code>* &lt;CodeableConcept&gt;.coding[{index}] = <span class="optional">{CodeSystem}|{version string}</span>#{code} <span class="optional">"{display string}"</span></code></pre>

<p>The syntax on the right side is precisely like setting a Coding, as discussed directly above.</p>

<p>To set the first Coding in a CodeableConcept, FSH offers the following shortcut:</p>

<pre><code>* &lt;CodeableConcept&gt; = <span class="optional">{CodeSystem}|{version string}</span>#{code} <span class="optional">"{display string}"</span></code></pre>

<p>Whenever the shortcut rule is applied, the value on the right side SHALL <strong>entirely replace</strong> any previous value of the CodeableConcept on the left side. Any previous value(s) in the CodeableConcept are cleared.</p>

<p>Assignment rules MAY be used to set any part of a CodeableConcept. For example, to set the top-level <code class="language-plaintext highlighter-rouge">text</code> attribute of a CodeableConcept, the FSH expression is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;CodeableConcept&gt;.text = "{string}"
</code></pre></div></div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Set the first Coding in <code class="language-plaintext highlighter-rouge">myCodeableConcept</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept = $SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>An equivalent representation, using an explicit array index on the <code class="language-plaintext highlighter-rouge">coding</code> array:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept.coding[0] = $SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Another equivalent representation, using the shorthand that allows dropping the <code class="language-plaintext highlighter-rouge">[0]</code> index:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept.coding = $SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a second value to the array of Codings:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept.coding[1] = $ICD#C80.1 "Malignant (primary) neoplasm, unspecified"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the top-level <code class="language-plaintext highlighter-rouge">text</code> attribute:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept.text = "Diagnosis of malignant neoplasm left breast."
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of <strong>incorrect</strong> ordering rules that lead to loss of a previously-assigned value, because the last assignment clears the existing value of <code class="language-plaintext highlighter-rouge">myCodeableConcept</code> before it applies new values:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept.coding[0].userSelected = true
* myCodeableConcept.text = "Metastatic Cancer"
* myCodeableConcept = $SCT#363346000 "Malignant neoplastic disease (disorder)"
</code></pre></div>    </div>
    <p>The result is:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">coding[0].system</code> is http://snomed.info/sct</li>
      <li><code class="language-plaintext highlighter-rouge">coding[0].code</code> is "363346000"</li>
      <li><code class="language-plaintext highlighter-rouge">display</code> is "Malignant neoplastic disease (disorder)"</li>
      <li><code class="language-plaintext highlighter-rouge">coding[0].userSelected</code> <strong>has no value</strong></li>
      <li><code class="language-plaintext highlighter-rouge">text</code> <strong>has no value</strong></li>
    </ul>
  </li>
  <li>
    <p>The correct way to approach the previous example is to set the values of <code class="language-plaintext highlighter-rouge">userSelected</code> and <code class="language-plaintext highlighter-rouge">text</code> <strong>after</strong> setting the <code class="language-plaintext highlighter-rouge">coding</code>, since those assignments only change the specific subelements on the left side of those assignments:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* myCodeableConcept = $SCT#363346000 "Malignant neoplastic disease (disorder)"
* myCodeableConcept.coding[0].userSelected = true
* myCodeableConcept.text = "Metastatic Cancer"
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="assignments-with-the-quantity-data-type">Assignments with the Quantity Data Type</h5>

<p>FSH provides a shorthand that allows quantities, units of measure, and display string for the units of measure to be specified simultaneously, provided the units of measure are <a href="http://unitsofmeasure.org/">Unified Code for Units of Measure</a> (UCUM) codes:</p>

<pre><code>* &lt;Quantity&gt; = {decimal} '{UCUM code}' <span class="optional">"{units display string}"</span></code></pre>

<p>A similar shorthand MAY be used for other code systems by specifying the unit using the standard FSH code syntax:</p>

<pre><code>* &lt;Quantity&gt; = {decimal} {CodeSystem}<span class="optional">|{version string}</span>#{code} <span class="optional">"{units display string}"</span></code></pre>

<p>Alternatively, the value and units MAY also be set independently. To assign a value, use the <code class="language-plaintext highlighter-rouge">Quantity.value</code> property:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;Quantity&gt;.value = {decimal}
</code></pre></div></div>

<p>The units of measure MAY be set independently by assigning a UCUM unit without the value:</p>

<pre><code>* &lt;Quantity&gt; = '{UCUM code}' <span class="optional">"{units display string}"</span></code></pre>

<p>For non-UCUM units, the units of measure MAY be set independently by assigning a coded value to a Quantity:</p>

<pre><code>* &lt;Quantity&gt; = <span class="optional">{CodeSystem}|{version string}</span>#{code} <span class="optional">"{units display string}"</span></code></pre>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Set the <code class="language-plaintext highlighter-rouge">valueQuantity</code> of an Observation to 55 millimeters using UCUM units:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = 55.0 'mm'
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the <code class="language-plaintext highlighter-rouge">valueQuantity</code> of an Observation to 55 millimeters using UCUM units and a display string:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = 55.0 'mm' "millimeter"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the numerical value of <code class="language-plaintext highlighter-rouge">Observation.valueQuantity</code> to 55.0 without setting the units:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity.value = 55.0
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the units of <code class="language-plaintext highlighter-rouge">Observation.valueQuantity</code> to millimeters, using UCUM units and a display string, without setting the value:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = 'mm' "millimeter"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Express a weight in pounds, using the UMLS code for units (not recommended), and displaying "pounds":</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = 155.0 http://terminology.hl7.org/CodeSystem/umls#C0439219 "pounds"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the units of <code class="language-plaintext highlighter-rouge">Observation.valueQuantity</code> to pounds, using the UMLS unit code (not recommended) and a display string, without setting the value (assuming <code class="language-plaintext highlighter-rouge">$UMLS</code> has been defined as an alias for http://terminology.hl7.org/CodeSystem/umls):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = $UMLS#C0439219 "pounds"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Example of how <strong>incorrect</strong> ordering of rules can result in the loss of a previously assigned value:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity.unit = "millimeter"
* valueQuantity = 55.0 'mm'
</code></pre></div>    </div>
    <p>Note that the second rule <strong>clears</strong> <code class="language-plaintext highlighter-rouge">valueQuantity</code> in its entirety before applying the specified values, so the result is:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">value</code> is 55.0</li>
      <li><code class="language-plaintext highlighter-rouge">system</code> is http://unitsofmeasure.org</li>
      <li><code class="language-plaintext highlighter-rouge">code</code> is "mm"</li>
      <li><code class="language-plaintext highlighter-rouge">unit</code> <strong>has no value</strong></li>
    </ul>
  </li>
  <li>
    <p>The correct way to approach the previous example, so unit has the desired value, is simply to reverse the order of rules:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = 55.0 'mm'
* valueQuantity.unit = "millimeter"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Another way to approach this example (with the correct result) is:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity = $UCUM#mm "millimeter"
* valueQuantity.value = 55.0
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="assignments-involving-references">Assignments Involving References</h5>

<p>Resource instances MAY refer to other resource instances. The referred resources can either exist independently or be contained inline in the <code class="language-plaintext highlighter-rouge">DomainResource.contained</code> array. Less commonly, the value of an element can be a resource, rather than a reference to a resource.</p>

<p>A resource reference is assigned using this syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;Reference&gt; = Reference({Resource})
</code></pre></div></div>

<p>For assignment of a resource to the value of an element directly:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;Resource&gt; = {Resource}
</code></pre></div></div>

<p>As <a href="https://hl7.org/fhir/R5/references.html#canonical">advised in FHIR</a>, the URL is the preferred way to reference an instance for the resource types on which it is defined. One advantage is that the URL MAY include a version. For an internal FSH-defined instance, referring to an instance by its id (as defined in the <code class="language-plaintext highlighter-rouge">Instance</code> declaration) is more typical (see examples).</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Assignment of a reference to an example of a Patient resource to <code class="language-plaintext highlighter-rouge">Observation.subject</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* subject = Reference(EveAnyperson)
</code></pre></div>    </div>

    <p>where, for example:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: EveAnyperson   // this is the id of the example instance
InstanceOf: Patient
Description: "Eve Anyperson"
Usage: #example
* name.given = "Eve"
* name.family = "Anyperson"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assignment of the same instance in <code class="language-plaintext highlighter-rouge">Bundle.entry.resource</code>, whose datatype is Resource (not Reference(Resource)):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* entry[0].resource = EveAnyperson
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="assignments-with-the-codeablereference-data-type">Assignments with the CodeableReference Data Type</h5>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>The <a href="https://hl7.org/fhir/R5/references.html#codeablereference">CodeableReference</a> datatype was introduced as part of FHIR R5 release sequence. This type allows for a concept, a reference, or both. FSH supports applying bindings directly to CodeableReferences and directly constraining types on CodeableReferences. When applying a type rule (e.g., <code class="language-plaintext highlighter-rouge">code only CodeableReference(Medication)</code>), the element's <code class="language-plaintext highlighter-rouge">reference</code> property SHALL be constrained to the given type, but its <code class="language-plaintext highlighter-rouge">concept</code> property SHALL remain available for use (unless otherwise constrained by another rule).</p>

  <p>To assign values to a CodeableReference, authors MAY assign a FSH Coding or reference directly to the CodeableReference element. Assigning a Coding to a CodeableReference element SHALL assign the Coding to the element's <code class="language-plaintext highlighter-rouge">concept</code> property. Assigning a reference to a CodeableReference element SHALL assign the reference to the element's <code class="language-plaintext highlighter-rouge">reference</code> property. Assigning a Coding SHALL NOT affect the CodeableReference's <code class="language-plaintext highlighter-rouge">reference</code> property. Similarly, assigning a reference SHALL NOT affect the CodeableReference's <code class="language-plaintext highlighter-rouge">concept</code> property. If preferred, authors MAY assign a CodeableConcept's <code class="language-plaintext highlighter-rouge">concept</code> and <code class="language-plaintext highlighter-rouge">reference</code> properties directly.</p>

  <p><strong>Examples:</strong></p>

  <ul>
    <li>
      <p>Constrain <code class="language-plaintext highlighter-rouge">Substance.code</code>, which is datatype <code class="language-plaintext highlighter-rouge">CodeableReference(SubstanceDefinition)</code> in FHIR R5:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: LatexSubstance
Parent: Substance
Id:     latex-substance
Description: "A substance consisting of or containing latex"
// restrict the CodeableConcept aspect to a code in the LatexCodeVS value set:
* code from LatexCodeVS (required)
// restrict Reference aspect to an instance of SubstanceDefinition conforming to the LatexSubstanceDefinition profile:
* code only CodeableReference(LatexSubstanceDefinition)
</code></pre></div>      </div>
    </li>
    <li>
      <p>Assign the <code class="language-plaintext highlighter-rouge">concept</code> and <code class="language-plaintext highlighter-rouge">reference</code> properties of a CodeableReference by assigning values directly to the CodeableReference element:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance:   LatexSubstanceExample
InstanceOf: LatexSubstance
Title:  "Natural Rubber"
Description: "Natural rubber latex substance"
* code = $SCT#1003754000 "Natural rubber latex (substance)"
* code = Reference(NaturalLatexSubstanceDefinitionExample)
</code></pre></div>      </div>
    </li>
    <li>
      <p>Assign the <code class="language-plaintext highlighter-rouge">concept</code> and <code class="language-plaintext highlighter-rouge">reference</code> properties of a CodeableReference by assigning values directly to each property. This has the same result as the example above:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance:   LatexSubstanceExample
InstanceOf: LatexSubstance
Title:  "Natural Rubber"
Description: "Natural rubber latex substance"
* code.concept = $SCT#1003754000 "Natural rubber latex (substance)"
* code.reference = Reference(NaturalLatexSubstanceDefinitionExample)
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<h5 id="assignments-with-caret-paths">Assignments with Caret Paths</h5>

<p>When the left side of an assignment rule contains a caret path, the value SHALL be assigned to the corresponding path within the underlying definitional instance of the FSH item. For more information about caret paths, see <a href="#caret-paths">Caret Paths</a>.</p>

<p><strong>Examples</strong></p>

<ul>
  <li>
    <p>Assign the <code class="language-plaintext highlighter-rouge">experimental</code> flag in a profile's StructureDefinition to <code class="language-plaintext highlighter-rouge">true</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^experimental = true
</code></pre></div>    </div>
  </li>
  <li>
    <p>Override the auto-generated url in an extension's StructureDefinition with a custom url:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ^url = "http://example.org/custom/myextension"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign the short description and definition for the <code class="language-plaintext highlighter-rouge">Observation.value[x]</code> ElementDefinition in an Observation profile:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* value[x] ^short = "Measurement in cm"
* value[x] ^definition = "The measurement in centimeters. Values in other units must be converted to centimeters in order to conform with this profile."
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign the short description and definition for the <code class="language-plaintext highlighter-rouge">Observation.value[x]</code> ElementDefinition in an Observation profile using <a href="#indented-rules">indented rules</a>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* value[x]
  * ^short = "Measurement in cm"
  * ^definition = "The measurement in centimeters. Values in other units must be converted to centimeters in order to conform with this profile."
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign <a href="#code-metadata">code metadata</a> <code class="language-plaintext highlighter-rouge">designation.use</code> for the <code class="language-plaintext highlighter-rouge">#active</code> code within a CodeSystem:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* #active ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign <a href="#concept-metadata">concept metadata</a> for a concept within a ValueSet using <a href="#indented-rules">indented rules</a>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* include $SCT#84162001  "Cold"
  * ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
  * ^designation[0].value = "Cold sensation quality (qualifier value)"
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="binding-rules">Binding Rules</h4>

<p>Binding is the process of associating a coded element with a set of possible values. The syntax to bind a value set, or alter an inherited binding, uses the reserved word <code class="language-plaintext highlighter-rouge">from</code>:</p>

<pre><code>* &lt;bindable&gt; from {ValueSet} <span class="optional">({strength})</span></code></pre>

<p>The bindable types SHALL be the same as the bindable types in FHIR: <a href="https://hl7.org/fhir/R5/terminologies.html#4.1">code, Coding, CodeableConcept, Quantity, string, and uri</a>. In FHIR R5, <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span> CodeableReference</span> SHALL also be bindable.</p>

<p>The strengths SHALL be the same as the <a href="https://hl7.org/fhir/R5/valueset-binding-strength.html">binding strengths defined in FHIR</a>, namely: <code class="language-plaintext highlighter-rouge">example</code>, <code class="language-plaintext highlighter-rouge">preferred</code>, <code class="language-plaintext highlighter-rouge">extensible</code>, and <code class="language-plaintext highlighter-rouge">required</code>. If strength is not specified, a required binding SHALL be assumed.</p>

<p>The <a href="https://hl7.org/fhir/R5/profiling.html#binding">binding rules defined in FHIR</a> SHALL be applicable to FSH. In particular:</p>

<ul>
  <li>When constraining an existing binding, the binding strength SHALL stay the same or be strengthened (e.g., a preferred binding MAY be replaced with an extensible or required binding).</li>
  <li>A required value set MAY be replaced by another required value set if the codes in the new value set are a subset of the codes in the original value set.</li>
  <li>For extensible bindings, the new value set MAY contain codes not in the original value set, but additional codes MUST NOT have meanings covered by codes in the original value set.</li>
</ul>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Bind to an externally-defined value set using its canonical URL:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* category from http://hl7.org/fhir/ValueSet/observation-category (required)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Bind to an externally-defined value set with required binding by default:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* gender from http://hl7.org/fhir/ValueSet/administrative-gender
</code></pre></div>    </div>
  </li>
  <li>
    <p>Bind to a value set using an alias name, assuming <code class="language-plaintext highlighter-rouge">$AdGen</code> is an alias for http://hl7.org/fhir/ValueSet/administrative-gender:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* gender from $AdGen
</code></pre></div>    </div>
  </li>
  <li>
    <p>Bind to a value set by its name when it is defined in the same FSH project:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* code from CancerConditionVS (extensible)
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="cardinality-rules">Cardinality Rules</h4>

<p>Cardinality rules constrain (narrow) the number of repetitions of an element. Every element has a cardinality inherited from its parent resource or profile. If the inheriting profile does not alter the cardinality, no cardinality rule is required.</p>

<p>To change the cardinality, the syntax is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; {min}..{max}

* &lt;element&gt; {min}..   // leave max as-is

* &lt;element&gt; ..{max}   // leave min as-is
</code></pre></div></div>

<p>As in FHIR, <code class="language-plaintext highlighter-rouge">min</code> MUST be a non-negative integer and <code class="language-plaintext highlighter-rouge">max</code> MUST be a non-negative integer or *, representing unbounded. Authors MAY include both the <code class="language-plaintext highlighter-rouge">min</code> and <code class="language-plaintext highlighter-rouge">max</code>, even if one of them remains the same as in the original cardinality. In this case, FSH implementations SHOULD only generate constraints for the changed values.</p>

<p>Cardinalities MUST follow <a href="https://hl7.org/fhir/R5/conformance-rules.html#cardinality">rules of FHIR profiling</a>, namely that the <code class="language-plaintext highlighter-rouge">min</code> and <code class="language-plaintext highlighter-rouge">max</code> cardinalities comply within the constraints of the parent.</p>

<p>For convenience and compactness, cardinality rules MAY be combined with <a href="#flag-rules">flag rules</a> via the following syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; {card} {flag}

* &lt;element&gt; {card} {flag1} {flag2} {flag3}...
</code></pre></div></div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Set the cardinality of the <code class="language-plaintext highlighter-rouge">subject</code> element to 1..1 (required, non-repeating):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* subject 1..1
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the cardinality of the <code class="language-plaintext highlighter-rouge">subject</code> element to 1..1 and declare it Must Support:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* subject 1..1 MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set the cardinality of a sub-element to 0..0 (not permitted):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component.referenceRange 0..0
</code></pre></div>    </div>
  </li>
  <li>
    <p>Require at least one <code class="language-plaintext highlighter-rouge">category</code> without changing its upper bound:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* category 1..
</code></pre></div>    </div>
  </li>
  <li>
    <p>Allow at most one <code class="language-plaintext highlighter-rouge">category</code> without changing its lower bound:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* category ..1
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="contains-rules-for-extensions">Contains Rules for Extensions</h4>

<p>Extensions are created by adding elements to extension arrays. Extension arrays are found at the root level of every resource, nested inside every element, and recursively inside each extension. The structure of extensions is defined by FHIR (see <a href="https://hl7.org/fhir/R5/extensibility.html#extension">Extension element</a>). Profiling extensions is discussed in <a href="#defining-extensions">Defining Extensions</a>.</p>

<p>Extensions SHALL be specified using the <code class="language-plaintext highlighter-rouge">contains</code> keyword. There are two types of extensions, <em>standalone</em> and <em>inline</em>:</p>

<ul>
  <li>Standalone extensions have their own StructureDefinitions, and MAY be reused. They MAY be defined internally (in the same FSH project), or externally in core FHIR or an external IG. Only standalone extensions MAY be used directly in profiles.</li>
  <li>Inline extensions do not have StructureDefinitions, and SHALL NOT be directly reused in other profiles. Inline extensions SHALL only be used to specify sub-extensions in a complex (nested) extension.</li>
</ul>

<p>The syntaxes to specify standalone extension(s) are:</p>

<pre><code>* &lt;extension&gt; contains {Extension} named {name} {card} <span class="optional">{flag(s)}</span>

* &lt;extension&gt; contains
    {Extension1} named {name1} {card} <span class="optional">{flag(s)}</span> and
    {Extension2} named {name2} {card} <span class="optional">{flag(s)}</span> and
    {Extension3} named {name3} {card} <span class="optional">{flag(s)}</span> ...
</code></pre>

<p>The syntaxes to define inline extension(s) are:</p>

<pre><code>* &lt;extension&gt; contains {name} {card} <span class="optional">{flag(s)}</span>

* &lt;extension&gt; contains
    {name1} {card} <span class="optional">{flag(s)}</span> and
    {name2} {card} <span class="optional">{flag(s)}</span> and
    {name3} {card} <span class="optional">{flag(s)}</span> ...</code></pre>

<p>In these expressions, the names (<code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">name1</code>, <code class="language-plaintext highlighter-rouge">name2</code>, etc.) are new local names created by the rule author. They are used to refer to that extension in later rules. By convention, the local names SHOULD be <a href="https://wiki.c2.com/?CamelCase">lower camelCase</a>. Implementers SHALL export these names as slice names in the generated StructureDefinition.</p>

<blockquote>
  <p><strong>Note:</strong> Contains rules MAY also be applied to <code class="language-plaintext highlighter-rouge">modifierExtension</code> arrays by replacing <code class="language-plaintext highlighter-rouge">extension</code> with <code class="language-plaintext highlighter-rouge">modifierExtension</code> in the above syntaxes.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Add standalone FHIR extensions <a href="https://hl7.org/fhir/extensions/StructureDefinition-patient-disability.html">patient-disability</a> and <a href="https://hl7.org/fhir/extensions/StructureDefinition-individual-genderIdentity.html">individual-genderIdentity</a> to a profile of the Patient resource, using the canonical URLs for the extensions:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* extension contains http://hl7.org/fhir/StructureDefinition/patient-disability named disability 0..1 MS and http://hl7.org/fhir/StructureDefinition/individual-genderIdentity named genderIdentity 0..1 MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>The same statement, using aliases and whitespace flexibility for better readability:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias: $Disability = http://hl7.org/fhir/StructureDefinition/patient-disability
Alias: $GenderIdentity = http://hl7.org/fhir/StructureDefinition/individual-genderIdentity
  
// intervening lines not shown

* extension contains
      $Disability named disability 0..1 MS and
      $GenderIdentity named genderIdentity 0..1 MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add standalone FHIR modifier extension <a href="https://hl7.org/fhir/extensions/StructureDefinition-request-doNotPerform.html">request-doNotPerform</a> to a profile of the NutritionOrder resource, using an alias:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias: $DoNotPerform = http://hl7.org/fhir/StructureDefinition/request-doNotPerform

// intervening lines not shown

* modifierExtension contains $DoNotPerform named doNotPerform 0..1 MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a standalone extension <code class="language-plaintext highlighter-rouge">Laterality</code>, defined in the same FSH project, to a <code class="language-plaintext highlighter-rouge">bodySite</code> attribute (second level extension):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* bodySite.extension contains Laterality named laterality 0..1

// intervening lines not shown

Extension: Laterality
Description: "Body side of a body location."
* value[x] only CodeableConcept
* value[x] from LateralityVS (required)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Show how the inline extensions defined in the <a href="https://hl7.org/fhir/us/core/StructureDefinition-us-core-race.html">US Core Race</a> extension would be defined using FSH:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* extension contains
    ombCategory 0..5 MS and
    detailed 0..* and
    text 1..1 MS
// rules defining the inline extensions would typically follow:
* extension[ombCategory].value[x] only Coding
* extension[ombCategory].value[x] from http://hl7.org/fhir/us/core/ValueSet/omb-race-category (required)
* extension[text].value[x] only string
// etc.
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="contains-rules-for-slicing">Contains Rules for Slicing</h4>

<p>Slicing is an advanced, but necessary, feature of FHIR. It is helpful to have a basic understanding of <a href="https://hl7.org/fhir/R5/profiling.html#slicing">slicing</a> and <a href="https://hl7.org/fhir/R5/profiling.html#discriminator">discriminators</a> before attempting slicing in FSH.</p>

<p>In FSH, slicing is addressed in three steps: (1) specify the slicing logic, (2) define the slices, and (3) constrain each slice's contents.</p>

<blockquote>
  <p><strong>Note:</strong> The rules from each step MUST be sequentially ordered, i.e., step (1) slicing logic rules before step (2) slice definition rules before step (3) slice content rules.</p>
</blockquote>

<h5 id="step-1-specify-the-slicing-logic">Step 1. Specify the Slicing Logic</h5>

<p>To create slicings in FHIR, authors MUST specify a <a href="https://hl7.org/fhir/R5/profiling.html#discriminator">discriminator path, type, and rules</a>. In addition, authors MAY optionally declare the slice as ordered or unordered (default: unordered), and/or provide a description. The meaning and allowable values SHALL be exactly <a href="https://hl7.org/fhir/R5/profiling.html#discriminator">as defined in FHIR</a>.</p>

<p>The slicing logic parameters MUST be specified using <a href="#caret-paths">caret paths</a> on the element to be sliced, which is typically a multi-cardinality (array) element. The discriminator path SHALL identify the element used to distinguish each slice. The discriminator type SHALL determine how the slices are differentiated, e.g., by value, pattern, existence of the sliced element, datatype of sliced element, position of the sliced element (R5 and up), or profile conformance.</p>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Provide slicing logic for slices on <code class="language-plaintext highlighter-rouge">Observation.component</code> that are to be distinguished by their sub-element <code class="language-plaintext highlighter-rouge">code</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component ^slicing.discriminator.type = #pattern
* component ^slicing.discriminator.path = "code"
* component ^slicing.rules = #open
* component ^slicing.ordered = false   // can be omitted, since false is the default
* component ^slicing.description = "Slice based on the component.code pattern"
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="step-2-define-the-slices">Step 2. Define the Slices</h5>

<p>The second step in slicing is to populate the array that is to be sliced, using the <code class="language-plaintext highlighter-rouge">contains</code> keyword. The syntaxes are very similar to <a href="#contains-rules-for-extensions">contains rules for inline extensions</a>:</p>

<pre><code>* &lt;array&gt; contains {name} {card} <span class="optional">{flag(s)}</span>

* &lt;array&gt; contains
    {name1} {card} <span class="optional">{flag(s)}</span> and
    {name2} {card} <span class="optional">{flag(s)}</span> and
    {name3} {card} <span class="optional">{flag(s)}</span> ...
</code></pre>

<p>In this pattern, <code class="language-plaintext highlighter-rouge">&lt;array&gt;</code> is a path to the element that is to be sliced and MUST match the path on which the slicing rules were defined in step (1). The names (<code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">name1</code>, etc.) are created by the rule author to describe the slice in the context of the profile. These names are used to refer to the slice in later rules. By convention, the slice names SHOULD be <a href="https://wiki.c2.com/?CamelCase">lower camelCase</a>.</p>

<p>Each slice matches or constrains the datatype of the array it slices. In particular:</p>

<ul>
  <li>If the sliced element is an array of a FHIR datatype, each slice will be the same datatype or a profile of it. For example, if <code class="language-plaintext highlighter-rouge">Observation.identifier</code> is sliced, each slice will have type Identifier or be constrained to a profile of the Identifier datatype.</li>
  <li>If the sliced element is an array of a backbone element, each slice "inherits" the sub-elements of the backbone. For example, the slices of <code class="language-plaintext highlighter-rouge">Observation.component</code> possess all the elements of <code class="language-plaintext highlighter-rouge">Observation.component</code> (<code class="language-plaintext highlighter-rouge">code</code>, <code class="language-plaintext highlighter-rouge">value[x]</code>, <code class="language-plaintext highlighter-rouge">dataAbsentReason</code>, etc.). Constraints MAY be applied to the slices.</li>
  <li>If the sliced element is an array of a Reference, then each slice MUST be a reference to one or more of the allowed Reference types. For example, if the element to be sliced is Reference(Observation or Condition), then each slice MUST either be Reference(Observation or Condition), Reference(Observation), Reference(Condition), or a profiled version of those resources.</li>
</ul>

<p>FSH implementations MUST add new slices to the StructureDefinition in the order in which they appear within the contains rule. When a FSH definition has multiple contains rules on the same path, these rules MUST be processed in the order in which they appear.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Slice the <code class="language-plaintext highlighter-rouge">Observation.component</code> array for blood pressure:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component contains systolicBP 1..1 MS and diastolicBP 1..1 MS
</code></pre></div>    </div>
  </li>
  <li>
    <p>Because FSH is white-space invariant, the previous example MAY be rewritten so the slices appear one-per-line for readability:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component contains
    systolicBP 1..1 MS and
    diastolicBP 1..1 MS
</code></pre></div>    </div>
  </li>
</ul>

<h6 id="reslicing">Reslicing</h6>

<p>Reslicing (slicing an existing slice) uses a similar syntax, but the left-hand side uses <a href="#sliced-array-paths">slice path syntax</a> to refer to the slice that is being resliced:</p>

<pre><code>* &lt;array[{slice name}]&gt; contains {name} {card} <span class="optional">{flag(s)}</span>

* &lt;array[{slice name}]&gt; contains
    {name1} {card} <span class="optional">{flag(s)}</span> and
    {name2} {card} <span class="optional">{flag(s)}</span> and
    {name3} {card} <span class="optional">{flag(s)}</span> ...
</code></pre>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>In an Observation for Apgar score, reslice the Apgar <code class="language-plaintext highlighter-rouge">respirationScore</code> component slice into one-, five-, and ten-minute scores:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component contains
     appearanceScore 0..3 and
     pulseScore 0..3 and
     grimaceScore 0..3 and
     activityScore 0..3 and
     respirationScore 0..3
* component[respirationScore] contains
    oneMinuteScore 0..1 and
    fiveMinuteScore 0..1 and
    tenMinuteScore 0..1
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="step-3-constrain-the-slice-contents">Step 3. Constrain the Slice Contents</h5>

<p>The final step is to define the properties of each slice. FSH requires slice contents to be defined inline. The rule syntax is the same as constraining any other element, but the <a href="#sliced-array-paths">slice path syntax</a> is used to specify the path:</p>

<pre><code>* &lt;array&gt;[{slice name}]<span class="optional">.&lt;element&gt;</span> {constraint}</code></pre>

<p>The slice content rules MUST appear <em>after</em> the contains rule that creates the slices.</p>

<p><strong>Example:</strong></p>

<ul>
  <li>
    <p>Constrain the content of the <code class="language-plaintext highlighter-rouge">systolicBP</code> and <code class="language-plaintext highlighter-rouge">diastolicBP</code> slices:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* component[systolicBP].code = $LNC#8480-6 // Systolic blood pressure
* component[systolicBP].value[x] only Quantity
* component[systolicBP].value[x] = $UCUM#mm[Hg] "mmHg"
* component[diastolicBP].code = $LNC#8462-4 // Diastolic blood pressure
* component[diastolicBP].value[x] only Quantity
* component[diastolicBP].value[x] = $UCUM#mm[Hg] "mmHg"
</code></pre></div>    </div>
  </li>
</ul>

<p>At minimum, each slice MUST be constrained such that it is uniquely identifiable via the discriminator (see Step 1). For example, if the discriminator path points to an element that is a CodeableConcept, and it discriminates by value or pattern, then each slice MUST constrain that CodeableConcept using an assignment rule or binding rule that uniquely distinguishes it from the other slices.</p>

<p><strong>Complete Slicing Example:</strong></p>

<ul>
  <li>Slice the components of an Observation to represent the dimensions of a tumor:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: TumorSize
Parent:  Observation
Id: example-tumor-size
Title: "Tumor Size"
Description:  "Records the one to three dimensions of a tumor"
* code = $LNC#21889-1 //"Size Tumor"
// other rules omitted
* component ^slicing.discriminator.type = #pattern
* component ^slicing.discriminator.path = "code"
* component ^slicing.rules = #open
* component ^slicing.description = "Slice based on the component.code pattern"
// Contains rule
* component contains tumorLongestDimension 1..1 and tumorOtherDimension 0..2
// Set properties of each slice
* component[tumorLongestDimension] ^short = "Longest tumor dimension"
* component[tumorLongestDimension] ^definition = "The longest tumor dimension in cm or mm."
* component[tumorLongestDimension].code = $LNC#33728-7 // "Size.maximum dimension in Tumor"
* component[tumorLongestDimension].value[x] only Quantity
* component[tumorLongestDimension].value[x] from TumorSizeUnitsVS (required)   // value set defined elsewhere
* component[tumorOtherDimension] ^short = "Other tumor dimension(s)"
* component[tumorOtherDimension] ^definition = "The second or third tumor dimension in cm or mm."
* component[tumorOtherDimension] ^comment = "Additional tumor dimensions should be ordered from largest to smallest."
* component[tumorOtherDimension].code = $LNC#33729-5 // "Size additional dimension in Tumor"
* component[tumorOtherDimension].value[x] only Quantity
* component[tumorOtherDimension].value[x] from TumorSizeUnitsVS (required)
</code></pre></div></div>

<h4 id="exclude-rules">Exclude Rules</h4>

<p>Exclude rules are used to remove codes from value sets. Exclude rules SHALL appear only in ValueSet items. For more details on exclude rules, see <a href="#defining-value-sets">Defining Value Sets</a>.</p>

<h4 id="flag-rules">Flag Rules</h4>

<p>Flags are a set of information about the element that impacts how implementers handle them. The <a href="https://hl7.org/fhir/R5/formats.html#table">flags defined in FHIR</a>, and the symbols used to describe them, are as follows:</p>

<p><span class="caption" id="t1">Table 13. Flags and their meaning</span></p>

<table class="grid">
  <thead>
    <tr>
      <th>FHIR Flag</th>
      <th>FSH Flag</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>S</td>
      <td><code class="language-plaintext highlighter-rouge">MS</code></td>
      <td>Must Support</td>
    </tr>
    <tr>
      <td>Σ</td>
      <td><code class="language-plaintext highlighter-rouge">SU</code></td>
      <td>Include in summary</td>
    </tr>
    <tr>
      <td>?!</td>
      <td><code class="language-plaintext highlighter-rouge">?!</code></td>
      <td>Modifier</td>
    </tr>
    <tr>
      <td>N</td>
      <td><code class="language-plaintext highlighter-rouge">N</code></td>
      <td>Normative element</td>
    </tr>
    <tr>
      <td>TU</td>
      <td><code class="language-plaintext highlighter-rouge">TU</code></td>
      <td>Trial use element</td>
    </tr>
    <tr>
      <td>D</td>
      <td><code class="language-plaintext highlighter-rouge">D</code></td>
      <td>Draft element</td>
    </tr>
  </tbody>
</table>

<p>FHIR also defines the flags I and NE, representing elements affected by constraints, and elements that cannot have extensions, respectively. These flags are not supported in flag syntax, since the I flag is determined by the presence of <a href="#obeys-rules">invariants</a>, and NE flags apply only to infrastructural elements in base resources.</p>

<p>The following syntaxes MAY be used to assign flags:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; {flag}

* &lt;element&gt; {flag1} {flag2}...

* &lt;element1&gt; and &lt;element2&gt; and &lt;element3&gt; ... {flag}

* &lt;element1&gt; and &lt;element2&gt; and &lt;element3&gt; ... {flag1} {flag2}...
</code></pre></div></div>

<blockquote>
  <p><strong>Note:</strong> When multiple flags are specified, they MUST be separated with whitespace(s). When multiple element paths are specified, they MUST be separated by <code class="language-plaintext highlighter-rouge">and</code>.</p>
</blockquote>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Declare <code class="language-plaintext highlighter-rouge">communication</code> to be a Must Support and Summary element:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* communication MS SU
</code></pre></div>    </div>
  </li>
  <li>
    <p>Declare a list of elements and nested elements to be Must Support:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* identifier and identifier.system and identifier.value and name and name.family MS
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="include-rules">Include Rules</h4>

<p>Include rules are used to add codes to value sets. Include rules SHALL appear only in ValueSet items. For more details on include rules, see <a href="#defining-value-sets">Defining Value Sets</a>.</p>

<h4 id="insert-rules">Insert Rules</h4>

<p><a href="#defining-rule-sets">Rule sets</a> are reusable groups of rules that are defined independently of other items. An insert rule is used to add the contents of a rule set to an item:</p>

<pre><code>* insert {RuleSet}<span class="optional">({parameters})</span>
</code></pre>

<p>The rules in the named rule set are interpreted as if they were copied and pasted in the designated location (with parameter placeholders replaced as described below).</p>

<p>Each rule in the rule set MUST be compatible with the item where the rule set is inserted, in the sense that all the rules defined in the rule set apply to elements actually present in the target. Implementations SHOULD check the legality of a rule set at compile time. If a particular rule from a rule set does not match an element in the target, that rule MUST NOT be applied, and an error SHOULD be emitted. It is up to implementations if other valid rules from the rule set are applied.</p>

<h5 id="inserting-simple-non-parameterized-rule-sets">Inserting Simple (Non-Parameterized) Rule Sets</h5>

<p>Insert a simple rule set by using the name of the rule set:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* insert {RuleSet}
</code></pre></div></div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Insert the rule set named <a href="#simple-rule-sets">RuleSet1</a> into a profile:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: MyPatientProfile
Parent: Patient
Id: my-patient-profile
Title: "My Patient Profile"
Description: "An example patient profile."
* insert RuleSet1
* deceased[x] only boolean
// More profile rules
</code></pre></div>    </div>

    <p>This is equivalent to the following:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: MyPatientProfile
Parent: Patient
Id: my-patient-profile
Title: "My Patient Profile"
Description: "An example patient profile."
* ^status = #draft
* ^experimental = true
* ^publisher = "Elbonian Medical Society"
* deceased[x] only boolean
// More profile rules
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use rule sets to define two different national profiles, using a common clinical profile:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: USBreastRadiologyObservationProfile
Parent: BreastRadiologyObservationProfile
Id: us-breast-radiology
Title: "US Breast Radiology Profile"
Description: "Breast Radiology Profile with US-specific constraints"
* insert USObservationRuleSet
</code></pre></div>    </div>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: FranceBreastRadiologyObservationProfile
Parent: BreastRadiologyObservationProfile
Id: france-breast-radiology
Title: "France Breast Radiology Profile"
Description: "Breast Radiology Profile with France-specific constraints"
* insert FranceObservationRuleSet
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="inserting-parameterized-rule-sets">Inserting Parameterized Rule Sets</h5>

<p>To insert a parameterized rule set, use the rule set name with a list of one or more parameter values:</p>

<pre><code>* insert {RuleSet}(value1<span class="optional">, value2, value3...</span>)
</code></pre>

<p>As indicated, the list of values MUST be enclosed with parentheses <code class="language-plaintext highlighter-rouge">()</code> and separated by commas <code class="language-plaintext highlighter-rouge">,</code>. To put literal <code class="language-plaintext highlighter-rouge">)</code> or <code class="language-plaintext highlighter-rouge">,</code> characters inside values, authors MUST escape them with a backslash: <code class="language-plaintext highlighter-rouge">\)</code> and <code class="language-plaintext highlighter-rouge">\,</code>, respectively. White space separating values is OPTIONAL, and SHALL be removed before the value is applied to the rule set definition.</p>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>Alternatively, a parameter value MAY be surrounded by double square brackets <code class="language-plaintext highlighter-rouge">[[</code> <code class="language-plaintext highlighter-rouge">]]</code>. Literal <code class="language-plaintext highlighter-rouge">)</code> and <code class="language-plaintext highlighter-rouge">,</code> characters within the double square brackets SHOULD NOT be escaped with a backslash<sup>*</sup>. Use of double brackets makes sense when a parameter requires multiple escape characters.</p>

  <p><sup>*</sup> The only exception to this is when the author wants to include <code class="language-plaintext highlighter-rouge">]],</code> or <code class="language-plaintext highlighter-rouge">]])</code> as part of the parameter value. In this case, the <code class="language-plaintext highlighter-rouge">)</code> or <code class="language-plaintext highlighter-rouge">,</code> following the <code class="language-plaintext highlighter-rouge">]]</code> MUST be escaped with a backslash. For example, to include <code class="language-plaintext highlighter-rouge">]],</code> as part of a parameter value within double square brackets, use <code class="language-plaintext highlighter-rouge">]]\,</code>. This MUST be done even if there is whitespace between the <code class="language-plaintext highlighter-rouge">]]</code> and <code class="language-plaintext highlighter-rouge">,</code> or <code class="language-plaintext highlighter-rouge">)</code>. For example, to include <code class="language-plaintext highlighter-rouge">]] )</code> as part of a parameter within double square brackets, use <code class="language-plaintext highlighter-rouge">]] \)</code>. Additionally, note that the full value MUST be surrounded with double square brackets in order for this type of processing to occur.</p>
</div>

<p>The values provided SHALL be substituted into the named rule set to create the rules that will be applied. The number of values provided MUST match the number of parameters specified in the rule set definition.</p>

<p>Any FSH syntax errors that arise as a result of the value substitution SHALL be handled the same way as FSH syntax errors in the declaration of a rule set without parameters. FSH implementers MAY perform the value substitution without checking the types of the values being substituted or the semantic validity of the resulting rules. Any invalid rules resulting from inserting a parameterized rule set SHOULD be detected at the same time as invalid rules resulting from inserting a simple rule set.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Use the parameterized rule set, <code class="language-plaintext highlighter-rouge">Name</code>, to populate an instance of Patient with multiple names (note that the curly brackets in this example are literal, not syntax expressions):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: Name(first, last)
* name[+].given = "{first}"
* name[=].family = "{last}"
</code></pre></div>    </div>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: MrSmith
InstanceOf: Patient
Title: "Mr. Smith"
Description: "The patient Robert Smith"
// some rules
* insert Name(Robert, Smith)
* insert Name(Rob, Smith)
* insert Name(Bob, Smith)
// more rules
</code></pre></div>    </div>

    <p>When the rule set is expanded and soft indices are resolved, this is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: MrSmith
InstanceOf: Patient
Title: "Mr. Smith"
Description: "The patient Robert Smith"
// some rules
* name[0].given = "Robert"
* name[0].family = "Smith"
* name[1].given = "Rob"
* name[1].family = "Smith"
* name[2].given = "Bob"
* name[2].family = "Smith"
// more rules
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use the parameterized rule set, <code class="language-plaintext highlighter-rouge">Phone</code>, to add a phone number to an instance of Organization (note the use of backslash to escape a closing parenthesis):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: Phone(value)
* telecom[+].system = #phone
* telecom[=].value = "{value}"
</code></pre></div>    </div>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: AcmeOrganization
InstanceOf: Organization
Title: "Acme Organization"
Description: "The Acme Organization"
// some rules
* insert Phone( (800\)555-1234 )
// more rules
</code></pre></div>    </div>

    <p>When the rule set is expanded and soft indices are resolved, this is equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: AcmeOrganization
InstanceOf: Organization
Title: "Acme Organization"
Description: "The Acme Organization"
// some rules
* telecom[0].system = #phone
* telecom[0].value = "(800)555-1234"
// more rules
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Use the parameterized rule set, <code class="language-plaintext highlighter-rouge">AddVariableToTestScript</code>, to add variable definitions to an instance of TestScript (note the use of double brackets to avoid the need to escape closing parentheses and commas):</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: AddVariableToTestScript(name, expression)
* variable[+].name = "{name}"
* variable[=].expression = "{expression}"
</code></pre></div>      </div>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: MyTest
InstanceOf: TestScript
Title: "My Test Script"
Description: "A small test with a few FHIRPath expressions"
// some rules
* insert AddVariableToTestScript( firstObservation, [[component.all(valueSampledData.exists())]] )
* insert AddVariableToTestScript (testResponse, [[resource.repeat(item).answer.value.extension.value.aggregate($this+$total,0)]])
// more rules
</code></pre></div>      </div>

      <p>When the rule set is expanded and soft indices are resolved, this is equivalent to:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instance: MyTest
InstanceOf: TestScript
Title: "My Test Script"
Description: "A small test with a few FHIRPath expressions"
// some rules
* variable[0].name = "firstObservation"
* variable[0].expression = "component.all(valueSampledData.exists())"
* variable[1].name = "testResponse"
* variable[1].expression = "resource.repeat(item).answer.value.extension.value.aggregate($this+$total,0)"
// more rules
</code></pre></div>      </div>
    </li>
  </ul>
</div>

<h5 id="inserting-rule-sets-with-path-context">Inserting Rule Sets with Path Context</h5>

<p>Rule sets MAY be inserted in the context of a path. The context MAY be specified by giving the path prior to the insert rule:</p>

<pre><code>* &lt;element&gt; insert {RuleSet}<span class="optional">(value1, value2, value3...)</span>
</code></pre>

<p>Alternately, the context MAY be specified by indenting the insert rule under another rule that provides a path context (see <a href="#indented-rules">indented rules</a>). The path context from the rule which the insert rule is indented below SHALL be applied to all rules being inserted.</p>

<p>When the rule set is expanded, the path of the element SHALL be prepended to the path of all rules in the rule set.</p>

<p>When defining a Code System, rule sets MAY be inserted in the context of a concept. The context MAY be specified by giving the concept (or hierarchy of concepts, for child codes) prior to the insert rule or by indenting it below another concept:</p>

<pre><code>* &lt;concept&gt; insert {RuleSet}<span class="optional">(value1, value2, value3...)</span>
</code></pre>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Insert a rule set into a profile specifying an element:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: NameRules
* family MS
* given MS

Profile: MyPatientProfile
Parent: Patient
// skip some keywords and rules
* name insert NameRules
* deceased[x] only boolean
// More profile rules
</code></pre></div>    </div>

    <p>An equivalent way to write the profile is:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: MyPatientProfile
Parent: Patient
// skip some keywords and rules
* name 
  * insert NameRules
* deceased[x] only boolean
// More profile rules
</code></pre></div>    </div>

    <p>Both of the above are equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Profile: MyPatientProfile
Parent: Patient
// skip some keywords and rules
* name.family MS
* name.given MS
* deceased[x] only boolean
// More profile rules
</code></pre></div>    </div>
  </li>
  <li>
    <p>Insert a rule set into a code system specifying a concept:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuleSet: DesignationRules
* ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
* ^designation[0].language = #en

CodeSystem: MyCodeSystem
// skip some keywords and rules
* #code-one "Code one"
* #code-one insert DesignationRules
* #code-one #child-code "Child code"
* #code-one #child-code insert DesignationRules
// more code system rules
</code></pre></div>    </div>

    <p>An equivalent way to write the code system is:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CodeSystem: MyCodeSystem
// skip some keywords and rules
* #code-one "Code one"
  * insert DesignationRules
  * #child-code "Child code"
    * insert DesignationRules
// more code system rules
</code></pre></div>    </div>

    <p>Both of the above are equivalent to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CodeSystem: MyCodeSystem
// skip some keywords and rules
* #code-one "Code one"
* #code-one ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
* #code-one ^designation[0].language = #en
* #code-one #child-code "Child code"
* #code-one #child-code ^designation[0].use = $SCT#900000000000003001 "Fully specified name"
* #code-one #child-code ^designation[0].language = #en
// more code system rules
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="local-code-rules">Local Code Rules</h4>

<p>Local codes rules are used to define codes in code systems. Local code rules SHALL appear only in CodeSystem items. For more details on local code rules, see <a href="#defining-code-systems">Defining Code Systems</a>.</p>

<h4 id="mapping-rules">Mapping Rules</h4>

<p>Mapping rules are used to define relationships between different specifications. Mapping rules SHALL appear only in Mapping items. For more details on mapping rules, see <a href="#defining-mappings">Defining Mappings</a>.</p>

<h4 id="obeys-rules">Obeys Rules</h4>

<p><a href="https://hl7.org/fhir/R5/conformance-rules.html#constraints">Invariants</a> are constraints that apply to one or more values in instances, expressed as <a href="https://hl7.org/fhir/R5/fhirpath.html">FHIRPath</a> or <a href="https://developer.mozilla.org/en-US/docs/Web/XPath">XPath</a> expressions. One or more invariants MAY be applied to an instance as a whole or a single element. The syntax for applying invariants in profiles is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* obeys {Invariant}

* obeys {Invariant1} and {Invariant2}...

* &lt;element&gt; obeys {Invariant}

* &lt;element&gt; obeys {Invariant1} and {Invariant2}...
</code></pre></div></div>

<p>The first case applies the invariant to the profile as a whole. The second case applies multiple invariants to the profile as a whole. The third case applies the invariant to a single element, and the fourth case applies multiple invariants to a single element.</p>

<p>The referenced invariant and its properties MUST be declared somewhere within the same FSH project, using the <code class="language-plaintext highlighter-rouge">Invariant</code> keyword. See <a href="#defining-invariants">Defining Invariants</a>.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Assign invariant to US Core Implantable Device (invariant applies to profile as a whole):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* obeys us-core-9
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assign invariant to <code class="language-plaintext highlighter-rouge">Patient.name</code> in US Core Patient:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name obeys us-core-8
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="path-rules">Path Rules</h4>

<p>Path rules are used to set the context for subsequent <a href="#indented-rules">indented rules</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt;
</code></pre></div></div>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>Path rules MAY also be used to indicate the order for slices to appear in an Instance and to include optional fixed values of a path in an Instance. Path rules have no impact on all other FSH entity types; the only purpose of the path rule on those entities is to set context.</p>
</div>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Set a context of <code class="language-plaintext highlighter-rouge">name</code> for subsequent rules:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name
  * given MS
  * family MS
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Indicate the order for slices to appear in an Instance:</p>

      <p>Given a profile that has a required <code class="language-plaintext highlighter-rouge">lab</code> slice on <code class="language-plaintext highlighter-rouge">category</code>, such as:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* category contains lab 1..1
* category[lab] = $OBSCAT#laboratory
</code></pre></div>      </div>

      <p>an Instance of that profile can specify that the <code class="language-plaintext highlighter-rouge">lab</code> slice MUST come before other values on <code class="language-plaintext highlighter-rouge">category</code> by including the following path rule before other rules:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* category[lab]
* category[+] = $EX#example
</code></pre></div>      </div>
    </li>
    <li>
      <p>Include optional fixed values of a path in an Instance:</p>

      <ul>
        <li>
          <p>Given a profile where <code class="language-plaintext highlighter-rouge">name.family</code> is optional and has a fixed value, such as:</p>

          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name.family = "Smith"
</code></pre></div>          </div>

          <p>an Instance of that profile can include the fixed value "Smith" by including the following path rule:</p>

          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name.family
</code></pre></div>          </div>
        </li>
        <li>
          <p>Given a profile with an optional element that has child elements with required fixed values, such as:</p>

          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name 0..*
* name.family 1..1
* name.family = "Smith"
</code></pre></div>          </div>

          <p>an Instance of that profile can include a name with the fixed value "Smith" by including the following path rule:</p>

          <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* name
</code></pre></div>          </div>
        </li>
      </ul>
    </li>
  </ul>
</div>

<h4 id="type-rules">Type Rules</h4>

<p>FSH rules MAY be used to restrict the datatype(s) of an element. The syntaxes are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; only {datatype}

* &lt;element&gt; only {datatype1} or {datatype2} or {datatype3}...

* &lt;element&gt; only Reference({Resource/Profile})

* &lt;element&gt; only Reference({Resource/Profile1} or {Resource/Profile2} or {Resource/Profile3}...)

* &lt;element&gt; only Canonical({Resource/Profile})

* &lt;element&gt; only Canonical({Resource/Profile1} or {Resource/Profile2} or {Resource/Profile3}...)
</code></pre></div></div>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <p>FSH rules MAY also be used to restrict the target types of CodeableReference elements. The syntaxes are:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* &lt;element&gt; only CodeableReference({Resource/Profile})

* &lt;element&gt; only CodeableReference({Resource/Profile1} or {Resource/Profile2} or {Resource/Profile3}...)
</code></pre></div>  </div>
</div>

<p>Certain elements in FHIR offer a choice of datatypes using the <code class="language-plaintext highlighter-rouge">[x]</code> syntax. Choices also frequently appear in references. For example, <code class="language-plaintext highlighter-rouge">Condition.recorder</code> has the choice Reference(Practitioner or PractitionerRole or Patient or RelatedPerson). In both cases, choices MAY be restricted in two ways: reducing the number or choices, and/or substituting a more restrictive datatype or profile for one of the choices appearing in the parent profile or resource. In some cases, the right-hand side of a type rule MAY have a combination of datatype, Reference, Canonical, and <span class="tuSpan"><span class="tuIcon" title="Standards Status = Trial Use">TU</span>CodeableReference<span> targets.</span></span></p>

<p>Following <a href="https://hl7.org/fhir/R5/profiling.html">standard profiling rules established in FHIR</a>, the datatype(s) in a type rule MUST always be more restrictive than the original datatype. For example, if the parent datatype is Quantity, it MAY be replaced by SimpleQuantity, since SimpleQuantity is a profile on Quantity (hence more restrictive than Quantity itself), but MUST NOT be replaced with Ratio, because Ratio is not a type of Quantity. Similarly, <code class="language-plaintext highlighter-rouge">Condition.subject</code>, defined as Reference(Patient or Group), MAY be constrained to Reference(Patient), Reference(Group), or Reference(us-core-patient), but MUST NOT be restricted to Reference(RelatedPerson), since that is neither a Patient nor a Group.</p>

<p><strong>Examples:</strong></p>

<ul>
  <li>
    <p>Restrict a Quantity type to SimpleQuantity:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* valueQuantity only SimpleQuantity
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Condition.onset[x]</code> is a choice of dateTime, Age, Period, Range or string. To restrict <code class="language-plaintext highlighter-rouge">onset[x]</code> to dateTime:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* onset[x] only dateTime
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">onset[x]</code> to either Period or Range:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* onset[x] only Period or Range
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">onset[x]</code> to Age, AgeRange, or DateRange, assuming AgeRange and DateRange are profiles of FHIR's Range datatype (thus permissible restrictions on Range):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* onset[x] only Age or AgeRange or DateRange
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Restrict <code class="language-plaintext highlighter-rouge">value[x]</code> to the integer64 type (note: this datatype was introduced in FHIR R5):</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* value[x] only integer64
</code></pre></div>      </div>
    </li>
  </ul>

</div>

<ul>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">Observation.performer</code> (nominally Reference(Practitioner | PractitionerRole | Organization | CareTeam | Patient | RelatedPerson)) to allow only Practitioner:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* performer only Reference(Practitioner)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">performer</code> to either a Practitioner or a PractitionerRole:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* performer only Reference(Practitioner or PractitionerRole)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">performer</code> to PrimaryCarePhysician or EmergencyRoomPhysician (assuming these are profiles on Practitioner):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* performer only Reference(PrimaryCarePhysician or EmergencyRoomPhysician)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict the Practitioner choice of <code class="language-plaintext highlighter-rouge">performer</code> to a PrimaryCarePhysician, without restricting other choices. Because the path specifically calls out the Practitioner choice, the result is that <code class="language-plaintext highlighter-rouge">performer</code> can reference a Practitioner resource that validates against the PrimaryCareProvider profile or any of the other choices (PractitionerRole, Organization, CareTeam, Patient, and RelatedPerson):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* performer[Practitioner] only Reference(PrimaryCareProvider)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Assuming that LiteralReference is a profile on Reference, restrict the <code class="language-plaintext highlighter-rouge">performer</code> Reference datatype to this LiteralReference profile and its target types to Practitioner or PractitionerRole. Note that the first rule restricts the Reference datatype and the second rule restricts the types it MAY refer to:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* performer only LiteralReference
* performer only Reference(Practitioner or PractitionerRole)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">PlanDefinition.action.definition[x]</code>, nominally a choice of uri or canonical(ActivityDefinition | PlanDefinition | Questionnaire), to allow only the canonical of an ActivityDefinition:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* action.definition[x] only Canonical(ActivityDefinition)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restrict <code class="language-plaintext highlighter-rouge">PlanDefinition.action.definition[x]</code> to a canonical of either an ActivityDefinition or a PlanDefinition:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* action.definition[x] only Canonical(ActivityDefinition or PlanDefinition)
</code></pre></div>    </div>
  </li>
</ul>

<div class="tuBlock">
  <p><span class="tuIcon" title="Standards Status = Trial Use">TU</span></p>

  <ul>
    <li>
      <p>Restrict <code class="language-plaintext highlighter-rouge">MedicationRequest.reason</code>, a choice of CodeableReference(Condition | Observation), to allow only a CodeableReference to an Observation</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* reason only CodeableReference(Observation)
</code></pre></div>      </div>
    </li>
    <li>
      <p>Restrict <code class="language-plaintext highlighter-rouge">CarePlan.activity.performedActivity</code> to a CodeableReference of an Encounter or a Procedure:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* activity.performedActivity only CodeableReference(Encounter or Procedure)
</code></pre></div>      </div>
    </li>
  </ul>
</div>

<h3 id="appendix-abbreviations">Appendix: Abbreviations</h3>

<table class="grid">
  <thead>
    <tr>
      <th>Abbreviation</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ANTLR</td>
      <td>ANother Tool for Language Recognition</td>
    </tr>
    <tr>
      <td>D</td>
      <td>Flag denoting draft status</td>
    </tr>
    <tr>
      <td>FHIR</td>
      <td>Fast Healthcare Interoperability Resources</td>
    </tr>
    <tr>
      <td>FSH</td>
      <td>FHIR Shorthand</td>
    </tr>
    <tr>
      <td>IG</td>
      <td>Implementation Guide</td>
    </tr>
    <tr>
      <td>JSON</td>
      <td>JavaScript Object Notation</td>
    </tr>
    <tr>
      <td>$LNC</td>
      <td>Common FSH alias for LOINC code system (http://loinc.org)</td>
    </tr>
    <tr>
      <td>LOINC</td>
      <td>Logical Observation Identifiers Names and Codes</td>
    </tr>
    <tr>
      <td>NPI</td>
      <td>National Provider Identifier (US)</td>
    </tr>
    <tr>
      <td>N</td>
      <td>Flag denoting normative element</td>
    </tr>
    <tr>
      <td>MS</td>
      <td>Flag denoting a Must Support element</td>
    </tr>
    <tr>
      <td>OID</td>
      <td>Object Identifier</td>
    </tr>
    <tr>
      <td>$SCT</td>
      <td>Common FSH alias for SNOMED Clinical Terms</td>
    </tr>
    <tr>
      <td>SU</td>
      <td>Flag denoting "include in summary"</td>
    </tr>
    <tr>
      <td>TU</td>
      <td>Flag denoting trial use element</td>
    </tr>
    <tr>
      <td>UCUM</td>
      <td>Unified Code for Units of Measure</td>
    </tr>
    <tr>
      <td>$UCUM</td>
      <td>Common FSH alias for Unified Code for Units of Measure</td>
    </tr>
    <tr>
      <td>URL</td>
      <td>Uniform Resource Locator</td>
    </tr>
    <tr>
      <td>XML</td>
      <td>Extensible Markup Language</td>
    </tr>
  </tbody>
</table>

<h3 id="appendix-fsh-grammar-informative">Appendix: FSH Grammar (informative)</h3>

<p><a href="https://github.com/FHIR/sushi">SUSHI</a> provides an implementation of a FSH language parser described in <a href="https://www.antlr.org/">ANTLR v4</a>. It includes elements of the FSH language marked as <span class="tuIcon" title="Standards Status = Trial Use">TU</span>. The entity names defined in the grammar may not correspond to those used in the language specification. If there is a conflict between the language specification and the grammar defined in this Appendix, the language specification SHALL take precedence. This grammar implementation is provided for informational purposes and is not normative.</p>

<p>The parser grammar corresponding to this version of the specification can be found <a href="https://github.com/FHIR/sushi/tree/v3.8.0/antlr/src/main/antlr/FSH.g4">here</a> and <a href="https://github.com/FHIR/sushi/tree/v3.8.0/antlr/src/main/antlr/MiniFSH.g4">here</a>.</p>

<p>The lexer grammar corresponding to this version of the specification can be found <a href="https://github.com/FHIR/sushi/tree/v3.8.0/antlr/src/main/antlr/FSHLexer.g4">here</a> and <a href="https://github.com/FHIR/sushi/tree/v3.8.0/antlr/src/main/antlr/MiniFSHLexer.g4">here</a>.</p>




</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript" src="assets/js/window-hash.js"> </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div class="inner-wrapper">
        <p>
          IG &#169; 2020+ <a style="color:var(--footer-hyperlink-text-color)" href="http://www.hl7.org/Special/committees/fiwg">HL7 International / FHIR Infrastructure</a>.  Package hl7.fhir.uv.shorthand#3.0.0 based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Tue, May 20, 2025 19:13+0545">2025-05-20</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)">
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                
                 | <a style="color: #81BEF7" target="_blank" href="http://hl7.org/fhir/uv/shorthand/history.html">Version History</a> |
                 <a style="color: #81BEF7" rel="license" href="http://hl7.org/fhir/R4/license.html"><img style="border-style: none;" alt="CC0" src="cc0.png"/></a> |
                 <!--<a style="color: #81BEF7" href="todo.html">Search</a> | --> 
                 <a style="color: #81BEF7" target="_blank" href="http://hl7.org/fhir-issues">Propose a change</a>
          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->

  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard-btn.js"> </script>
  <script type="text/javascript" src="assets/js/anchor-hover.js"> </script>
  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

